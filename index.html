<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>每日任务清单 · 标签分组/批量/本地保存</title>
<meta name="description" content="根据当天日期显示任务，支持分组标签切换、单条与批量增删、本地存储自动保存。">
<style>
  :root{
    --bg:#0b0f14; --panel:#121821; --panel-hi:#16202b;
    --text:#eaeef3; --muted:#a8b3c1; --brand:#50a7ff;
    --ok:#34d399; --warn:#f59e0b; --danger:#ef4444; --border:#223041;
    --shadow:0 10px 30px rgba(0,0,0,.35);
    --radius:14px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:linear-gradient(180deg,#0a0e13,#0f141a 30%,#0b0f14 100%);
    color:var(--text);font:16px/1.6 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
  }
  .wrap{max-width:1080px;margin:0 auto;padding:24px}
  header{
    position:sticky;top:0;z-index:10;background:rgba(11,15,20,.9);
    backdrop-filter: blur(6px);border-bottom:1px solid var(--border);
  }
  .bar{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:14px 24px}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:32px;height:32px;border-radius:8px;background:conic-gradient(from 210deg,var(--brand),#9ae6ff,#3b82f6,#60a5fa);box-shadow:0 0 0 2px #0b0f14}
  h1{margin:0;font-size:18px;letter-spacing:.5px}
  .muted{color:var(--muted)}
  .controls{display:flex;flex-wrap:wrap;gap:8px}
  .pill{
    background:var(--panel);border:1px solid var(--border);color:var(--text);
    padding:9px 12px;border-radius:10px;cursor:pointer;transition:.2s box-shadow,.2s transform;
  }
  .pill:active{transform:translateY(1px)}
  .pill.primary{background:linear-gradient(180deg,#1b2633,#111a25);border-color:#2a3a4f}
  .pill.ok{background:#133127;border-color:#1f5a47}
  .pill.warn{background:#2b230f;border-color:#5b4b1c}
  .pill.danger{background:#301416;border-color:#5a2429}
  input[type="date"], select, input[type="text"], textarea{
    background:var(--panel);border:1px solid var(--border);color:var(--text);
    border-radius:10px;padding:9px 12px;outline:none;min-width:0;
  }
  input[type="text"]::placeholder, textarea::placeholder{color:#7f8b99}
  .toolbar{
    display:grid;gap:12px;grid-template-columns:1fr; padding:16px 24px 14px;border-bottom:1px solid var(--border);
  }
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .grow{flex:1}
  /* Tabs bar */
  .tabsbar{
    display:flex;gap:8px;align-items:center;padding:10px 16px 14px;border-bottom:1px solid var(--border);
    overflow-x:auto;scrollbar-width:thin
  }
  .tab{
    flex:0 0 auto;display:flex;align-items:center;gap:8px;
    padding:7px 12px;border-radius:999px;border:1px solid var(--border);background:var(--panel);cursor:pointer;font-size:14px;color:var(--text);
    transition:.2s transform, .2s border-color, .2s background;
  }
  .tab:hover{transform:translateY(-1px)}
  .tab.active{background:linear-gradient(180deg,#1b2633,#111a25);border-color:#2a3a4f;box-shadow:0 4px 14px rgba(0,0,0,.25)}
  .tab .count{color:var(--muted);font-variant-numeric:tabular-nums;border:1px solid var(--border);padding:0 6px;border-radius:10px;font-size:12px}
  main{padding:24px}
  .stats{display:flex;gap:16px;flex-wrap:wrap;color:var(--muted);font-size:14px;margin-top:-4px}
  .groups{display:flex;flex-direction:column;gap:16px}
  .group{
    background:var(--panel);border:1px solid var(--border);border-radius:var(--radius); box-shadow:var(--shadow)
  }
  .group header{
    position:relative;top:unset;background:unset;border:unset;backdrop-filter:none;
    display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px dashed var(--border)
  }
  .badge{padding:3px 8px;border:1px solid var(--border);border-radius:999px;color:var(--muted);font-size:12px}
  .tasks{padding:6px 6px 10px}
  .task{
    display:grid;grid-template-columns:auto 1fr auto auto;gap:10px;align-items:center;
    padding:10px;border-radius:10px;border:1px solid transparent
  }
  .task:hover{background:var(--panel-hi);border-color:var(--border)}
  .title{outline:none}
  .title.done{text-decoration:line-through;color:#7f8b99}
  .empty{
    padding:24px;border:1px dashed var(--border);border-radius:14px;color:var(--muted);text-align:center
  }
  .footnote{margin-top:18px;color:var(--muted);font-size:13px}
  .select-all{display:flex;align-items:center;gap:8px;color:var(--muted);font-size:14px}
  .divider{height:1px;background:var(--border);margin:10px 0}
  dialog{
    border:none;border-radius:16px;padding:0;max-width:720px;width:92vw;background:var(--panel);color:var(--text);
    box-shadow:var(--shadow);border:1px solid var(--border)
  }
  dialog::backdrop{background:rgba(0,0,0,.4)}
  .dlg-head{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
  .dlg-body{padding:16px}
  .dlg-actions{padding:12px 16px;border-top:1px solid var(--border);display:flex;gap:10px;justify-content:flex-end}
  .hint{font-size:13px;color:var(--muted)}
  .danger-text{color:#ff8b8b}
  .kbd{border:1px solid var(--border);border-bottom-color:#1d2a38;background:#0d131a;padding:1px 6px;border-radius:6px;font-size:12px}
  @media (max-width:640px){ .toolbar{grid-template-columns:1fr} }
</style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>每日任务清单</h1>
          <div class="muted" id="todayLabel">—</div>
        </div>
      </div>
      <div class="controls">
        <button class="pill" id="btnGroups">分组管理</button>
        <button class="pill" id="btnBatch">批量添加</button>
        <button class="pill danger" id="btnDeleteSelected">删除选中</button>
      </div>
    </div>

    <div class="toolbar">
      <div class="row">
        <label class="muted">查看日期：</label>
        <input type="date" id="datePicker" />
        <span class="badge" id="statSummary">—</span>
        <span class="select-all">
          <input type="checkbox" id="checkAll">
          <label for="checkAll">全选 / 取消（当前标签）</label>
        </span>
      </div>
      <div class="row">
        <input class="grow" type="text" id="inputTitle" placeholder="输入任务内容，回车或点右侧按钮添加…" />
        <select id="selectGroup" title="新增时的分组"></select>
        <button class="pill primary" id="btnAdd">新增任务</button>
        <button class="pill ok" id="btnClearDone">清除已完成（当前标签）</button>
      </div>
      <div class="stats" id="statsLine"></div>
    </div>

    <!-- 顶部标签栏：分组切换 -->
    <div class="tabsbar" id="tabsBar"></div>
  </header>

  <main class="wrap">
    <div id="groupsContainer" class="groups"></div>
    <div class="footnote">
      数据自动保存在本地浏览器（localStorage）。按 <span class="kbd">E</span> 快速编辑任务标题，按 <span class="kbd">Delete</span> 删除选中。切换标签=切换分组视图；“全部”显示所有分组。
    </div>
  </main>

  <!-- 批量添加 -->
  <dialog id="dlgBatch">
    <div class="dlg-head">
      <strong>批量添加任务</strong>
      <button class="pill" data-close="#dlgBatch">关闭</button>
    </div>
    <div class="dlg-body">
      <div class="hint">每行一条，支持：</div>
      <ul class="hint">
        <li><code>任务内容</code>（日期=当前选择日期；分组=下方选择或默认“未分组”）</li>
        <li><code>组名 | 任务内容</code></li>
        <li><code>YYYY-MM-DD | 组名 | 任务内容</code></li>
      </ul>
      <div class="row" style="margin-bottom:10px">
        <label class="muted">默认分组（当行未写组名时）：</label>
        <select id="batchDefaultGroup"></select>
      </div>
      <textarea id="batchText" rows="10" style="width:100%" placeholder="例：&#10;数学 | 张宇1000题 第1章 1-10题&#10;英语一 | 黄皮书阅读 真题1篇&#10;2025-12-20 | 政治 | 肖四选择题1套"></textarea>
    </div>
    <div class="dlg-actions">
      <button class="pill" data-close="#dlgBatch">取消</button>
      <button class="pill primary" id="btnBatchCommit">添加到清单</button>
    </div>
  </dialog>

  <!-- 分组管理 -->
  <dialog id="dlgGroups">
    <div class="dlg-head">
      <strong>分组管理</strong>
      <button class="pill" data-close="#dlgGroups">关闭</button>
    </div>
    <div class="dlg-body">
      <div class="row" style="margin-bottom:10px">
        <input class="grow" type="text" id="groupNewName" placeholder="输入新分组名后回车或点右侧按钮" />
        <button class="pill primary" id="btnGroupAdd">新增分组</button>
      </div>
      <div class="hint" style="margin-bottom:10px">重命名：点击名称即可编辑。删除分组会把该组任务移至“未分组”。</div>
      <div id="groupsList"></div>
    </div>
    <div class="dlg-actions">
      <button class="pill" data-close="#dlgGroups">完成</button>
    </div>
  </dialog>

<script>
(function(){
  const KEYS = { TASKS:'td_v1_tasks', GROUPS:'td_v1_groups', ACTIVE:'td_v1_activeGroup' };
  const DEFAULT_GROUP = '未分组';
  const ALL_GROUP = '全部';

  const datePicker = document.getElementById('datePicker');
  const todayLabel = document.getElementById('todayLabel');
  const inputTitle = document.getElementById('inputTitle');
  const selectGroup = document.getElementById('selectGroup');
  const btnAdd = document.getElementById('btnAdd');
  const btnClearDone = document.getElementById('btnClearDone');
  const btnDeleteSelected = document.getElementById('btnDeleteSelected');
  const checkAll = document.getElementById('checkAll');
  const statSummary = document.getElementById('statSummary');
  const statsLine = document.getElementById('statsLine');
  const groupsContainer = document.getElementById('groupsContainer');
  const tabsBar = document.getElementById('tabsBar');

  const dlgBatch = document.getElementById('dlgBatch');
  const btnBatch = document.getElementById('btnBatch');
  const batchText = document.getElementById('batchText');
  const batchDefaultGroup = document.getElementById('batchDefaultGroup');
  const btnBatchCommit = document.getElementById('btnBatchCommit');

  const dlgGroups = document.getElementById('dlgGroups');
  const btnGroups = document.getElementById('btnGroups');
  const groupNewName = document.getElementById('groupNewName');
  const groupsList = document.getElementById('groupsList');
  const btnGroupAdd = document.getElementById('btnGroupAdd');

  let selectedDate = toYMD(new Date());
  let activeGroup = localStorage.getItem(KEYS.ACTIVE) || ALL_GROUP;

  const store = {
    getTasks(){ return JSON.parse(localStorage.getItem(KEYS.TASKS) || '[]'); },
    setTasks(list){ localStorage.setItem(KEYS.TASKS, JSON.stringify(list)); },
    getGroups(){
      const g = JSON.parse(localStorage.getItem(KEYS.GROUPS) || '[]');
      if(!g.includes(DEFAULT_GROUP)) g.unshift(DEFAULT_GROUP);
      return Array.from(new Set(g));
    },
    setGroups(list){
      const uniq = Array.from(new Set(list));
      if(!uniq.includes(DEFAULT_GROUP)) uniq.unshift(DEFAULT_GROUP);
      localStorage.setItem(KEYS.GROUPS, JSON.stringify(uniq));
    },
    setActive(name){
      activeGroup = name;
      localStorage.setItem(KEYS.ACTIVE, name);
    }
  };

  function toYMD(d){
    if(typeof d === 'string') return d.slice(0,10);
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }
  function weekdayCN(dStr){
    const d = new Date(dStr);
    return ['日','一','二','三','四','五','六'][d.getDay()];
  }
  function uuid(){
    if (crypto && crypto.randomUUID) return crypto.randomUUID();
    return 'id-'+Date.now().toString(36)+'-'+Math.random().toString(36).slice(2,8);
  }
  function encodeHTML(s){ return s.replace(/"/g,'&quot;'); }
  function escapeHTML(s){ return s.replace(/[&<>]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[m])); }

  function refreshGroupSelects(){
    const groups = store.getGroups();
    const opts = groups.map(g=>`<option value="${encodeHTML(g)}"${g===activeGroup?' selected':''}>${escapeHTML(g)}</option>`).join('');
    selectGroup.innerHTML = opts;
    batchDefaultGroup.innerHTML = opts;
  }

  // ===== 顶部标签栏 =====
  function renderTabs(){
    const groups = store.getGroups();
    const tasks = store.getTasks().filter(t=>t.date===selectedDate);
    const countOf = (g)=> g===ALL_GROUP ? tasks.length : tasks.filter(t=>t.group===g).length;

    const tabs = [ALL_GROUP, ...groups];
    tabsBar.innerHTML = tabs.map(g=>{
      const c = countOf(g);
      const active = g===activeGroup ? 'active' : '';
      return `<button class="tab ${active}" data-tab="${encodeHTML(g)}">
                <span>${escapeHTML(g)}</span>
                <span class="count">${c}</span>
              </button>`;
    }).join('');

    tabsBar.querySelectorAll('.tab').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const g = btn.getAttribute('data-tab');
        store.setActive(g);
        // 切换时让“新增任务”的分组下拉默认跟随
        if(g!==ALL_GROUP) selectGroup.value = g;
        renderTabs();
        render();
      });
    });
  }

  // ===== 主渲染 =====
  function render(){
    const all = store.getTasks();
    const inDate = all.filter(t=>t.date===selectedDate);

    const filtered = activeGroup===ALL_GROUP ? inDate : inDate.filter(t=>t.group===activeGroup);
    const total = filtered.length;
    const done = filtered.filter(t=>t.done).length;

    statSummary.textContent = `当日（${activeGroup}）：完成 ${done}/${total}`;
    statsLine.innerHTML = `
      <span>全部任务：<span class="counter">${all.length}</span></span>
      <span>当前日期：<span class="counter">${selectedDate}</span></span>
      <span>分组数量：<span class="counter">${store.getGroups().length}</span></span>
      <span>未完成（当前标签）：<span class="counter">${total - done}</span></span>
    `;

    groupsContainer.innerHTML='';
    if(total===0){
      const div = document.createElement('div');
      div.className='empty';
      div.textContent = activeGroup===ALL_GROUP
        ? '今天还没有任务，试试上方“新增任务”或“批量添加”。'
        : `今天「${activeGroup}」暂时没有任务。`;
      groupsContainer.appendChild(div);
      return;
    }

    // “全部” -> 分组分块；单一标签 -> 单块
    if(activeGroup===ALL_GROUP){
      const byGroup = {};
      for(const t of inDate){
        (byGroup[t.group] ??= []).push(t);
      }
      const groupOrder = store.getGroups().filter(g=>byGroup[g]?.length).concat(
        Object.keys(byGroup).filter(g=>!store.getGroups().includes(g))
      );
      for(const gName of groupOrder){
        groupsContainer.appendChild(buildGroupSection(gName, byGroup[gName]));
      }
    }else{
      groupsContainer.appendChild(buildGroupSection(activeGroup, filtered));
    }
  }

  function buildGroupSection(gName, items){
    const section = document.createElement('section');
    section.className='group';
    section.innerHTML = `
      <header>
        <div style="display:flex;align-items:center;gap:10px">
          <strong>${escapeHTML(gName)}</strong>
          <span class="badge">共 ${items.length} 条 · 完成 ${items.filter(t=>t.done).length}</span>
        </div>
        <div class="row">
          <button class="pill" data-collapse>折叠/展开</button>
        </div>
      </header>
      <div class="tasks"></div>
    `;
    const tasksBox = section.querySelector('.tasks');

    for(const t of items.sort((a,b)=>Number(a.done)-Number(b.done) || a.createdAt-b.createdAt)){
      const div = document.createElement('div');
      div.className='task';
      div.dataset.id = t.id;
      div.innerHTML = `
        <input type="checkbox" class="sel" ${t.sel?'checked':''} title="选中用于批量操作">
        <div style="display:flex;align-items:center;gap:10px">
          <input type="checkbox" class="chk" ${t.done?'checked':''} title="完成/未完成">
          <span class="title ${t.done?'done':''}" contenteditable="false" spellcheck="false" title="双击编辑">${escapeHTML(t.title)}</span>
        </div>
        <span class="muted" style="font-size:12px">${t.group ? escapeHTML(t.group) : DEFAULT_GROUP}</span>
        <button class="pill danger btn-del" title="删除此任务">删除</button>
      `;
      tasksBox.appendChild(div);
    }
    section.querySelector('[data-collapse]').addEventListener('click', ()=>{
      tasksBox.style.display = tasksBox.style.display==='none' ? '' : 'none';
    });
    return section;
  }

  // ===== 操作函数 =====
  function addTask({title, group, date}){
    title = title?.trim();
    if(!title) return;
    const tasks = store.getTasks();
    tasks.push({
      id: uuid(), title, group: group || DEFAULT_GROUP, date: date || selectedDate,
      done:false, sel:false, createdAt: Date.now()
    });
    store.setTasks(tasks);
    renderTabs();
    render();
  }
  function deleteTask(id){
    const tasks = store.getTasks().filter(t=>t.id!==id);
    store.setTasks(tasks);
    renderTabs();
    render();
  }

  function deleteSelectedInScope(){
    const tasks = store.getTasks();
    const left = tasks.filter(t => !(t.date===selectedDate && (activeGroup===ALL_GROUP || t.group===activeGroup) && t.sel));
    const removed = tasks.length - left.length;
    if(removed===0){ alert('未选择任何任务（当前标签）。'); return; }
    if(!confirm(`确认删除选中的 ${removed} 条任务？`)) return;
    store.setTasks(left);
    renderTabs();
    render();
  }

  function clearDoneInScope(){
    const tasks = store.getTasks();
    const left = tasks.filter(t => !(t.date===selectedDate && (activeGroup===ALL_GROUP || t.group===activeGroup) && t.done));
    const removed = tasks.length - left.length;
    if(removed===0){ alert('当前标签没有已完成任务。'); return; }
    if(!confirm(`确认清除当前标签已完成的 ${removed} 条任务？`)) return;
    store.setTasks(left);
    renderTabs();
    render();
  }

  // ===== 事件绑定 =====
  datePicker.value = selectedDate;
  todayLabel.textContent = `今天：${selectedDate}（周${weekdayCN(selectedDate)}）`;

  datePicker.addEventListener('change', ()=>{
    selectedDate = datePicker.value || toYMD(new Date());
    todayLabel.textContent = `查看：${selectedDate}（周${weekdayCN(selectedDate)}）`;
    checkAll.checked = false;
    renderTabs();
    render();
  });

  // 新增
  btnAdd.addEventListener('click', ()=>{
    addTask({title: inputTitle.value, group: selectGroup.value, date: selectedDate});
    inputTitle.value='';
    inputTitle.focus();
  });
  inputTitle.addEventListener('keydown', (e)=>{
    if(e.key==='Enter'){ e.preventDefault(); btnAdd.click(); }
  });

  // 批量添加
  btnBatch.addEventListener('click', ()=>{
    refreshGroupSelects();
    // 批量默认选中当前标签（若是“全部”则回退为“未分组”）
    batchDefaultGroup.value = activeGroup===ALL_GROUP ? DEFAULT_GROUP : activeGroup;
    batchText.value='';
    dlgBatch.showModal();
  });
  btnBatchCommit.addEventListener('click', ()=>{
    const lines = batchText.value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    if(lines.length===0){ alert('请先输入内容。'); return; }
    const tasksToAdd = [];
    for(const raw of lines){
      const parts = raw.split('|').map(s=>s.trim());
      if(parts.length===1){
        tasksToAdd.push({date:selectedDate, group: batchDefaultGroup.value || DEFAULT_GROUP, title: parts[0]});
      }else if(parts.length===2){
        tasksToAdd.push({date:selectedDate, group: parts[0]||DEFAULT_GROUP, title: parts[1]});
      }else{
        const d = parts[0] || selectedDate;
        const g = parts[1] || DEFAULT_GROUP;
        const title = parts.slice(2).join(' | ').trim();
        if(!title){ continue; }
        tasksToAdd.push({date:d, group:g, title});
      }
    }
    const tasks = store.getTasks();
    const now = Date.now();
    tasksToAdd.forEach((t,i)=> tasks.push({id:uuid(), title:t.title, group:t.group, date:t.date, done:false, sel:false, createdAt:now+i}));
    store.setTasks(tasks);
    dlgBatch.close();
    renderTabs();
    render();
  });

  // 分组管理
  btnGroups.addEventListener('click', ()=>{
    renderGroupsManager();
    dlgGroups.showModal();
  });
  btnGroupAdd.addEventListener('click', ()=>{
    const name = groupNewName.value.trim();
    if(!name) return;
    const groups = store.getGroups();
    if(groups.includes(name)){ alert('已存在同名分组。'); return; }
    groups.push(name);
    store.setGroups(groups);
    groupNewName.value='';
    renderGroupsManager();
    refreshGroupSelects();
    renderTabs();
    render();
  });
  groupNewName.addEventListener('keydown', e=>{
    if(e.key==='Enter'){ e.preventDefault(); btnGroupAdd.click(); }
  });

  function renderGroupsManager(){
    const groups = store.getGroups();
    const box = document.createElement('div');
    box.style.display='flex';
    box.style.flexDirection='column';
    box.style.gap='8px';
    for(const g of groups){
      const row = document.createElement('div');
      row.className='row';
      const input = document.createElement('input');
      input.type='text'; input.value=g; input.style.flex='1';
      input.disabled = (g===DEFAULT_GROUP);
      const btnDel = document.createElement('button');
      btnDel.className='pill danger'; btnDel.textContent='删除';
      btnDel.disabled = (g===DEFAULT_GROUP);

      input.addEventListener('change', ()=>{
        const newName = input.value.trim() || g;
        const all = store.getGroups();
        if(all.includes(newName) && newName!==g){ alert('已存在同名分组。'); input.value=g; return; }
        // rename in groups
        const idx = all.indexOf(g);
        if(idx>-1){ all[idx] = newName; store.setGroups(all); }
        // rename on tasks
        const tasks = store.getTasks();
        for(const t of tasks){ if(t.group===g) t.group=newName; }
        store.setTasks(tasks);
        // 若重命名的是当前激活标签，同步更新
        if(activeGroup===g){ store.setActive(newName); }
        renderGroupsManager(); refreshGroupSelects(); renderTabs(); render();
      });

      btnDel.addEventListener('click', ()=>{
        if(!confirm(`删除分组“${g}”？该分组任务将移动到“${DEFAULT_GROUP}”。`)) return;
        const all = store.getGroups().filter(x=>x!==g);
        store.setGroups(all);
        const tasks = store.getTasks();
        for(const t of tasks){ if(t.group===g) t.group = DEFAULT_GROUP; }
        store.setTasks(tasks);
        // 若删除的是当前激活标签，回退到“全部”
        if(activeGroup===g){ store.setActive(ALL_GROUP); }
        renderGroupsManager(); refreshGroupSelects(); renderTabs(); render();
      });

      row.appendChild(input);
      row.appendChild(btnDel);
      box.appendChild(row);
    }
    groupsList.innerHTML='';
    groupsList.appendChild(box);
  }

  // 删除选中/清除完成（限定于“当前日期 + 当前标签”）
  btnDeleteSelected.addEventListener('click', deleteSelectedInScope);
  btnClearDone.addEventListener('click', clearDoneInScope);

  // 全选（限定当前标签）
  checkAll.addEventListener('change', ()=>{
    const tasks = store.getTasks();
    for(const t of tasks){
      const inScope = t.date===selectedDate && (activeGroup===ALL_GROUP || t.group===activeGroup);
      if(inScope) t.sel = checkAll.checked;
    }
    store.setTasks(tasks);
    render();
  });

  // 任务区：选择、完成、删除、编辑
  groupsContainer.addEventListener('change', (e)=>{
    const el = e.target;
    const taskEl = el.closest('.task');
    if(!taskEl) return;
    const id = taskEl.dataset.id;
    const tasks = store.getTasks();
    const t = tasks.find(x=>x.id===id);
    if(!t) return;
    if(el.classList.contains('sel')){
      t.sel = el.checked;
      store.setTasks(tasks);
    }else if(el.classList.contains('chk')){
      t.done = el.checked;
      store.setTasks(tasks);
      renderTabs();
      render();
    }
  });
  groupsContainer.addEventListener('click', (e)=>{
    const btn = e.target.closest('.btn-del');
    if(btn){
      const id = btn.closest('.task').dataset.id;
      if(confirm('确认删除该任务？')) deleteTask(id);
    }
  });
  // 双击标题编辑
  groupsContainer.addEventListener('dblclick', (e)=>{
    const titleEl = e.target.closest('.title');
    if(!titleEl) return;
    titleEl.contentEditable = 'true';
    titleEl.focus();
    document.execCommand && document.execCommand('selectAll', false, null);
  });
  groupsContainer.addEventListener('keydown', (e)=>{
    const titleEl = e.target.closest('.title');
    if(!titleEl) return;
    if(e.key==='Enter'){ e.preventDefault(); titleEl.blur(); }
    if(e.key==='Escape'){ e.preventDefault(); document.getSelection().removeAllRanges(); titleEl.blur(); }
  });
  groupsContainer.addEventListener('blur', (e)=>{
    const titleEl = e.target.closest('.title');
    if(!titleEl) return;
    titleEl.contentEditable = 'false';
    const taskEl = titleEl.closest('.task');
    const id = taskEl.dataset.id;
    const tasks = store.getTasks();
    const t = tasks.find(x=>x.id===id);
    if(!t) return;
    const txt = titleEl.textContent.trim();
    if(!txt){
      if(confirm('标题为空，将删除该任务，是否继续？')){ deleteTask(id); return; }
      titleEl.textContent = t.title; // 回滚
      return;
    }
    t.title = txt;
    store.setTasks(tasks);
    render();
  }, true);

  // 快捷键：E 编辑选中第一条；Delete 删除选中（当前标签）
  document.addEventListener('keydown', (e)=>{
    if(e.target.matches('input, textarea, [contenteditable="true"]')) return;
    if(e.key.toLowerCase()==='e'){
      const firstSel = groupsContainer.querySelector('.task .sel:checked');
      if(firstSel){
        const titleEl = firstSel.closest('.task').querySelector('.title');
        titleEl.dispatchEvent(new Event('dblclick', {bubbles:true}));
      }
    }
    if(e.key==='Delete'){
      const hasSel = store.getTasks().some(t=>t.date===selectedDate && (activeGroup===ALL_GROUP || t.group===activeGroup) && t.sel);
      if(hasSel) deleteSelectedInScope();
    }
  });

  // 初次引导
  (function bootstrap(){
    if(!localStorage.getItem(KEYS.GROUPS)){
      store.setGroups([DEFAULT_GROUP, '数学', '英语一', '政治']);
    }
    if(!localStorage.getItem(KEYS.TASKS)){
      const demo = [
        {title:'示例：点击上方标签切换分组视图', group:DEFAULT_GROUP},
        {title:'示例：双击标题可编辑内容', group:DEFAULT_GROUP},
        {title:'示例：试试上方“批量添加”', group:'数学'},
      ];
      const now = Date.now();
      const list = demo.map((d,i)=>({id:uuid(), title:d.title, group:d.group, date:selectedDate, done:false, sel:false, createdAt:now+i}));
      store.setTasks(list);
    }
    // 如果当前激活标签被删除过，回退为“全部”
    if(activeGroup!==ALL_GROUP && !store.getGroups().includes(activeGroup)) store.setActive(ALL_GROUP);

    refreshGroupSelects();
    renderTabs();
    render();
    // 切到非“全部”时，新建默认跟随当前标签
    if(activeGroup!==ALL_GROUP) selectGroup.value = activeGroup;
  })();

  // 通用：关闭对话框
  document.querySelectorAll('[data-close]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const sel = btn.getAttribute('data-close');
      const dlg = document.querySelector(sel);
      dlg && dlg.close();
    });
  });

})();
</script>
</body>
</html>
