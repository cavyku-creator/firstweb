<!DOCTYPE html>
<html lang="zh-CN" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è€ƒç ”å€’è®¡æ—¶å­¦ä¹ ç³»ç»Ÿï¼ˆ2025-08-12 â†’ 2025-12-20ï¼‰</title>
  <meta name="description" content="ä» 2025-08-12 åˆ° 2025-12-20 çš„æ—¥/å‘¨/æœˆè®¡åˆ’ä¸æ‰“å¡ç³»ç»Ÿï¼šé¢„è®¾æ—¥ç¨‹ã€é€å‘¨å¡ç‰‡ã€æœˆåº¦ç›®æ ‡ã€æœˆè§†å›¾ã€è‡ªåŠ¨ç”Ÿæˆæ•´æœŸæ—¥ç¨‹ã€å€’è®¡æ—¶ä¸ç»Ÿè®¡ã€‚å…¨éƒ¨æœ¬åœ°å­˜å‚¨ï¼Œå¯æ‰“å°å¯¼å‡ºã€‚" />
  <style>
    /* ===== Theme ===== */
    :root{
      --bg:#0b0d10; --bg-soft:#0f141a; --card:#11161c; --card-2:#0e1319; --border:#1a222d; --ring:#213043; --muted:#9fb0c2; --text:#e8eef4;
      --accent:#7ad7ff; --accent-2:#7be497; --danger:#ff6b6b; --warn:#ffd166; --ok:#8be28f; --cyan:#5eead4; --violet:#a78bfa;
      --shadow:0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.02);
    }
    [data-theme="light"]{
      --bg:#f6f8fb; --bg-soft:#f0f4f8; --card:#ffffff; --card-2:#f7fafc; --border:#e3e9f0; --ring:#d8e2ee; --muted:#65758b; --text:#0e1726;
      --accent:#0ea5e9; --accent-2:#10b981; --danger:#ef4444; --warn:#d97706; --ok:#16a34a; --cyan:#06b6d4; --violet:#7c3aed;
      --shadow:0 10px 24px rgba(2,6,23,.06), inset 0 1px 0 rgba(255,255,255,.6);
    }

    /* ===== Base ===== */
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,var(--bg) 0%, var(--bg-soft) 60%, var(--bg) 100%);color:var(--text);font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"PingFang SC","Hiragino Sans GB","Microsoft YaHei",sans-serif}
    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline}
    .wrap{max-width:1200px;margin:0 auto;padding:18px}

    header{position:sticky;top:0;z-index:50;background:rgba(0,0,0,.15);backdrop-filter:saturate(1.1) blur(10px);border-bottom:1px solid var(--border)}
    .topbar{display:flex;align-items:center;gap:14px}
    .topbar h1{margin:0;font-size:18px;font-weight:700}
    .badge{padding:4px 10px;border:1px solid var(--ring);border-radius:999px;color:var(--muted);font-size:12px}
    .spacer{flex:1}
    .toggle{appearance:none;border:1px solid var(--ring);background:var(--card);color:var(--text);padding:8px 12px;border-radius:12px;cursor:pointer}

    main{max-width:1200px;margin:20px auto;padding:0 18px 140px}
    .layout{display:grid;grid-template-columns:1.35fr .65fr;gap:18px}
    @media (max-width:1000px){.layout{grid-template-columns:1fr}}

    .card{background:linear-gradient(180deg,var(--card) 0%, var(--card-2) 100%);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow)}
    .hd{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--border)}
    .bd{padding:14px 16px}
    h2{margin:0;font-size:17px}
    .row{display:flex;flex-wrap:wrap;align-items:center;gap:10px}
    .muted{color:var(--muted)}
    .pill{border:1px solid var(--ring);border-radius:999px;padding:6px 10px;color:var(--muted);font-size:12px}
    .btn{appearance:none;border:1px solid var(--ring);background:var(--card);color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer;transition:transform .06s ease,border-color .2s ease}
    .btn:hover{transform:translateY(-1px);border-color:#2a3340}
    .btn.primary{background:linear-gradient(180deg,#0f1e2a,#0e1a24)}
    .btn.accent{background:linear-gradient(180deg,#0d2330,#0c1d2a);border-color:#1b3a4a}
    .btn.danger{background:linear-gradient(180deg,#2a1012,#220c0e);border-color:#402126;color:#ffdede}
    .btn.ghost{opacity:.85}

    .progress{height:10px;background:var(--bg-soft);border:1px solid var(--border);border-radius:999px;overflow:hidden}
    .progress>i{display:block;height:100%;background:linear-gradient(90deg,var(--accent), var(--accent-2));width:0%}

    .tasks{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px}
    @media (max-width:720px){.tasks{grid-template-columns:1fr}}
    .task{display:flex;gap:10px;padding:12px;border:1px solid var(--border);border-radius:12px;background:var(--bg-soft)}
    .task input{transform:scale(1.2);margin-top:2px}
    .task .label{flex:1}

    .aside{position:sticky;top:78px}
    .list{margin:0;padding-left:18px}
    .list li{margin:6px 0}
    .kicker{font-size:12px;color:#cfe7ff}
    .small{font-size:12px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12px;color:#9fb0c2}

    .note{background:var(--bg-soft);border:1px dashed var(--ring);border-radius:12px;padding:10px}
    .split{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media (max-width:780px){.split{grid-template-columns:1fr}}

    /* Month calendar */
    .calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
    .cal-head{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-bottom:8px}
    .cal-head div{font-size:12px;color:var(--muted);text-align:center}
    .daycell{border:1px solid var(--border);border-radius:10px;padding:6px 6px 8px;text-align:center;background:var(--card-2);cursor:pointer;min-height:64px;display:flex;flex-direction:column;justify-content:space-between}
    .daycell .date{font-size:12px;color:var(--muted)}
    .daycell .bar{height:6px;border:1px solid var(--border);border-radius:999px;background:var(--bg-soft);overflow:hidden;margin-top:6px}
    .daycell .bar i{display:block;height:100%;background:linear-gradient(90deg,var(--accent), var(--accent-2));width:0%}
    .daycell.today{outline:2px solid var(--accent)}
    .daycell.out{opacity:.35}

    /* Week cards */
    .weeklist{display:grid;gap:14px}
    .weekcard{border:1px solid rgba(114,228,139,.35);border-radius:16px;padding:14px;background:linear-gradient(180deg,var(--card) 0%, var(--card-2) 100%);box-shadow:var(--shadow)}
    .weekhead{display:flex;align-items:center;gap:10px;margin-bottom:6px}
    .weekhead .wbadge{font-weight:700}
    .weekhead .range{padding:2px 8px;border:1px solid rgba(114,228,139,.35);border-radius:999px;font-size:12px;color:var(--muted)}
    .weektitle{font-weight:700}
    .wklist{margin:8px 0 0 0;padding-left:18px}
    .wklist li{margin:6px 0}
    details.weekcard summary{cursor:pointer;list-style:none}
    details.weekcard summary::-webkit-details-marker{display:none}
    details.weekcard[open] .caret{transform:rotate(90deg)}
    .caret{transition:transform .15s ease}

    /* Month cards */
    .monthlist{display:grid;gap:14px}
    .monthcard{border:1px solid rgba(122,215,255,.35);border-radius:16px;padding:14px;background:linear-gradient(180deg,var(--card) 0%, var(--card-2) 100%);box-shadow:var(--shadow)}
    .monthhead{display:flex;align-items:center;gap:10px;margin-bottom:6px}
    .monthhead .mbadge{font-weight:700}
    .monthhead .mrange{padding:2px 8px;border:1px solid rgba(122,215,255,.35);border-radius:999px;font-size:12px;color:var(--muted)}

    /* Countdown */
    .count-wrap{display:grid;grid-template-columns:1fr .7fr;gap:18px}
    @media (max-width:980px){.count-wrap{grid-template-columns:1fr}}
    .count-num{font-size:40px;font-weight:800;letter-spacing:1px}
    .count-sub{font-size:12px;color:var(--muted)}

    /* Print */
    @media print {
      header,.hide-print{display:none!important}
      body{background:#fff;color:#000}
      main{padding:0}
      .card{box-shadow:none;border:1px solid #ddd}
      .tasks{grid-template-columns:1fr 1fr}
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="topbar">
        <h1>è€ƒç ”å€’è®¡æ—¶å­¦ä¹ ç³»ç»Ÿ</h1>
        <span class="badge">2025-08-12 â†’ 2025-12-20</span>
        <span class="badge" id="badgeCountdown">D-â€”</span>
        <span class="badge">æœ¬åœ°ä¿å­˜ Â· é¢„è®¾æ—¥ç¨‹ Â· è‡ªåŠ¨æ’ç¨‹</span>
        <div class="spacer"></div>
        <button id="themeToggle" class="toggle" aria-label="åˆ‡æ¢ä¸»é¢˜">ğŸŒ™/â˜€ï¸</button>
      </div>
    </div>
  </header>

  <main>
    <!-- å€’è®¡æ—¶ + è¿›åº¦ -->
    <section class="card" style="margin-bottom:18px">
      <div class="hd"><h2>å€’è®¡æ—¶ä¸è¿›åº¦</h2></div>
      <div class="bd count-wrap">
        <div>
          <div class="count-num" id="countdownBig">â€” å¤© â€” å°æ—¶ â€” åˆ† â€” ç§’</div>
          <div class="count-sub">è·ç¦» <b>2025-12-20</b> è€ƒç ”ï¼ˆæ•°å­¦ä¸€/è‹±ä¸€/æ”¿æ²»/882ï¼‰</div>
          <div class="row" style="margin-top:10px;gap:12px;align-items:center">
            <div class="kicker">æ—¶é—´è¿›åº¦</div>
            <div class="progress" style="flex:1;min-width:240px"><i id="timeProgress"></i></div>
            <div id="timePct" class="kicker">0%</div>
          </div>
        </div>
        <div>
          <div class="note small">æç¤ºï¼šä½ å¯ä»¥ç”¨å³ä¾§â€œæœˆè§†å›¾â€æŸ¥çœ‹ä»»æ„æ—¥æœŸçš„å®Œæˆåº¦ï¼›ç”¨â€œè‡ªåŠ¨ç”Ÿæˆæ•´æœŸæ—¥ç¨‹â€ä¸€é”®å¡«å……ä»ä»Šå¤©åˆ°è€ƒå‰çš„æ¯æ—¥é¢„è®¾ï¼ˆå‘¨æ—¥è‡ªåŠ¨ä¸ºè½»æ¢å¤æ—¥ï¼Œå¼ºåŒ–/å†²åˆºé˜¶æ®µè‡ªåŠ¨å®‰æ’æ¨¡æ‹Ÿå·ï¼‰ã€‚</div>
        </div>
      </div>
    </section>

    <div class="layout">
      <!-- Left: Today Planner -->
      <section class="card" aria-labelledby="dayTitle">
        <div class="hd">
          <div>
            <h2 id="dayTitle">ä»Šæ—¥æ‰“å¡</h2>
            <div class="row small">
              <span class="pill" id="datePill">--</span>
              <span class="pill" id="weekPill">ç¬¬1å‘¨</span>
              <span class="pill" id="hintPill">â€”</span>
              <span class="pill" id="presetPill">é¢„è®¾ï¼šâ€”</span>
            </div>
          </div>
          <div class="row hide-print">
            <button class="btn" id="btnPrev">â†</button>
            <input id="datePicker" type="date" min="2025-08-12" max="2025-12-20" />
            <button class="btn" id="btnNext">â†’</button>
            <button class="btn primary" id="btnToday">ä»Šå¤©</button>
            <button class="btn" id="btnPrint">æ‰“å°</button>
          </div>
        </div>
        <div class="bd">
          <div class="row" style="align-items:center;gap:12px;margin-bottom:10px">
            <div class="kicker">å®Œæˆåº¦</div>
            <div class="progress" style="flex:1;min-width:200px"><i id="bar"></i></div>
            <div id="percent" class="kicker">0%</div>
            <div class="spacer"></div>
            <button class="btn accent hide-print" id="btnRollover" title="å°†ä»Šæ—¥æœªå®Œæˆä»»åŠ¡ç»“è½¬åˆ°æ˜å¤©">æœªå®Œç»“è½¬â†’</button>
            <button class="btn hide-print" id="btnMarkAll">å…¨é€‰</button>
            <button class="btn hide-print" id="btnClear">æ¸…ç©º</button>
          </div>

          <div class="note small" id="adviceBox" style="margin-bottom:10px;display:none"></div>
          <div id="dayNote" class="note small" style="display:none"></div>

          <div class="row hide-print" style="gap:8px;margin:8px 0">
            <label for="presetSelect" class="small muted">æ—¥ç¨‹é¢„è®¾ï¼š</label>
            <select id="presetSelect" class="btn">
              <option value="balanced">å‡è¡¡æ—¥ï¼ˆé»˜è®¤ï¼‰</option>
              <option value="math">æ•°å­¦åŠ é‡æ—¥</option>
              <option value="major">ä¸“ä¸šè¯¾åŠ é‡æ—¥</option>
              <option value="english">è‹±è¯­å†™ä½œ/ç²¾è¯»æ—¥</option>
              <option value="light">è½»æ¢å¤æ—¥</option>
              <option value="exam">æ¨¡æ‹Ÿå·æ—¥</option>
              <option value="pre">è€ƒå‰æ—¥ï¼ˆè½»é‡+æ£€æŸ¥ï¼‰</option>
              <option value="examday">è€ƒè¯•æ—¥</option>
            </select>
            <button class="btn" id="btnApplyPreset">åº”ç”¨åˆ°å½“å¤©</button>
            <button class="btn" id="btnAddTemp">æ·»åŠ ä¸´æ—¶ä»»åŠ¡</button>
          </div>

          <div id="tasks" class="tasks" role="group" aria-label="ä»Šæ—¥ä»»åŠ¡æ¸…å•"></div>
          <div class="small muted" style="margin-top:6px">æç¤ºï¼šå‹¾é€‰è‡ªåŠ¨ä¿å­˜åˆ°æœ¬åœ°ã€‚é¢„è®¾åªå½±å“â€œè®¡åˆ†ä»»åŠ¡â€ï¼Œè‡ªå®šä¹‰ä»»åŠ¡ä¸å—å½±å“ã€‚</div>
        </div>
      </section>

      <!-- Right: Sidebar -->
      <aside class="aside">
        <section class="card" style="margin-bottom:18px">
          <div class="hd"><h2>å¿«é€Ÿè®¾ç½®</h2></div>
          <div class="bd small">
            <div class="row" style="gap:14px 16px">
              <div class="range">
                <label>æ•°å­¦æƒé‡</label>
                <input id="wMath" type="range" min="1" max="5" step="1" value="4"/>
                <span id="wMathV" class="mono">4</span>
              </div>
              <div class="range">
                <label>ä¸“ä¸šè¯¾æƒé‡</label>
                <input id="wMajor" type="range" min="1" max="5" step="1" value="4"/>
                <span id="wMajorV" class="mono">4</span>
              </div>
              <div class="range">
                <label>è‹±è¯­æƒé‡</label>
                <input id="wEng" type="range" min="1" max="5" step="1" value="3"/>
                <span id="wEngV" class="mono">3</span>
              </div>
              <div class="range">
                <label>æ”¿æ²»æƒé‡</label>
                <input id="wPol" type="range" min="1" max="5" step="1" value="2"/>
                <span id="wPolV" class="mono">2</span>
              </div>
            </div>
            <div class="row" style="gap:10px; margin-top:10px">
              <button class="btn accent" id="btnAutoPlan">è‡ªåŠ¨ç”Ÿæˆæ•´æœŸæ—¥ç¨‹</button>
              <button class="btn ghost" id="btnAutoLight">æœŸæœ«å‡è½½ï¼ˆ12/11â€“12/19ï¼‰</button>
            </div>
            <div class="note" id="priorityTip" style="margin-top:10px"></div>
          </div>
        </section>

        <section class="card" style="margin-bottom:18px">
          <div class="hd">
            <h2>æœˆè§†å›¾ï¼ˆç‚¹å‡»è·³è½¬ï¼‰</h2>
            <div class="row hide-print">
              <button class="btn" id="btnMonthPrev">â†</button>
              <span class="pill" id="monthLabel">â€”</span>
              <button class="btn" id="btnMonthNext">â†’</button>
              <button class="btn" id="btnMonthToday">æœ¬æœˆ</button>
            </div>
          </div>
          <div class="bd small">
            <div class="cal-head">
              <div>å‘¨ä¸€</div><div>å‘¨äºŒ</div><div>å‘¨ä¸‰</div><div>å‘¨å››</div><div>å‘¨äº”</div><div>å‘¨å…­</div><div>å‘¨æ—¥</div>
            </div>
            <div id="calendar" class="calendar"></div>
          </div>
        </section>

        <section class="card" style="margin-bottom:18px">
          <div class="hd"><h2>ä½œæ¯ Â· åº·å¤</h2></div>
          <div class="bd small">
            <div class="split">
              <div>
                <div class="kicker">ä½œæ¯å›ºå®š</div>
                <ul class="list">
                  <li><b>06:45</b> èµ·åºŠï½œæ¸©æ°´</li>
                  <li><b>07:30â€“07:40</b> ä»Šæ—¥ä»»åŠ¡æ’ç¨‹</li>
                  <li><b>08:00â€“10:00</b> A é«˜æ•°</li>
                  <li><b>10:10â€“11:10</b> B è‹±è¯­é•¿éš¾å¥</li>
                  <li><b>11:15â€“12:00</b> C ä¸“ä¸šç²¾è¯»</li>
                  <li><b>13:30â€“15:30</b> D ä¸“ä¸šé¢˜</li>
                  <li><b>15:40â€“16:10</b> åº·å¤è‚©</li>
                  <li><b>16:15â€“17:15</b> E æ”¿æ²»é€‰æ‹©</li>
                  <li><b>19:00â€“21:00</b> F æ•°å­¦å›ç‚‰</li>
                  <li><b>21:10â€“21:40</b> G è‹±è¯­ç²¾è¯»/å†™ä½œ</li>
                </ul>
              </div>
              <div>
                <div class="kicker">åº·å¤ï¼ˆè‚©ï¼‰</div>
                <ul class="list">
                  <li>æ™¨ï¼šèƒ¸æ¤ä¼¸å±•/å¼€ä¹¦å¼ 2Ã—10ï¼›è‚©èƒ›å‰ä¼¸/åç¼© 2Ã—12ï¼›é¢ˆæ·±å±ˆ 3Ã—10ï¼ˆåœ5sï¼‰</li>
                  <li>åˆåï¼šç­‰é•¿å¤–/å†…æ—‹ å„3Ã—12ï¼›ä¾§å§å¤–æ—‹ 3Ã—12ï¼›scaption â‰¤90Â° 2Ã—12ï¼›èƒ¸å°è‚Œæ”¾æ¾+é—¨æ¡†æ‹‰ä¼¸ 2Ã—30s</li>
                  <li class="muted">å¿Œï¼šè¿‡å¤´æ¨ä¸¾ã€çˆ†å‘ç”©è‚©ã€æç«¯å¤–å±•å¤–æ—‹ã€å€’ç«‹è´Ÿé‡ï¼›è‹¥å¤œé—´ç—›â†‘ â†’ æ¬¡æ—¥å‡é‡50%</li>
                </ul>
              </div>
            </div>
          </div>
        </section>

        <section class="card">
          <div class="hd"><h2>æ•°æ® Â· å¤‡ä»½</h2></div>
          <div class="bd small">
            <div class="row" style="gap:8px 10px">
              <button class="btn" id="btnExport">å¯¼å‡º JSON</button>
              <label class="btn" for="fileImport">å¯¼å…¥ JSON</label>
              <input id="fileImport" type="file" accept="application/json" class="hide-print" style="display:none" />
              <button class="btn danger" id="btnResetAll">é‡ç½®å…¨éƒ¨</button>
            </div>
            <div class="row" style="gap:8px 10px; margin-top:8px">
              <span class="muted">å½“å‰è¿ç»­æ‰“å¡ï¼š</span><b id="streak">0</b><span class="muted"> å¤©</span>
              <span class="muted">Â· å¹³å‡å®Œæˆåº¦ï¼š</span><b id="avg">0%</b>
            </div>
          </div>
        </section>
      </aside>
    </div>

    <!-- é€å‘¨è®¡åˆ’ï¼ˆè‡ªåŠ¨æ¸²æŸ“ï¼‰ -->
    <section class="card" style="margin-top:18px">
      <div class="hd"><h2>é€å‘¨è®¡åˆ’ï¼ˆç›´åˆ°è€ƒå‰ï¼‰</h2></div>
      <div class="bd small">
        <div class="weeklist" id="weekContainer"></div>
      </div>
    </section>

    <!-- æœˆè®¡åˆ’ï¼ˆè‡ªåŠ¨æ¸²æŸ“ï¼‰ -->
    <section class="card" style="margin-top:18px">
      <div class="hd"><h2>æœˆè®¡åˆ’ï¼ˆé˜¶æ®µç›®æ ‡ï¼‰</h2></div>
      <div class="bd small">
        <div class="monthlist" id="monthContainer"></div>
      </div>
    </section>
  </main>

  <script>
  ;(()=>{
    const DATE_START='2025-08-12';
    const EXAM_DATE='2025-12-20';
    const DATE_END=EXAM_DATE; // inclusive
    const KEY_PREFIX='studyplan_2025_0812_1220_';

    // ===== Tasks / Presets =====
    const ALL_TASKS=[
      { id:'wake',   label:'06:45èµ·åºŠã€æ™¨é—´æ´»åŠ¨å®Œæˆ' },
      { id:'onepage',label:'ä»Šæ—¥â€œä¸€é¡µçº¸è®¡åˆ’â€å·²å†™ï¼ˆ3ä¸ªæœ€é‡è¦ä»»åŠ¡ï¼‰' },
      { id:'A',      label:'å­¦ä¹ å—Aï¼šé«˜æ•°ï¼ˆ50/10Ã—2ï¼‰' },
      { id:'B',      label:'å­¦ä¹ å—Bï¼šè‹±è¯­é•¿éš¾å¥ï¼ˆ50/10ï¼‰' },
      { id:'C',      label:'å­¦ä¹ å—Cï¼šä¸“ä¸šç²¾è¯»ï¼ˆ50/10ï¼‰' },
      { id:'nap',    label:'åˆä¼‘ â‰¥ 20 åˆ†é’Ÿ' },
      { id:'D',      label:'å­¦ä¹ å—Dï¼šä¸“ä¸šé¢˜ï¼ˆ50/10Ã—2ï¼‰' },
      { id:'rehab',  label:'åº·å¤è®­ç»ƒï¼ˆä¸‹åˆæ®µï¼‰' },
      { id:'E',      label:'å­¦ä¹ å—Eï¼šæ”¿æ²»é€‰æ‹©é¢˜ï¼ˆâ‰¥30/40é¢˜ï¼‰' },
      { id:'F',      label:'å­¦ä¹ å—Fï¼šæ•°å­¦é¢˜ä¸²/é”™é¢˜å›ç‚‰ï¼ˆ50/10Ã—2ï¼‰' },
      { id:'G',      label:'å­¦ä¹ å—Gï¼šè‹±è¯­ç²¾è¯»/ç¿»è¯‘/ä½œæ–‡ï¼ˆ50/10ï¼‰' },
      { id:'review', label:'æ—¥æ¸…ï¼šé”™é¢˜ç™»è®° + æ˜æ—¥ä¸‰ä»¶äº‹' }
    ];

    const VIRTUAL={
      F2:{ id:'F2', label:'æ•°å­¦é¢å¤–å›ç‚‰ï¼ˆ50/10Ã—1ï¼‰' },
      D2:{ id:'D2', label:'ä¸“ä¸šé¢˜é¢å¤–è®­ç»ƒï¼ˆ50/10Ã—1ï¼‰' },
      B2:{ id:'B2', label:'è‹±è¯­é¢å¤–ç²¾è¯»/å†™ä½œï¼ˆ50/10Ã—1ï¼‰' },
      mock:{ id:'mock', label:'æ¨¡æ‹Ÿå°å·ï¼ˆ60â€“120minï¼‰+ å®Œæ•´å¤ç›˜' },
      lightNote:{ id:'lightNote', label:'è½»æ¢å¤ï¼šé«˜è´¨é‡ç²¾è¯» + ç®€çŸ­å¤ç›˜' },
      prechk:{ id:'prechk', label:'è€ƒå‰æ£€æŸ¥ï¼šè¯ä»¶/æ–‡å…·/è·¯çº¿/é…’åº—/åƒä½/é—¹é’Ÿ' },
      calm:{ id:'calm', label:'æ”¾æ¾ï¼šå‘¼å¸è®­ç»ƒ + 30min è½»æ¾æ•£æ­¥' },
      examdoc:{ id:'examdoc', label:'è€ƒè¯•æ—¥ï¼šè¯ä»¶ä¸‰ä»¶å¥— + å…¥åœºå‰å‘¼å¸æ”¾æ¾' },
      examlog:{ id:'examlog', label:'è€ƒåç®€çŸ­å¤ç›˜ï¼ˆâ‰¤10minï¼‰ï¼Œè¡¥å……èƒ½é‡ä¸ä¼‘æ¯' }
    };

    const PRESETS={
      balanced: {name:'å‡è¡¡æ—¥', active:['wake','onepage','A','B','C','nap','D','rehab','E','F','G','review']},
      math:     {name:'æ•°å­¦åŠ é‡æ—¥', active:['wake','onepage','A','B','C','nap','D','rehab','F','F2','G','review']},
      major:    {name:'ä¸“ä¸šè¯¾åŠ é‡æ—¥', active:['wake','onepage','A','B','C','nap','D','D2','rehab','E','G','review']},
      english:  {name:'è‹±è¯­å†™ä½œ/ç²¾è¯»æ—¥', active:['wake','onepage','A','B','B2','C','nap','D','rehab','G','G2','review']},
      light:    {name:'è½»æ¢å¤æ—¥', active:['wake','onepage','B','C','rehab','G','lightNote','review']},
      exam:     {name:'æ¨¡æ‹Ÿå·æ—¥', active:['wake','onepage','mock','rehab','review']},
      pre:      {name:'è€ƒå‰æ—¥', active:['wake','onepage','prechk','calm','review']},
      examday:  {name:'è€ƒè¯•æ—¥', active:['examdoc','calm','examlog']}
    };

    // ===== Weekly / Monthly text (auto render) =====
    // 19å‘¨æ¨¡æ¿ï¼ˆæŒ‰å‘¨åºå·è‡ªé€‚é…æ—¥æœŸèŒƒå›´ï¼‰
    const WEEK_TEXT = [
      {t:'æ‰“åº•ä¸ç»Ÿè§ˆ', M:'é«˜æ•°18è®² 1â€“4 + 660é¢˜é…å¥—', E:'é•¿éš¾å¥/è¯­æ³•æ‰“åº•ï¼›é˜…è¯»å…¥é—¨1â€“2ç« ', P:'é©¬åŸæ ¸å¿ƒ + é€‰æ‹©é¢˜ä¸€è½®', PRO:'ä¿¡å·ï¼šåˆ†ç±»ä¸ç³»ç»Ÿæ€§è´¨ï¼›æ•°ç”µï¼šé€»è¾‘ä»£æ•°/é—¨ç”µè·¯', X:'å‘¨æ—¥è½»æ¢å¤ + å‘¨æ¸…'},
      {t:'ä»£å…¥ä¸å·©å›º', M:'é«˜æ•°18è®² 5â€“8', E:'é˜…è¯»å®šä½ä¸åŒä¹‰æ›¿æ¢ï¼›ç”Ÿè¯å¡', P:'æ¯›ä¸­ç‰¹å‰åŠ + é€‰æ‹©é¢˜', PRO:'ä¿¡å·ï¼šæ—¶åŸŸè¿ç®—/å¾®åˆ†æ–¹ç¨‹ï¼›æ•°ç”µï¼šå¡è¯ºå›¾åŒ–ç®€', X:'å°æµ‹10â€“20é¢˜'},
      {t:'å·ç§¯ä¸æ‹‰æ°', M:'é«˜æ•°18è®² 9â€“12', E:'é˜…è¯»å¼ºåŒ– + å¥é—´é€»è¾‘', P:'æ¯›ä¸­ç‰¹ååŠ + é€‰æ‹©é¢˜', PRO:'ä¿¡å·ï¼šå·ç§¯/å†²æ¿€å“åº”ï¼›æ•°ç”µï¼šç»„åˆç”µè·¯åŸºç¡€', X:'é”™é¢˜æœ¬å»ºç«‹'},
      {t:'é«˜æ•°æ”¶å®˜', M:'é«˜æ•°18è®² 13â€“18', E:'ç¿»è¯‘ç»ƒä¹ èµ·æ­¥', P:'å²çº²å¼€ç¯‡ + é€‰æ‹©é¢˜', PRO:'ä¿¡å·ï¼šæ‹‰æ°å˜æ¢æ€§è´¨ï¼›æ•°ç”µï¼šç¼–ç å™¨/è¯‘ç å™¨/åŠ æ³•å™¨', X:'å‘¨æœ«å°å·ï¼ˆä¸“ä¸š20é¢˜ï¼‰'},
      {t:'çº¿ä»£èµ·æ­¥', M:'çº¿ä»£åŸºç¡€ 1â€“3 + 660é¢˜', E:'é˜…è¯»çœŸé¢˜ 2005â€“2007', P:'å²çº²ååŠ + é€‰æ‹©é¢˜', PRO:'ä¿¡å·ï¼šå‚…é‡Œå¶çº§æ•°/å˜æ¢åŸºç¡€ï¼›æ•°ç”µï¼šè§¦å‘å™¨å…¥é—¨', X:'å‘¨æ¸…ï¼šè–„å¼±ç‚¹TOP3'},
      {t:'çº¿ä»£è¿›é˜¶', M:'çº¿ä»£ 4â€“6 + 660é¢˜', E:'é˜…è¯»çœŸé¢˜ 2008â€“2010', P:'æ€ä¿®æ³•åŸº + é€‰æ‹©é¢˜', PRO:'ä¿¡å·ï¼šå‚…é‡Œå¶æ€§è´¨ä¸å¸¸è§ä¿¡å·ï¼›æ•°ç”µï¼šæ—¶åºåˆ†æä¸çŠ¶æ€æœº', X:'å‘¨æœ«å°å·ï¼ˆä¿¡å·10+æ•°ç”µ10ï¼‰'},
      {t:'æ¦‚ç»Ÿæ¢³ç†', M:'æ¦‚ç‡ç»Ÿè®¡ 1â€“2 + 660é¢˜', E:'é˜…è¯»çœŸé¢˜ 2011â€“2013', P:'èƒŒè¯µæ‰‹å†Œæ¡†æ¶å»ºç«‹', PRO:'ä¿¡å·ï¼šé‡‡æ ·/è°ƒåˆ¶åˆæ­¥ï¼›æ•°ç”µï¼šå¯„å­˜å™¨/è®¡æ•°å™¨', X:'é”™é¢˜å›ç‚‰'},
      {t:'é¢˜æ„Ÿå»ºç«‹', M:'å¼ å®‡1000é¢˜ ç»¼åˆï¼ˆä¸€ï¼‰', E:'é˜…è¯»çœŸé¢˜ 2014â€“2016', P:'é€‰æ‹©é¢˜å·©å›º + é”™é¢˜é›†', PRO:'ä¿¡å·ï¼šZ å˜æ¢ä¸ç¦»æ•£ç³»ç»Ÿï¼›æ•°ç”µï¼šMoore/Mealy è®¾è®¡', X:'å‘¨æœ«é™æ—¶å°å·'},
      {t:'ç»¼åˆè®­ç»ƒ', M:'å¼ å®‡1000é¢˜ ç»¼åˆï¼ˆäºŒï¼‰', E:'é˜…è¯»çœŸé¢˜ 2017â€“2019', P:'æ—¶æ”¿åˆè¯»', PRO:'ä¿¡å·ï¼šé¢‘åŸŸç»¼åˆå°ç»“ï¼›æ•°ç”µï¼šç»¼åˆç»ƒä¹ ', X:'å‘¨æµ‹+å¤ç›˜'},
      {t:'çœŸé¢˜ä¸€åˆ· 1', M:'çœŸé¢˜ 2009â€“2011 ä¸€åˆ·', E:'é˜…è¯»çœŸé¢˜ 2020â€“2021', P:'é€‰æ‹©é¢˜é›†ä¸€è½®', PRO:'ä¿¡å·çœŸé¢˜ï¼ˆåŸºç¡€é¢˜ï¼‰ä¸€åˆ·ï¼›æ•°ç”µçœŸé¢˜ï¼ˆç»„åˆï¼‰ä¸€åˆ·', X:'é™æ—¶/åˆ¤å·æ ‡å‡†åŒ–'},
      {t:'çœŸé¢˜ä¸€åˆ· 2', M:'çœŸé¢˜ 2012â€“2014 ä¸€åˆ·', E:'é˜…è¯»çœŸé¢˜ 2022â€“2024', P:'ä¸»è§‚é¢˜æ¡†æ¶å»ºç«‹', PRO:'ä¿¡å·çœŸé¢˜ï¼ˆè¿›é˜¶ï¼‰ä¸€åˆ·ï¼›æ•°ç”µçœŸé¢˜ï¼ˆæ—¶åºï¼‰ä¸€åˆ·', X:'é”™é¢˜åˆ†ç±»æ ‡ç­¾'},
      {t:'çœŸé¢˜ä¸€åˆ· 3', M:'çœŸé¢˜ 2015â€“2017 ä¸€åˆ·', E:'æ–°é¢˜å‹/å®Œå‹ä¸“é¡¹', P:'é€‰æ‹©é¢˜äºŒè½® + é”™é¢˜', PRO:'ä¿¡å·çœŸé¢˜ï¼ˆç»¼åˆï¼‰ä¸€åˆ·ï¼›æ•°ç”µçœŸé¢˜ï¼ˆç»¼åˆï¼‰ä¸€åˆ·', X:'æ¨¡æ‹Ÿå·æ—¥Ã—1'},
      {t:'çœŸé¢˜ä¸€åˆ· 4', M:'çœŸé¢˜ 2018â€“2020 ä¸€åˆ·', E:'ç¿»è¯‘/å†™ä½œæ¨¡æ¿å®šç¨¿', P:'ä¸»è§‚é¢˜ç´ æè¡¥å……', PRO:'ä¿¡å·/æ•°ç”µäºŒåˆ·æ˜“é”™', X:'å‘¨æœ«æ•´å·Ã—1'},
      {t:'çœŸé¢˜ä¸€åˆ· 5', M:'çœŸé¢˜ 2021â€“2024 ä¸€åˆ·', E:'å…¨çœŸå·1ï¼ˆè‹±ä¸€ï¼‰', P:'é€‰æ‹©é¢˜å·©å›º + æ—¶æ”¿', PRO:'å…¸å‹ç³»ç»Ÿåˆ†æ/å…³é”®æ³¢å½¢ä¸“é¢˜', X:'é™æ—¶æ¨¡æ‹Ÿ+å¤ç›˜'},
      {t:'å†²åˆºå· 1', M:'å¥—å·1ï¼ˆé™æ—¶ï¼‰', E:'å…¨çœŸå·2ï¼ˆè‹±ä¸€ï¼‰', P:'å…¨çœŸå·1', PRO:'å…¨å·æ¨¡æ‹Ÿ1ï¼ˆ882ï¼‰', X:'æŒ‰å¤±åˆ†æ¸…å•å›ç‚‰'},
      {t:'å†²åˆºå· 2', M:'å¥—å·2â€“3', E:'å…¨çœŸå·3', P:'å…¨çœŸå·2', PRO:'å…¨å·æ¨¡æ‹Ÿ2', X:'é”™å› é—­ç¯ï¼ˆçŸ¥è¯†/ç²—å¿ƒ/ç­–ç•¥ï¼‰'},
      {t:'æŸ¥æ¼è¡¥ç¼º', M:'å¥—å·4â€“5 + é”™é¢˜äºŒåˆ·', E:'è¯ç»„/ç¿»è¯‘é«˜é¢‘å›é¡¾', P:'å…¨çœŸå·3 + æŸ¥æ¼', PRO:'å…¨å·å›é¡¾ + æ˜“é”™æ¸…å•', X:'å»ºç«‹è€ƒå‰ A4 æ‘˜è¦'},
      {t:'å°å°æœŸÂ·ç¨³æ€', M:'å…¬å¼æ‰‹å†Œ+é”™é¢˜æ¸…å•è½»é‡å›é¡¾', E:'ä½œæ–‡æŠ¼é¢˜é»˜å†™', P:'ä¸»è§‚é¢˜æŠ¼é¢˜èƒŒè¯µä¸€è½®', PRO:'é«˜é¢‘è€ƒç‚¹è½»ç»ƒ', X:'ä½œæ¯å‰ç½®ï¼Œå‡å°‘å¼ºåº¦'},
      {t:'è€ƒå‰ä¸€å‘¨', M:'é«˜é¢‘é¢˜å‹æœ€åå›çœ‹ï¼ˆâ‰¤2h/æ—¥ï¼‰', E:'æ¨¡æ¿é»˜å†™ + ç®€çŸ­é˜…è¯»', P:'é€‰æ‹©/ä¸»è§‚é”™é¢˜å›ç‚‰', PRO:'å…¬å¼/å®šç†/æ³•åˆ™è½»é‡æµè§ˆ', X:'12/19 ä¸ºè€ƒå‰æ—¥ï¼Œå‡è½½ä¸æ£€æŸ¥'}
    ];

    const MONTH_TEXT=[
      {m:'8æœˆï¼ˆå‰©ä½™ï¼‰',r:'8/12â€“8/31',points:[
        'å»ºç«‹ä½œæ¯ä¸ç•ªèŒ„èŠ‚å¾‹ï¼›å®Œæˆã€Šé«˜æ•°18è®²ã€‹1â€“12 åŠé…å¥— 660 é¢˜ã€‚',
        'ä¿¡å·å­¦åˆ°å·ç§¯ä¸æ‹‰æ°ï¼›æ•°ç”µåˆ°ç»„åˆç”µè·¯ï¼›æ”¿æ²»ä¸è‹±è¯­å¼€å¯æŒ‰æ—¥æ¨è¿›ã€‚'
      ]},
      {m:'9æœˆ',r:'9/1â€“9/30',points:[
        'é«˜æ•°æ”¶å®˜å¹¶è½¬çº¿ä»£/æ¦‚ç»Ÿï¼›å¼ å®‡1000é¢˜èµ·é‡ã€‚',
        'ä¿¡å·è¿›å‚…é‡Œå¶ä¸é‡‡æ ·ï¼›æ•°ç”µè¿›å…¥æ—¶åºã€çŠ¶æ€æœºã€‚',
        'æ”¿æ²»å®Œæˆé€‰æ‹©é¢˜ä¸€è½®ï¼›è‹±è¯­é˜…è¯»çœŸé¢˜è¦†ç›– 2005â€“2013ã€‚'
      ]},
      {m:'10æœˆ',r:'10/1â€“10/31',points:[
        'æ•°å­¦çœŸé¢˜ä¸€åˆ·ï¼ˆ2009â€“2016ï¼‰ï¼›é”™é¢˜æœ¬æˆå‹ã€‚',
        'ä¸“ä¸šè¯¾çœŸé¢˜ä¸€åˆ·ï¼ˆæŒ‰é¢˜å‹åˆ†å—ï¼‰ã€‚',
        'è‹±è¯­é˜…è¯»çœŸé¢˜è‡³ 2021ï¼›ç¿»è¯‘ä¸å†™ä½œæ¨¡æ¿å®šç¨¿ã€‚'
      ]},
      {m:'11æœˆ',r:'11/1â€“11/30',points:[
        'è¿›å…¥æ•´å·æ¨¡æ‹Ÿä¸ç­–ç•¥ä¼˜åŒ–ï¼ˆæ¯å‘¨â‰¥2å¥—ï¼‰ã€‚',
        'æ”¿æ²»ä¸»è§‚é¢˜æ¡†æ¶+ææ–™é¢˜ç»ƒä¹ ï¼›æ—¶æ”¿æ›´æ–°ã€‚',
        'ä¸“ä¸šè¯¾å…¨å·2æ¬¡/å‘¨ï¼Œå®šä½ç¨³å®šå¤±åˆ†ç‚¹å¹¶é—­ç¯ã€‚'
      ]},
      {m:'12æœˆï¼ˆå†²åˆºï¼‰',r:'12/1â€“12/20',points:[
        'å‰10å¤©å®Œæˆå¥—å·4â€“5 ä¸é”™é¢˜äºŒåˆ·ï¼›12/11èµ·å‡è½½ç¨³æ€ã€‚',
        'å»ºç«‹ A4 æœ€ç»ˆæ‘˜è¦ï¼ˆæ•°å­¦/è‹±è¯­æ¨¡æ¿/æ”¿æ²»è¦ç‚¹/882å…¬å¼æ¸…å•ï¼‰ã€‚',
        '12/19 ä¸ºè€ƒå‰æ—¥ï¼šåªåšæ£€æŸ¥ä¸æ”¾æ¾ï¼Œä¿è¯ç¡çœ ã€‚'
      ]}
    ];

    // ===== DOM =====
    const $=s=>document.querySelector(s);
    const elTasks=$('#tasks');
    const elBar=$('#bar');
    const elPct=$('#percent');
    const elDatePill=$('#datePill');
    const elWeekPill=$('#weekPill');
    const elHintPill=$('#hintPill');
    const elPresetPill=$('#presetPill');
    const elDatePicker=$('#datePicker');
    const elDayNote=$('#dayNote');
    const elAdvice=$('#adviceBox');
    const elCalendar=$('#calendar');
    const elMonthLabel=$('#monthLabel');
    const elBadgeCountdown=$('#badgeCountdown');
    const elCountdownBig=$('#countdownBig');
    const elTimeBar=$('#timeProgress');
    const elTimePct=$('#timePct');

    // ===== Theme =====
    const themeBtn=$('#themeToggle');
    const THEME_KEY='studyplan_theme';
    function applyTheme(t){ document.documentElement.setAttribute('data-theme', t); localStorage.setItem(THEME_KEY,t); }
    themeBtn.addEventListener('click',()=>{ const cur=document.documentElement.getAttribute('data-theme')||'dark'; applyTheme(cur==='dark'?'light':'dark'); });
    applyTheme(localStorage.getItem(THEME_KEY)||'dark');

    // ===== Storage helpers =====
    function storageKey(d){return KEY_PREFIX+d}
    function emptyDay(){ return { tasks:{}, custom:[], active:[], preset:'balanced' } }
    function clampDate(d){ if(d<DATE_START) return DATE_START; if(d>DATE_END) return DATE_END; return d; }

    function loadDay(d){
      const raw=localStorage.getItem(storageKey(d));
      let data= emptyDay();
      if(raw){ try{ data=Object.assign(emptyDay(), JSON.parse(raw)); }catch(e){} }
      if(!data.active || !data.active.length){ data.active=[...PRESETS.balanced.active]; }
      if(!data.preset) data.preset='balanced';
      [...ALL_TASKS, ...Object.values(VIRTUAL)].forEach(t=>{ if(!(t.id in data.tasks)) data.tasks[t.id]=false; });
      return data;
    }
    function saveDay(d,data){ localStorage.setItem(storageKey(d), JSON.stringify(data)); }

    // ===== Date helpers =====
    const allDates = (function(){ const res=[]; const s=new Date(DATE_START), e=new Date(DATE_END); for(let d=new Date(s); d<=e; d.setDate(d.getDate()+1)) res.push(d.toISOString().slice(0,10)); return res; })();
    function fmtDate(d){ const dt=new Date(d+'T00:00:00'); const w=['å‘¨æ—¥','å‘¨ä¸€','å‘¨äºŒ','å‘¨ä¸‰','å‘¨å››','å‘¨äº”','å‘¨å…­'][dt.getDay()]; const [y,m,dd]=d.split('-'); return `${y}-${m}-${dd}ï¼ˆ${w}ï¼‰`; }
    function weekIndex(d){ const ms=(new Date(d)-new Date(DATE_START)); return Math.floor(ms/86400000/7)+1 }

    // ===== Today pane =====
    function activeTasksForDay(data){
      const base=[...ALL_TASKS];
      const extras=data.active.filter(id=>!(base.find(t=>t.id===id))).map(id=>VIRTUAL[id]).filter(Boolean);
      const map=new Map([...base, ...extras].map(t=>[t.id,t]));
      const ordered=[...ALL_TASKS.map(t=>t.id).filter(id=>data.active.includes(id)), ...data.active.filter(id=>!ALL_TASKS.find(t=>t.id===id))];
      return ordered.map(id=>map.get(id)).filter(Boolean);
    }

    function renderTasks(d){
      const data=loadDay(d);
      elPresetPill.textContent='é¢„è®¾ï¼š'+(PRESETS[data.preset]?.name||'â€”');
      renderAdvice();
      elTasks.innerHTML='';
      const frag=document.createDocumentFragment();
      const mk=(t,isCustom=false)=>{
        const item=document.createElement('label'); item.className='task'; item.dataset.id=t.id; const checked=!!data.tasks[t.id];
        item.innerHTML=`<input type="checkbox" ${checked?'checked':''} aria-label="${t.label}"><div class="label">${t.label}${isCustom?' <span class=\"muted\">ï¼ˆè‡ªå®šä¹‰ï¼‰</span>':''}</div>${isCustom?'<button class="btn small ghost" data-del>åˆ é™¤</button>':''}`;
        item.querySelector('input').addEventListener('change',e=>{ data.tasks[t.id]=e.target.checked; saveDay(d,data); updateProgress(d); renderMonth(); updateStats(); });
        if(isCustom){ item.querySelector('[data-del]')?.addEventListener('click',()=>{ if(!confirm('åˆ é™¤è¯¥è‡ªå®šä¹‰ä»»åŠ¡ï¼Ÿ')) return; data.custom=data.custom.filter(x=>x.id!==t.id); delete data.tasks[t.id]; saveDay(d,data); renderTasks(d); }); }
        frag.appendChild(item);
      };
      activeTasksForDay(data).forEach(t=> mk(t,false));
      data.custom.forEach(t=> mk(t,true));
      elTasks.appendChild(frag);
      updateProgress(d);
      elDayNote.style.display='none'; elDayNote.textContent='';
    }

    function updateProgress(d){
      const data=loadDay(d); const ids=[...data.active, ...data.custom.map(t=>t.id)];
      const total=ids.length||1; const done=ids.filter(id=>data.tasks[id]).length; const pct=Math.round(done*100/total);
      elBar.style.width=pct+'%'; elPct.textContent=pct+'%';
    }

    function setCurrentDate(d){ d=clampDate(d); window.__currentDate=d; elDatePicker.value=d; elDatePill.textContent=fmtDate(d); elWeekPill.textContent=`ç¬¬${weekIndex(d)}å‘¨`; elHintPill.textContent=(new Date(d).toDateString()===new Date().toDateString())?'ä»Šå¤©':'è®¡åˆ’å†…æ—¥æœŸ'; renderTasks(d); renderMonth(); updateStats(); }
    function todayInRange(){ const t=new Date().toISOString().slice(0,10); if(t<DATE_START||t>DATE_END) return DATE_START; return t; }

    // ===== Calendar (monthly) =====
    let currentMonth=(new Date(todayInRange())).toISOString().slice(0,7); // YYYY-MM

    function monthRange(ym){ const [y,m]=ym.split('-').map(Number); const first=new Date(y,m-1,1); const next=new Date(y,m,1); const last=new Date(next-1); return {first,last}; }
    function ymAdd(ym,delta){ let [y,m]=ym.split('-').map(Number); m+=delta; while(m>12){y++;m-=12} while(m<1){y--;m+=12} return `${y}-${String(m).padStart(2,'0')}` }

    function renderMonth(){
      const {first,last}=monthRange(currentMonth); elMonthLabel.textContent=`${currentMonth} æœˆ`;
      elCalendar.innerHTML='';
      // Monday-first alignment
      const startIdx = (first.getDay()+6)%7; // 0 for Monday
      const totalDays = last.getDate();
      const cells = [];
      // previous month placeholders
      for(let i=0;i<startIdx;i++){ cells.push(null); }
      for(let d=1; d<=totalDays; d++){ cells.push(new Date(first.getFullYear(), first.getMonth(), d)); }
      // render
      cells.forEach(dt=>{
        const div=document.createElement('div'); div.className='daycell';
        if(!dt){ div.classList.add('out'); div.innerHTML='<div class="date">Â </div><div class="bar"><i style="width:0%"></i></div>'; elCalendar.appendChild(div); return; }
        const ds=dt.toISOString().slice(0,10);
        const data=loadDay(ds); const ids=[...data.active, ...data.custom.map(t=>t.id)]; const total=ids.length||1; const done=ids.filter(id=>data.tasks[id]).length; const pct=Math.round(done*100/total);
        const isOut = (ds<DATE_START || ds>DATE_END);
        if(isOut) div.classList.add('out');
        if(ds===window.__currentDate) div.classList.add('today');
        div.innerHTML=`<div class="date">${String(dt.getDate()).padStart(2,'0')}</div><div class="bar"><i style="width:${pct}%"></i></div>`;
        if(!isOut){ div.title=`${ds} å®Œæˆåº¦ ${pct}%`; div.addEventListener('click',()=> setCurrentDate(ds)); }
        elCalendar.appendChild(div);
      });
    }

    $('#btnMonthPrev').addEventListener('click',()=>{ currentMonth=ymAdd(currentMonth,-1); renderMonth(); });
    $('#btnMonthNext').addEventListener('click',()=>{ currentMonth=ymAdd(currentMonth,1); renderMonth(); });
    $('#btnMonthToday').addEventListener('click',()=>{ currentMonth=(new Date(todayInRange())).toISOString().slice(0,7); renderMonth(); });

    // ===== Stats =====
    function updateStats(){
      // streak from current day backward where pct>=60
      let streak=0; let cur=new Date(window.__currentDate||DATE_START);
      while(true){ const d=cur.toISOString().slice(0,10); if(d<DATE_START) break; const data=loadDay(d); const ids=[...data.active, ...data.custom.map(t=>t.id)]; const total=ids.length||1; const done=ids.filter(id=>data.tasks[id]).length; const pct=done*100/total; if(pct>=60){ streak++; cur.setDate(cur.getDate()-1);} else break; }
      $('#streak').textContent=streak;
      // average
      let sum=0; allDates.forEach(d=>{ const data=loadDay(d); const ids=[...data.active, ...data.custom.map(t=>t.id)]; const total=ids.length||1; const done=ids.filter(id=>data.tasks[id]).length; sum += Math.round(done*100/total); });
      $('#avg').textContent=Math.round(sum/allDates.length)+'%';
    }

    // ===== Preset application =====
    const presetSelect=$('#presetSelect');
    function applyPresetToDate(presetName,d){ const data=loadDay(d); const preset=PRESETS[presetName]||PRESETS.balanced; data.preset=presetName; data.active=[...preset.active]; saveDay(d,data); renderTasks(d); renderMonth(); updateStats(); }
    $('#btnApplyPreset').addEventListener('click',()=> applyPresetToDate(presetSelect.value, window.__currentDate));

    // è‡ªåŠ¨ç”Ÿæˆæ•´æœŸæ—¥ç¨‹ï¼ˆåˆ†é˜¶æ®µç­–ç•¥ï¼‰
    function autoPlan(){
      const plan=[
        {s:'2025-08-12', e:'2025-09-15', map:{1:'math',2:'major',3:'balanced',4:'major',5:'balanced',6:'balanced',0:'light'}}, // åŸºç¡€
        {s:'2025-09-16', e:'2025-10-31', map:{1:'math',2:'major',3:'balanced',4:'major',5:'exam',6:'balanced',0:'light'}},     // å¼ºåŒ–ï¼ˆå‘¨äº”æ¨¡æ‹Ÿï¼‰
        {s:'2025-11-01', e:'2025-12-10', map:{1:'math',2:'major',3:'exam',4:'major',5:'exam',6:'balanced',0:'light'}},         // å†²åˆºï¼ˆå‘¨ä¸‰/å‘¨äº”æ¨¡æ‹Ÿï¼‰
        {s:'2025-12-11', e:'2025-12-19', map:{1:'light',2:'light',3:'light',4:'light',5:'pre',6:'light',0:'light'}}            // å°å°æœŸ
      ];
      allDates.forEach(d=>{
        const day=new Date(d+'T00:00:00').getDay();
        for(const ph of plan){ if(d>=ph.s && d<=ph.e){ applyPresetToDate(ph.map[day], d); break; }}
      });
      // è€ƒè¯•æ—¥
      applyPresetToDate('examday', EXAM_DATE);
      alert('å·²ä¸º 8/12â€“12/20 è‡ªåŠ¨ç”Ÿæˆæ¯æ—¥é¢„è®¾ã€‚');
    }
    $('#btnAutoPlan').addEventListener('click', autoPlan);
    $('#btnAutoLight').addEventListener('click', ()=>{
      const s='2025-12-11', e='2025-12-19';
      allDates.filter(d=> d>=s && d<=e).forEach(d=> applyPresetToDate('light', d));
      alert('å·²å¯¹ 12/11â€“12/19 åº”ç”¨ã€ŒæœŸæœ«å‡è½½ã€ã€‚');
    });

    // ===== Priority advice from weights =====
    const wMath=$('#wMath'), wMajor=$('#wMajor'), wEng=$('#wEng'), wPol=$('#wPol');
    const wMathV=$('#wMathV'), wMajorV=$('#wMajorV'), wEngV=$('#wEngV'), wPolV=$('#wPolV');
    function renderAdvice(){ const W={M:+wMath.value, J:+wMajor.value, E:+wEng.value, P:+wPol.value}; wMathV.textContent=W.M; wMajorV.textContent=W.J; wEngV.textContent=W.E; wPolV.textContent=W.P; const order=[{k:'æ•°å­¦A/F',v:W.M},{k:'ä¸“ä¸šC/D',v:W.J},{k:'è‹±è¯­B/G',v:W.E},{k:'æ”¿æ²»E',v:W.P}].sort((a,b)=>b.v-a.v).map(x=>x.k).join(' â†’ '); elAdvice.style.display='block'; elAdvice.innerHTML=`<b>ä»Šæ—¥ä¼˜å…ˆé¡ºåºï¼š</b>${order} <span class="muted">ï¼ˆæƒé‡å¯åœ¨å³ä¾§è°ƒæ•´ï¼‰</span>`; }
    [wMath,wMajor,wEng,wPol].forEach(el=> el.addEventListener('input', ()=> renderAdvice()));

    // ===== Top controls =====
    $('#btnToday').addEventListener('click',()=> setCurrentDate(todayInRange()));
    $('#btnPrev').addEventListener('click',()=>{ const cur=new Date(window.__currentDate); cur.setDate(cur.getDate()-1); setCurrentDate(cur.toISOString().slice(0,10)); });
    $('#btnNext').addEventListener('click',()=>{ const cur=new Date(window.__currentDate); cur.setDate(cur.getDate()+1); setCurrentDate(cur.toISOString().slice(0,10)); });
    $('#datePicker').addEventListener('change',e=> setCurrentDate(e.target.value||DATE_START));
    $('#btnPrint').addEventListener('click',()=> window.print());
    $('#btnMarkAll').addEventListener('click',()=>{ const d=window.__currentDate; const data=loadDay(d); [...data.active, ...data.custom.map(t=>t.id)].forEach(id=> data.tasks[id]=true); saveDay(d,data); renderTasks(d); renderMonth(); updateStats(); });
    $('#btnClear').addEventListener('click',()=>{ const d=window.__currentDate; const data=loadDay(d); [...data.active, ...data.custom.map(t=>t.id)].forEach(id=> data.tasks[id]=false); saveDay(d,data); renderTasks(d); renderMonth(); updateStats(); });

    $('#btnExport').addEventListener('click',()=>{ const all={}; allDates.forEach(d=>{ const raw=localStorage.getItem(storageKey(d)); if(raw) all[d]=JSON.parse(raw); }); const blob=new Blob([JSON.stringify(all,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='studyplan_2025_0812_1220.json'; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1000); });
    $('#fileImport').addEventListener('change',e=>{ const f=e.target.files[0]; if(!f) return; const reader=new FileReader(); reader.onload=()=>{ try{ const data=JSON.parse(reader.result); Object.keys(data||{}).forEach(d=>{ if(d>=DATE_START&&d<=DATE_END){ localStorage.setItem(storageKey(d), JSON.stringify(data[d])); }}); alert('å¯¼å…¥å®Œæˆ'); renderTasks(window.__currentDate); renderMonth(); updateStats(); }catch(err){ alert('å¯¼å…¥å¤±è´¥ï¼šæ ¼å¼é”™è¯¯'); } }; reader.readAsText(f); e.target.value=''; });
    $('#btnResetAll').addEventListener('click',()=>{ if(!confirm('æ¸…ç©º 8/12â€“12/20 æœŸé—´æ‰€æœ‰æ•°æ®ï¼Ÿ')) return; allDates.forEach(d=> localStorage.removeItem(storageKey(d))); renderTasks(window.__currentDate); renderMonth(); updateStats(); });
    $('#btnAddTemp').addEventListener('click',()=>{ const text=prompt('è¾“å…¥ä¸´æ—¶ä»»åŠ¡å†…å®¹ï¼š'); if(!text) return; const d=window.__currentDate; const data=loadDay(d); const id='custom_'+Date.now(); data.custom.push({id,label:text.trim()}); data.tasks[id]=false; saveDay(d,data); renderTasks(d); renderMonth(); updateStats(); });

    // ===== Countdown & Time progress =====
    function updateCountdown(){
      const now=new Date(); const end=new Date(EXAM_DATE+'T09:00:00'); // ä»¥è€ƒè¯•ä¸Šåˆä¸ºå‚è€ƒ
      const ms=end-now; const days=Math.max(0, Math.floor(ms/86400000)); const hours=Math.max(0, Math.floor((ms%86400000)/3600000)); const mins=Math.max(0, Math.floor((ms%3600000)/60000)); const secs=Math.max(0, Math.floor((ms%60000)/1000));
      elBadgeCountdown.textContent='D-'+days; elCountdownBig.textContent=`${days} å¤© ${String(hours).padStart(2,'0')} å°æ—¶ ${String(mins).padStart(2,'0')} åˆ† ${String(secs).padStart(2,'0')} ç§’`;
      const totalMs=new Date(EXAM_DATE+'T00:00:00')-new Date(DATE_START+'T00:00:00'); const goneMs=now - new Date(DATE_START+'T00:00:00'); const pct=Math.min(100, Math.max(0, Math.round(goneMs*100/totalMs)));
      elTimeBar.style.width=pct+'%'; elTimePct.textContent=pct+'%';
    }
    setInterval(updateCountdown,1000); updateCountdown();

    // ===== Week cards render =====
    function pad(n){return String(n).padStart(2,'0')}
    function mkRange(i){ const s=new Date(DATE_START); s.setDate(s.getDate()+i*7); const e=new Date(s); e.setDate(e.getDate()+6); const cap = e>new Date(DATE_END)? new Date(DATE_END):e; return `${pad(s.getMonth()+1)}/${pad(s.getDate())}â€“${pad(cap.getMonth()+1)}/${pad(cap.getDate())}` }
    function renderWeeks(){
      const box=$('#weekContainer'); box.innerHTML='';
      const weeks = Math.ceil((new Date(DATE_END)-new Date(DATE_START))/86400000/7)+1;
      for(let i=0;i<weeks;i++){
        const wt=WEEK_TEXT[i]||WEEK_TEXT[WEEK_TEXT.length-1];
        const det=document.createElement('details'); det.className='weekcard'; if(i<3) det.setAttribute('open','open');
        det.innerHTML=`<summary class="weekhead"><span class="caret">â–¶</span><span class="wbadge">W${i+1}</span><span class="weektitle">${mkRange(i)} Â· ${wt.t}</span><span class="range">7å¤©</span></summary>
        <ul class="wklist">
          <li><b>æ•°å­¦</b>ï¼š${wt.M}</li>
          <li><b>è‹±è¯­</b>ï¼š${wt.E}</li>
          <li><b>æ”¿æ²»</b>ï¼š${wt.P}</li>
          <li><b>ä¸“ä¸š</b>ï¼š${wt.PRO}</li>
          <li><b>æœ¬å‘¨</b>ï¼š${wt.X}</li>
        </ul>`;
        box.appendChild(det);
      }
    }

    // ===== Month cards render =====
    function renderMonths(){ const box=$('#monthContainer'); box.innerHTML=''; MONTH_TEXT.forEach((m,i)=>{ const div=document.createElement('div'); div.className='monthcard'; div.innerHTML=`<div class="monthhead"><span class="mbadge">${m.m}</span><span class="mrange">${m.r}</span></div><ul class="wklist">${m.points.map(p=>`<li>${p}</li>`).join('')}</ul>`; box.appendChild(div); }); }

    // ===== Init =====
    const initial=todayInRange(); setCurrentDate(initial); currentMonth=(new Date(initial)).toISOString().slice(0,7); renderMonth(); renderAdvice(); renderWeeks(); renderMonths();

  })();
  </script>
</body>
</html>
