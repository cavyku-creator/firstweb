<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>资料驱动｜日历打卡（8.20–12.20）</title>
<style>
  :root{
    --bg:#0b1220; --card:#111a2b; --muted:#8aa4c7; --text:#eaf2ff; --accent:#7aa2ff; --ok:#51d88a; --warn:#ffcc66; --bad:#ff6b6b; --line:#22314f;
    --shadow: 0 10px 30px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  body{margin:0; background:radial-gradient(1000px 500px at 20% -10%, #17233a, #0b1220 55%), var(--bg); color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "PingFang SC", "Noto Sans CJK SC", "Hiragino Sans GB", "Microsoft YaHei", Arial, sans-serif;}
  header{position:sticky; top:0; z-index:10; backdrop-filter:saturate(180%) blur(10px); background:linear-gradient(180deg, rgba(17,26,43,.9), rgba(17,26,43,.6)); border-bottom:1px solid #1f2a44}
  .wrap{max-width:1120px; margin:0 auto; padding:18px 20px}
  h1{margin:0 0 6px; font-size:22px}
  .sub{color:var(--muted); font-size:14px}
  .topline{display:grid; grid-template-columns: 1fr auto; gap:12px; align-items:center}
  .kpi{display:flex; gap:12px; flex-wrap:wrap}
  .kpi .card{background:var(--card); padding:10px 12px; border-radius:14px; box-shadow:var(--shadow); display:flex; gap:10px; align-items:center; border:1px solid var(--line)}
  .count{font-weight:700; font-size:18px}
  .btn{background:linear-gradient(180deg, #24385f, #1a2946); color:#cfe0ff; border:1px solid #2a3e68; padding:10px 12px; border-radius:12px; cursor:pointer}
  .btn:active{transform:translateY(1px)}
  main{display:grid; grid-template-columns: 330px 1fr; gap:18px; padding:18px 20px; max-width:1120px; margin:0 auto}
  @media (max-width: 920px){ main{grid-template-columns:1fr} }
  .panel{background:var(--card); border:1px solid var(--line); border-radius:16px; box-shadow:var(--shadow)}
  .panel h2{font-size:16px; margin:0; padding:12px 14px; border-bottom:1px solid #1f2a44; color:#d7e6ff}
  .panel .content{padding:12px 14px}
  /* Calendar */
  .cal{display:grid; gap:8px}
  .cal .nav{display:flex; justify-content:space-between; align-items:center}
  .cal .grid{display:grid; grid-template-columns: repeat(7, 1fr); gap:6px}
  .day, .wd{padding:8px; text-align:center; border-radius:10px}
  .wd{color:#8fb0ff; font-size:12px}
  .day{background:#0f182a; border:1px solid #203150; cursor:pointer; position:relative}
  .day.mute{opacity:.45}
  .day.today{outline:2px solid var(--accent)}
  .day.selected{background:linear-gradient(180deg, #1f2e4c, #18263e); border-color:#3c55a3}
  .day .mini{position:absolute; bottom:6px; left:50%; transform:translateX(-50%); height:6px; width:60%; background:#1a2946; border-radius:999px; overflow:hidden}
  .day .mini > i{display:block; height:100%; background:#3b82f6; width:0%}
  .legend{display:flex; gap:8px; flex-wrap:wrap; margin-top:6px; font-size:12px; color:#9cb5dc}
  .legend span{display:inline-flex; align-items:center; gap:6px}
  .dot{width:8px; height:8px; border-radius:50%}
  /* Tasks */
  .tasks-head{display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap}
  .tasks{display:grid; gap:10px}
  .task{display:grid; grid-template-columns: 100px 1fr auto; gap:10px; align-items:center; padding:10px; border:1px solid var(--line); background:#0f182a; border-radius:12px}
  .time{font-weight:700; color:#afc8ff}
  .title{display:flex; align-items:center; gap:10px}
  .title label{cursor:pointer}
  .tag{font-size:11px; color:#9cb5dc; padding:4px 8px; border:1px solid #2b3f69; border-radius:999px}
  .cat{font-size:11px; color:#c1d7ff; padding:2px 6px; border:1px dashed #345089; border-radius:8px}
  .tools{display:flex; gap:8px}
  .tools .btn{padding:8px 10px; font-size:12px}
  .muted{color:#9cb5dc}
  /* Custom tasks */
  .custom{display:grid; gap:8px}
  .row{display:grid; grid-template-columns:1.2fr 2fr .8fr auto; gap:8px}
  input, select, textarea{background:#0b1220; color:#dbe8ff; border:1px solid #2a3e68; padding:10px; border-radius:10px}
  textarea{min-height:70px}
  .small{font-size:12px; color:#9cb5dc}
  /* Metrics */
  .metrics{display:grid; grid-template-columns: 1fr 1fr; gap:12px}
  .metrics .box{background:#0f182a; border:1px solid var(--line); border-radius:12px; padding:10px}
  .risk{font-size:13px}
  .risk.ok{color:var(--ok)}
  .risk.warn{color:var(--warn)}
  .risk.bad{color:var(--bad)}
  .footer{padding:14px; color:#99b3db; font-size:12px; border-top:1px solid #1f2a44}
  .copy{white-space:pre-wrap; word-break:break-word; background:#0b1220; border:1px dashed #2a3e68; padding:10px; border-radius:8px}
</style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="topline">
        <div>
          <h1>资料驱动｜日历打卡</h1>
          <div class="sub">覆盖 <strong>2025-08-20</strong> 至 <strong>2025-12-20</strong> · 依据你的书目自动生成每日细化任务 · 本地离线保存</div>
        </div>
        <div class="kpi">
          <div class="card"><div>距离考试</div><div class="count" id="dCountdown">-- 天</div></div>
          <button class="btn" id="exportBtn">导出今日记录</button>
          <button class="btn" id="resetBtn">重置本日</button>
        </div>
      </div>
    </div>
  </header>

  <main>
    <!-- Left: Calendar & Metrics -->
    <section class="panel">
      <h2>📅 打卡日历</h2>
      <div class="content">
        <div class="cal">
          <div class="nav">
            <button class="btn" id="prevMonth">◀ 上月</button>
            <div class="muted" id="monthLabel">--</div>
            <button class="btn" id="nextMonth">下月 ▶</button>
          </div>
          <div class="grid" id="weekdays"></div>
          <div class="grid" id="days"></div>
          <div class="legend">
            <span><span class="dot" style="background:#3b82f6"></span> 学习日程</span>
            <span><span class="dot" style="background:#10b981"></span> 打卡完成</span>
            <span><span class="dot" style="background:#f59e0b"></span> 临近考试</span>
          </div>
        </div>
      </div>
      <h2>📈 每日效率与压力</h2>
      <div class="content">
        <div class="metrics">
          <div class="box">
            <label>效率评分（1-10）</label>
            <input type="number" id="effScore" min="1" max="10" step="1" />
            <div class="small">建议：<span id="effSuggest">—</span></div>
          </div>
          <div class="box">
            <label>压力评分（1-10）</label>
            <input type="number" id="stressScore" min="1" max="10" step="1" />
            <div class="small">建议：<span id="stressSuggest">—</span></div>
          </div>
        </div>
        <div class="risk" id="riskHint">—</div>
      </div>
      <div class="footer">提示：效率 < 7 → 次日减量 15% 并加休息；压力 > 7 → 增加20–30分钟有氧/拉伸并降低题目难度。</div>
    </section>

    <!-- Right: Tasks -->
    <section class="panel" style="overflow:hidden">
      <h2>✅ 今日任务（<span id="phaseName">—</span>）</h2>
      <div class="content">
        <div class="tasks-head">
          <div class="muted">当前日期：<strong id="currentDate">—</strong></div>
          <div class="tools">
            <button class="btn" id="checkAll">一键全选</button>
            <button class="btn" id="uncheckAll">清空勾选</button>
          </div>
        </div>
        <div class="small" style="margin:8px 0">说明：勾选、效率/压力评分、备注与自定义任务均会自动离线保存（localStorage）。</div>
        <div class="tasks" id="taskList"></div>
      </div>

      <h2>🧩 自定义任务</h2>
      <div class="content custom">
        <div class="row">
          <input id="cTime" placeholder="时间 如 20:20–21:00" />
          <input id="cTitle" placeholder="任务标题 如 英语额外阅读 / 复盘笔记" />
          <select id="cCat">
            <option value="自定义">自定义</option>
            <option value="英语">英语</option>
            <option value="数学">数学</option>
            <option value="政治">政治</option>
            <option value="专业课">专业课</option>
            <option value="运动">运动</option>
            <option value="饮食">饮食</option>
            <option value="休息">休息</option>
          </select>
          <button class="btn" id="addCustom">添加</button>
        </div>
        <div id="customList" class="tasks" style="margin-top:8px"></div>
      </div>

      <h2>📝 今日备注</h2>
      <div class="content">
        <textarea id="notes" placeholder="记录今日收获 3 条 / 错题 1-2 个 / 心态一句话"></textarea>
      </div>
    </section>
  </main>

<script>
(function(){
  // ====== 时间段 & 阶段 ======
  const EXAM_DATE = new Date('2025-12-20T00:00:00');
  const PHASES = [
    {k:'p1', name:'阶段一·高效打基础（8.20–9.30）', start:'2025-08-20', end:'2025-09-30'},
    {k:'p2', name:'阶段二·强化突破（10.1–10.31）', start:'2025-10-01', end:'2025-10-31'},
    {k:'p3', name:'阶段三·真题制胜（11.1–11.30）', start:'2025-11-01', end:'2025-11-30'},
    {k:'p4', name:'阶段四·完美收官（12.1–12.20）', start:'2025-12-01', end:'2025-12-20'},
  ];

  // ====== 工具 ======
  const $ = (s,root=document)=>root.querySelector(s);
  const $$ = (s,root=document)=>Array.from(root.querySelectorAll(s));
  const fmtDate = (d)=>d.toISOString().slice(0,10);
  const parseYMD = (s)=>{ const [y,m,day]=s.split('-').map(Number); return new Date(y,m-1,day); };
  const daysBetween = (a,b)=>Math.round((parseYMD(b)-parseYMD(a))/(1000*3600*24))+1;
  const inRange = (d, start, end)=> d>=parseYMD(start) && d<=parseYMD(end);
  const getPhase = (d)=> PHASES.find(p=>inRange(d, p.start, p.end));
  const dayIndexInPhase = (d, p)=> Math.floor((d-parseYMD(p.start))/(1000*3600*24)); // 0-based

  // ====== 书目驱动任务序列（按阶段） ======
  // —— 数学 ——
  const zhangyu30 = Array.from({length:30}, (_,i)=>`张宇《基础30讲》·第 ${i+1} 讲`);
  const zhangyu36 = Array.from({length:36}, (_,i)=>`张宇《强化36讲》·第 ${i+1} 讲`);
  const zhangyu8set = Array.from({length:8}, (_,i)=>`张宇《8套卷》·第 ${i+1} 套（全程计时）`);
  const zhangyu4set = Array.from({length:4}, (_,i)=>`张宇《4套卷》·第 ${i+1} 套（全程计时）`);
  const lyl660_la = Array.from({length:12}, (_,i)=>`李永乐《线代·基础讲义》·第 ${i+1} 讲`);
  const lylTrueImprove = Array.from({length:20}, (_,i)=>`李永乐《真题真刷·提高篇》·专题 ${i+1}`);
  const yearsMath = [2009,2010,2011,2012,2013,2014,2015,2016,2017,2018,2019,2020,2021,2022,2023,2024];

  // —— 英语 ——
  const yearsEn = Array.from({length:20}, (_,i)=>2006+i); // 2006–2025
  const enReadLogic = Array.from({length:20}, (_,i)=>`唐迟《阅读的逻辑》·第 ${i+1} 章`);
  const enJuju = Array.from({length:50}, (_,i)=>`田静《句句真研》·模块 ${i+1}（3–5句精练）`);
  const enEssayFuncs = Array.from({length:30}, (_,i)=>`石雷鹏《30个功能句》·功能句 ${i+1}`);

  // —— 专业课（交替：信号 ↔ 数电） ——
  const sigChaps = Array.from({length:12}, (_,i)=>`《信号与系统》·第 ${i+1} 章`);
  const digChaps = Array.from({length:12}, (_,i)=>`《数字电路与系统设计》·第 ${i+1} 章`);
  const sigTrue = Array.from({length:12}, (_,i)=>`信号与系统真题·套题 ${i+1}`);
  const digTrue = Array.from({length:12}, (_,i)=>`数字电路真题·套题 ${i+1}`);

  // —— 政治 ——
  const coreKaoan = Array.from({length:16}, (_,i)=>`《核心考案》·第 ${i+1} 章框架`);
  const xsr1000 = Array.from({length:16}, (_,i)=>`肖秀荣《1000题》·第 ${i+1} 章 选择题 20–30 题`);
  const xiao8 = Array.from({length:8}, (_,i)=>`《肖八》·第 ${i+1} 套（选择题+大题框架）`);
  const xiao4 = Array.from({length:4}, (_,i)=>`《肖四》·第 ${i+1} 套（背诵+选择）`);

  // 取序列项（越界时给出“复盘/巩固”）
  const pick = (arr, idx, fallback='错题巩固 / 总结复盘')=> arr[idx] || fallback;

  // ====== 阶段模板 → 生成“当日任务” ======
  function buildDayPlan(date){
    const ph = getPhase(date);
    const tasks = [];
    const idx = dayIndexInPhase(date, ph||{start:fmtDate(date)});

    const add = (t, title, cat)=> tasks.push({t, title, cat});

    // 共用：饮食/午休/运动
    const meals = {
      preBreak:'6:40–7:00',
      cardio:'7:00–7:30',
      breakfast:'7:30–8:00',
      lunch:'12:00–12:40',
      nap:'12:40–13:30',
      dinner:'18:00–18:40',
    };

    if(!ph){
      // 非计划日：保留作息与自学
      add(meals.preBreak,'早餐（香蕉/酸奶等轻食）','饮食');
      add(meals.cardio,'早起有氧（快走/慢跑/跳绳）','运动');
      add(meals.breakfast,'早餐（主食+优质蛋白）','饮食');
      add('8:30–10:30','自由复习 / 查漏补缺','复盘');
      add('10:45–12:00','错题本回顾','复盘');
      add(meals.lunch,'午餐','饮食');
      add(meals.nap,'午休 30–40 分钟','休息');
      add('14:00–17:30','自主安排（阅读/专业课/项目）','自定义');
      add(meals.dinner,'晚餐（清淡）','饮食');
      add('19:00–21:30','政治/英语巩固（任选）','自定义');
      add('21:30–22:00','当日复盘','复盘');
      return tasks;
    }

    const key = ph.k;

    if(key==='p1'){
      // —— 阶段一（基础） ——
      add(meals.preBreak,'早餐（轻食：香蕉/酸奶）','饮食');
      add(meals.cardio,'早起有氧（RPE 5–6）','运动');
      add(meals.breakfast,'早餐（全麦+鸡蛋/牛奶）','饮食');

      add('8:00–8:20', pick(coreKaoan, idx), '政治');
      add('8:20–8:30','数学预热：昨日公式速览','数学');
      add('8:30–10:30', idx<30? pick(zhangyu30, idx): pick(lyl660_la, idx-30), '数学');
      add('10:30–10:45','积极休息（拉伸+补水）','休息');
      add('10:45–12:00', idx<30? `张宇《1000题》·配套第 ${idx+1} 讲（15题）` : `李永乐《基础660》·线代模块 ${idx-29}（15题）`, '数学');

      add(meals.lunch,'午餐（七分饱）','饮食');
      add(meals.nap,'午休 30–40 分钟','休息');

      add('14:00–14:30', pick(enJuju, idx), '英语');
      add('14:30–15:00', pick(enReadLogic, idx), '英语');
      add('15:00–15:50','健身房（力量：胸/背/腿循环）','运动');

      // 专业课交替：偶数天→信号 与 系统；奇数天→数字电路
      const isSig = idx % 2 === 0;
      const chapIdx = Math.floor(idx/2);
      add('16:00–17:30', isSig? pick(sigChaps, chapIdx): pick(digChaps, chapIdx), '专业课');
      add('17:30–18:00', isSig? '《信号与系统》：课后题（10–15题）' : '《数字电路》：课后题（10–15题）', '专业课');

      add(meals.dinner,'晚餐（清淡）','饮食');
      add('19:00–20:30', pick(xsr1000, idx), '政治');
      add('20:45–21:30', `错题整理：对应 ${((idx%16)+1)} 章（建立错因→解法）`, '政治');
      add('21:30–22:00','当日复盘（收获/错题/心态）','复盘');
    }

    if(key==='p2'){
      // —— 阶段二（强化） ——
      add(meals.preBreak,'早餐（轻食）','饮食');
      add(meals.cardio,'有氧（RPE 6）','运动');
      add(meals.breakfast,'早餐（主餐）','饮食');

      add('8:00–8:30','政治背诵（故事化/关键词法）','政治');
      add('8:30–10:45', pick(zhangyu36, idx), '数学');
      add('11:00–12:00', pick(lylTrueImprove, idx), '数学');

      add(meals.lunch,'午餐','饮食');
      add(meals.nap,'午休 30–40 分钟','休息');

      // 英语真题：每天 1 年 Text1–2（或一整篇＋翻译）
      const y = yearsEn[idx % yearsEn.length];
      add('14:00–15:00', `黄皮书英一真题：${y} 年 Text 1–2（精读+翻译）`, '英语');
      add('15:00–15:50','健身房（力量+核心，40–50min）','运动');

      add('16:00–18:00', (idx%2===0)? `《信号与系统》专题复盘（卷积/频域/采样）` : `《数字电路》专题复盘（组合/时序/触发器）`, '专业课');

      add(meals.dinner,'晚餐','饮食');
      add('19:00–20:30','政治二轮刷题：1000题错题回炉 + 新题 20–30 题','政治');
      add('20:30–21:30','政治真题选择题（选项分析法）','政治');
      add('21:30–22:00','跨科复盘：错题模式横向对比','复盘');
    }

    if(key==='p3'){
      // —— 阶段三（真题制胜） ——
      add(meals.preBreak,'早餐（轻食）','饮食');
      add(meals.cardio,'有氧（轻）','运动');
      add(meals.breakfast,'早餐（主餐）','饮食');

      add('7:30–8:20', pick(enEssayFuncs, idx), '英语');
      add('8:20–8:50', `政治：${pick(xiao8, Math.floor(idx/4))}·要点背诵`, '政治');

      const yMath = yearsMath[idx % yearsMath.length];
      add('9:00–11:30', `数学真题（计时）：${yMath} 年整卷`, '数学');
      add('11:30–12:00','数学快速错题分类（详析放晚间/次日）','数学');

      add(meals.lunch,'午餐','饮食');
      add(meals.nap,'午休 30–40 分钟','休息');

      const yEn = yearsEn[(idx+8) % yearsEn.length];
      add('14:00–16:00', `英语真题套卷：${yEn} 年（完形+阅读+新题型/翻译）`, '英语');
      add('16:10–16:40','健身房（轻量+拉伸）','运动');

      const isSig = idx % 2 === 0; const tIdx = Math.floor(idx/2);
      add('17:10–18:30', isSig? pick(sigTrue, tIdx): pick(digTrue, tIdx), '专业课');

      add('18:30–19:00','晚餐','饮食');
      add('19:30–21:00','政治：肖八练习 + 大题框架书写（按答题卡）','政治');
      add('21:00–22:00','多科错题整理（横向对比）','复盘');
    }

    if(key==='p4'){
      // —— 阶段四（收官） ——
      add(meals.preBreak,'早餐（轻食）','饮食');
      add(meals.cardio,'有氧（可缩减或改散步）','运动');
      add(meals.breakfast,'早餐（主餐）','饮食');

      add('7:30–8:30', pick(xiao4, Math.floor(idx/5)), '政治');
      // 数学冲刺卷：先 8 套卷，再 4 套卷，余量用于错题/预测卷
      const mz = idx < 8 ? zhangyu8set[idx] : (idx < 12 ? zhangyu4set[idx-8] : `真题错题回顾/预测题（第 ${idx-11} 天）`);
      add('8:40–11:40', mz, '数学');

      add(meals.lunch,'午餐','饮食');
      add(meals.nap,'午休 30–40 分钟','休息');

      const yEn = yearsEn[(idx+12)%yearsEn.length];
      add('14:10–17:10', `英语冲刺卷：${yEn} 年 + 作文（模板→个性化句式）`, '英语');
      add('17:40–18:10','健身房（放松：拉伸/弹力带/呼吸）','运动');

      add('18:10–18:40','晚餐','饮食');
      add('18:40–20:10','专业课：核心考点回顾（真题高频）','专业课');
      add('20:20–22:00','政治：肖四全套练习（答题规范/字数控制）','政治');
      add('22:00–22:30','错题快速回顾（仅核心）','复盘');
    }

    return tasks;
  }

  // ====== 倒计时 ======
  function renderCountdown(){
    const now = new Date();
    const diff = Math.ceil((EXAM_DATE - now) / (1000*60*60*24));
    $('#dCountdown').textContent = diff + ' 天';
  }

  // ====== 日历 ======
  let current = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
  let selected = new Date();

  function renderWeekdays(){
    const wds = ['一','二','三','四','五','六','日'];
    const wrap = $('#weekdays'); wrap.innerHTML = '';
    wds.forEach(w=>{ const el=document.createElement('div'); el.className='wd'; el.textContent='周'+w; wrap.appendChild(el); });
  }

  function renderCalendar(){
    $('#monthLabel').textContent = `${current.getFullYear()} 年 ${current.getMonth()+1} 月`;
    const first = new Date(current.getFullYear(), current.getMonth(), 1);
    const startDay = (first.getDay()+6)%7; // Monday=0
    const daysWrap = $('#days'); daysWrap.innerHTML='';
    const daysInMonth = new Date(current.getFullYear(), current.getMonth()+1, 0).getDate();
    const totalCells = Math.ceil((startDay + daysInMonth)/7)*7;

    for(let i=0;i<totalCells;i++){
      const cell = document.createElement('div'); cell.className='day';
      const dayNum = i-startDay+1;
      const date = new Date(current.getFullYear(), current.getMonth(), dayNum);
      if(dayNum<=0 || dayNum>daysInMonth){
        cell.classList.add('mute'); cell.textContent='';
      } else {
        cell.textContent = dayNum;
        if(fmtDate(date)===fmtDate(new Date())) cell.classList.add('today');
        if(fmtDate(date)===fmtDate(selected)) cell.classList.add('selected');

        // 进度条（当日完成度）
        const mini = document.createElement('div'); mini.className='mini'; const bar = document.createElement('i'); mini.appendChild(bar); cell.appendChild(mini);
        const rate = getCompletionRate(date);
        bar.style.width = Math.round(rate*100)+'%';

        cell.addEventListener('click', ()=>{ selected = date; renderCalendar(); renderTasks(); saveMeta(); });
      }
      daysWrap.appendChild(cell);
    }
  }

  // ====== 勾选存储 ======
  function k(base, d=selected){ return `${base}:${fmtDate(d)}`; }
  function loadChecks(d=selected){ try{ return JSON.parse(localStorage.getItem(k('checks', d))||'{}'); } catch(e){ return {}; } }
  function saveChecks(obj, d=selected){ localStorage.setItem(k('checks', d), JSON.stringify(obj)); }

  // ====== 渲染任务列表 ======
  function renderTasks(){
    $('#currentDate').textContent = fmtDate(selected);
    const ph = getPhase(selected);
    $('#phaseName').textContent = ph ? ph.name : '自由复习/休整日';

    const list = $('#taskList'); list.innerHTML='';
    const checks = loadChecks();

    const tasks = buildDayPlan(selected);
    tasks.forEach((it, idx)=>{
      const row = document.createElement('div'); row.className='task';
      const id = 't'+idx;
      row.innerHTML = `
        <div class="time">${it.t}</div>
        <div class="title">
          <input type="checkbox" id="${id}" ${checks[id]? 'checked':''}>
          <label for="${id}">${it.title}</label>
          <span class="cat">${it.cat}</span>
        </div>
        <div class="tag">资料驱动</div>
      `;
      row.querySelector('input').addEventListener('change', (e)=>{
        checks[id]=e.target.checked; saveChecks(checks); renderCalendar();
      });
      list.appendChild(row);
    });

    // 自定义任务
    renderCustom();
    // 评分/备注
    loadMetrics(); loadNotes();
  }

  // 完成率
  function getCompletionRate(d){
    const tasks = buildDayPlan(d);
    const total = tasks.length + (JSON.parse(localStorage.getItem(k('custom', d))||'[]').length||0);
    const checks = loadChecks(d);
    const done = Object.values(checks).filter(Boolean).length;
    return total? Math.min(1, done/total) : 0;
  }

  // ====== 自定义任务 ======
  function loadCustom(d=selected){ try{ return JSON.parse(localStorage.getItem(k('custom', d))||'[]'); } catch(e){ return []; } }
  function saveCustom(arr, d=selected){ localStorage.setItem(k('custom', d), JSON.stringify(arr)); }
  function renderCustom(){
    const holder = $('#customList'); holder.innerHTML='';
    const arr = loadCustom();
    arr.forEach((it, i)=>{
      const id = 'c'+i; const checks = loadChecks();
      const row = document.createElement('div'); row.className='task';
      row.innerHTML = `
        <div class="time">${it.t||''}</div>
        <div class="title">
          <input type="checkbox" id="${id}" ${checks[id]? 'checked':''}>
          <label for="${id}">${it.title}</label>
          <span class="cat">${it.cat||'自定义'}</span>
        </div>
        <div class="tools">
          <button class="btn" data-act="up">↑</button>
          <button class="btn" data-act="down">↓</button>
          <button class="btn" data-act="del">删除</button>
        </div>
      `;
      row.querySelector('input').addEventListener('change', (e)=>{
        const checks = loadChecks(); checks[id]=e.target.checked; saveChecks(checks); renderCalendar();
      });
      row.querySelectorAll('button').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const act = btn.dataset.act; const list = loadCustom();
          if(act==='del'){ list.splice(i,1); }
          if(act==='up' && i>0){ const t=list[i-1]; list[i-1]=list[i]; list[i]=t; }
          if(act==='down' && i<list.length-1){ const t=list[i+1]; list[i+1]=list[i]; list[i]=t; }
          saveCustom(list); renderCustom(); renderCalendar();
        });
      });
      holder.appendChild(row);
    });
  }
  $('#addCustom').addEventListener('click', ()=>{
    const t = $('#cTime').value.trim();
    const title = $('#cTitle').value.trim();
    const cat = $('#cCat').value;
    if(!title){ alert('请输入任务标题'); return; }
    const arr = loadCustom(); arr.push({t, title, cat}); saveCustom(arr);
    $('#cTime').value=''; $('#cTitle').value=''; renderCustom(); renderCalendar();
  });

  // ====== 评分/备注 ======
  function loadMetrics(){ const m = JSON.parse(localStorage.getItem(k('metrics'))||'{}'); $('#effScore').value = m.eff||''; $('#stressScore').value = m.stress||''; updateSuggest(); }
  function saveMetrics(){ const m = { eff: Number($('#effScore').value||0), stress: Number($('#stressScore').value||0) }; localStorage.setItem(k('metrics'), JSON.stringify(m)); updateSuggest(); }
  function updateSuggest(){ const eff = Number($('#effScore').value||0); const stress = Number($('#stressScore').value||0); $('#effSuggest').textContent = eff && eff<7 ? '次日减少 15% 任务量 + 增加 30–60 分钟休息' : '维持当前节奏，错题复盘优先'; $('#stressSuggest').textContent = stress && stress>7 ? '加 20–30 分钟拉伸/有氧，降低题目难度' : '保持；睡前放松'; const hint=$('#riskHint'); if(eff && eff<7 && stress && stress>7){ hint.textContent='风险：效率低且压力高 → 建议 1 天调整期（轻量复盘+运动+早睡）'; hint.className='risk bad'; return;} if(eff && eff<7){ hint.textContent='效率偏低：适度减量 + 集中攻克单一卡点'; hint.className='risk warn'; return;} if(stress && stress>7){ hint.textContent='压力偏高：降低难度 + 增加运动/休息'; hint.className='risk warn'; return;} hint.textContent='状态良好：保持节奏，注意补水与睡眠'; hint.className='risk ok'; }
  $('#effScore').addEventListener('input', saveMetrics); $('#stressScore').addEventListener('input', saveMetrics);
  function loadNotes(){ $('#notes').value = localStorage.getItem(k('notes'))||''; } function saveNotes(){ localStorage.setItem(k('notes'), $('#notes').value); }
  $('#notes').addEventListener('input', saveNotes);

  // ====== 工具按钮 ======
  $('#checkAll').addEventListener('click', ()=>{ const checks = loadChecks(); $$('#taskList input[type="checkbox"]').forEach(el=>{ el.checked=true; checks[el.id]=true; }); $$('#customList input[type="checkbox"]').forEach(el=>{ el.checked=true; checks[el.id]=true; }); saveChecks(checks); renderCalendar(); });
  $('#uncheckAll').addEventListener('click', ()=>{ const checks = loadChecks(); $$('#taskList input[type="checkbox"]').forEach(el=>{ el.checked=false; checks[el.id]=false; }); $$('#customList input[type="checkbox"]').forEach(el=>{ el.checked=false; checks[el.id]=false; }); saveChecks(checks); renderCalendar(); });
  $('#resetBtn').addEventListener('click', ()=>{ if(!confirm('重置当前日期的所有记录（勾选/自定义/评分/笔记）？')) return; localStorage.removeItem(k('checks')); localStorage.removeItem(k('custom')); localStorage.removeItem(k('metrics')); localStorage.removeItem(k('notes')); renderTasks(); renderCalendar(); });
  $('#exportBtn').addEventListener('click', ()=>{ const data = { date: fmtDate(selected), phase: (getPhase(selected)||{}).name||'自由复习', checks: loadChecks(), custom: loadCustom(), metrics: JSON.parse(localStorage.getItem(k('metrics'))||'{}'), notes: localStorage.getItem(k('notes'))||'' }; const txt = '【日期】'+data.date+'\n【阶段】'+data.phase+'\n【完成情况】'+JSON.stringify(data.checks, null, 2)+'\n【自定义任务】'+JSON.stringify(data.custom, null, 2)+'\n【效率/压力】'+JSON.stringify(data.metrics)+'\n【备注】\n'+data.notes; navigator.clipboard.writeText(txt).then(()=>{ alert('已复制今日记录到剪贴板，可直接粘贴到微信/笔记'); }).catch(()=>{ const w = window.open('', '_blank'); w.document.write('<pre class="copy">'+txt.replace(/[&<>]/g, s=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[s]))+'</pre>'); }); });

  // ====== 元数据保存 ======
  function saveMeta(){ localStorage.setItem('lastSelectedDate', fmtDate(selected)); }

  // ====== 初始化 ======
  function init(){
    const last = localStorage.getItem('lastSelectedDate'); if(last){ selected = parseYMD(last); current = new Date(selected.getFullYear(), selected.getMonth(), 1); }
    renderCountdown(); renderWeekdays(); renderCalendar(); renderTasks();
    $('#prevMonth').addEventListener('click', ()=>{ current = new Date(current.getFullYear(), current.getMonth()-1, 1); renderCalendar(); });
    $('#nextMonth').addEventListener('click', ()=>{ current = new Date(current.getFullYear(), current.getMonth()+1, 1); renderCalendar(); });
    setInterval(renderCountdown, 60*1000);
  }
  init();
})();
</script>
</body>
</html>
