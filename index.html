<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è€ƒç ”å­¦ä¹ å·¥ä½œå° Â· å¢å¼ºç‰ˆ v2</title>
  <meta name="description" content="åŠŸèƒ½å…¨é¢çš„è€ƒç ”å­¦ä¹ å·¥ä½œå°ï¼šå¾…åŠã€ç•ªèŒ„é’Ÿã€å€’è®¡æ—¶ã€æ‰“å¡æ—¥å†ã€è¯æ±‡å¡ç‰‡ã€ç¬”è®°ã€ç»Ÿè®¡ã€é˜¶æ®µå‘¨è®¡åˆ’ã€æ—¶é—´è§„åˆ’è¡¨ã€å­¦ä¹ ç›®æ ‡è·Ÿè¸ªã€é”™é¢˜æœ¬ã€æ¨¡è€ƒç®¡ç†ã€å­¦ä¹ åˆ†æç­‰ã€‚" />
  <style>
    :root{
      --bg: #0b0f14;
      --panel: #121821;
      --panel-hi: #16202b;
      --text: #eaeef3;
      --muted: #a8b3c1;
      --brand: #50a7ff;
      --ok: #34d399;
      --warn: #f59e0b;
      --danger: #ef4444;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius-lg: 16px;
      --radius-md: 12px;
      --radius-sm: 8px;
      --gap: 14px;
      --font: system-ui, -apple-system, Segoe UI, Roboto, PingFang SC, Microsoft YaHei, Helvetica, Arial, sans-serif;
    }
    [data-theme="light"]{
      --bg: #f6f8fb;
      --panel: #ffffff;
      --panel-hi: #f0f3f7;
      --text: #0f1621;
      --muted: #66707b;
      --brand: #2b78ff;
      --shadow: 0 10px 24px rgba(0,0,0,.08);
    }
    *{box-sizing: border-box}
    html,body{height:100%}
    body{
      margin:0; background: radial-gradient(1200px 800px at 10% 0%, rgba(80,167,255,.10), transparent 60%),
      radial-gradient(1000px 600px at 100% 20%, rgba(52,211,153,.10), transparent 60%), var(--bg);
      color:var(--text); font-family:var(--font); line-height:1.5; overflow-y:overlay;
    }
    header{
      position:sticky; top:0; z-index:5; backdrop-filter:saturate(130%) blur(8px);
      background:linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,0)), var(--panel);
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .topbar{max-width:1200px; margin:0 auto; padding:10px 16px; display:flex; gap:10px; align-items:center}
    .title{display:flex; align-items:center; gap:10px; font-weight:700; letter-spacing:.3px}
    .title .logo{width:28px; height:28px; border-radius:8px; background:linear-gradient(135deg, var(--brand), #34d399); box-shadow:var(--shadow)}
    .grow{flex:1}
    .btn{appearance:none; border:none; padding:9px 12px; border-radius:10px; background:var(--panel-hi); color:var(--text); cursor:pointer; box-shadow:var(--shadow);
      transition:transform .05s ease, background .2s ease, opacity .2s ease}
    .btn:hover{transform:translateY(-1px)}
    .btn:active{transform:translateY(0)}
    .btn.icon{padding:8px; display:inline-grid; place-items:center}
    .btn.primary{background:linear-gradient(135deg, var(--brand), #7cc2ff)}
    .btn.ghost{background:transparent; border:1px solid rgba(255,255,255,.12)}
    .btn.danger{background:linear-gradient(135deg, var(--danger), #ff8a8a)}
    .btn.success{background:linear-gradient(135deg, var(--ok), #90e6c2)}
    .badge{display:inline-block; padding:2px 8px; border-radius:999px; background:var(--panel-hi); font-size:12px; color:var(--muted)}
    main{max-width:1200px; margin:18px auto 40px; padding:0 16px;}
    .grid{display:grid; grid-template-columns: 330px 1fr; gap:var(--gap)}
    @media (max-width: 980px){.grid{grid-template-columns:1fr}}
    .panel{background:var(--panel); border:1px solid rgba(255,255,255,.10); border-radius:var(--radius-lg); box-shadow:var(--shadow)}
    .panel .hd{display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid rgba(255,255,255,.10)}
    .panel .bd{padding:14px}
    .muted{color:var(--muted)}
    .kpi{display:grid; grid-template-columns:repeat(3,1fr); gap:10px}
    .kpi .card{padding:12px; background:var(--panel-hi); border-radius:12px; text-align:center}
    .kpi .num{font-size:22px; font-weight:700}

    /* Countdown & Pomodoro */
    .countdown{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .countdown .box{padding:10px; background:var(--panel-hi); border-radius:12px}
    .countdown .big{font-size:28px; font-weight:800}

    .pomodoro{display:grid; gap:10px}
    .pomodoro .screen{display:grid; place-items:center; padding:18px; background:var(--panel-hi); border-radius:12px; font-variant-numeric: tabular-nums;}
    .pomodoro .time{font-size:42px; font-weight:800}
    .pomodoro .modes{display:flex; gap:6px; flex-wrap:wrap; justify-content:center}
    .pomodoro .modes .btn{border-radius:999px; padding:6px 10px}
    .row{display:flex; gap:6px; flex-wrap:wrap; align-items:center}

    /* TODO */
    .todo-header{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
    .pill{border-radius:999px; padding:6px 10px; background:var(--panel-hi); cursor:pointer; user-select:none}
    .pill.active{outline:2px solid var(--brand)}
    .todo-inputs{display:grid; grid-template-columns:1.6fr .9fr .9fr .6fr auto; gap:8px; margin-top:10px}
    @media (max-width:900px){.todo-inputs{grid-template-columns:1.5fr .9fr .9fr .7fr}}
    @media (max-width:640px){.todo-inputs{grid-template-columns:1fr}}
    input, select, textarea{width:100%; background:var(--panel-hi); color:var(--text); border:1px solid rgba(255,255,255,.12); border-radius:10px; padding:10px; outline:none}
    input::placeholder, textarea::placeholder{color:rgba(168,179,193,.7)}

    .task{display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:10px; padding:10px; border-radius:12px; border:1px dashed rgba(255,255,255,.16); margin-bottom:8px; background:linear-gradient(0deg, rgba(22,32,43,.7), transparent)}
    .task.dragging{opacity:.6}
    .task .title{font-weight:600}
    .task .meta{font-size:12px; color:var(--muted)}
    .task .tag{font-size:12px; padding:3px 8px; border-radius:999px; background:rgba(80,167,255,.20); margin-left:6px}
    .task.done{opacity:.6; text-decoration:line-through}

    /* Calendar */
    .calendar{display:grid; grid-template-columns: repeat(7, 1fr); gap:6px}
    .day{aspect-ratio:1/1; border-radius:10px; background:var(--panel-hi); display:flex; flex-direction:column; padding:6px; cursor:pointer; position:relative}
    .day .d{font-size:12px; color:var(--muted)}
    .day .dot{width:8px; height:8px; border-radius:50%; position:absolute; right:6px; bottom:6px; background:var(--muted)}
    .day.good .dot{background:var(--ok)}
    .day.bad .dot{background:var(--danger)}
    .dow{font-size:12px; color:var(--muted); text-align:center; margin-bottom:6px}

    /* Notes */
    .toolbar{display:flex; gap:6px; flex-wrap:wrap; margin-bottom:8px}
    .editor{min-height:180px; padding:12px; border-radius:12px; background:var(--panel-hi); outline:none}

    /* Vocab */
    .vocab{display:grid; gap:8px}
    .card{border-radius:12px; padding:16px; background:var(--panel-hi); text-align:center}
    .card .word{font-size:26px; font-weight:800}
    .card .mean{margin-top:6px; color:var(--muted)}

    /* Stats */
    .stats-grid{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media (max-width:900px){.stats-grid{grid-template-columns:1fr}}
    canvas{width:100%; height:220px}

    /* å‘¨è®¡åˆ’ & æ—¶é—´è§„åˆ’è¡¨ */
    .wk-list{margin:0; padding-left:18px}
    .wk-list li{margin:6px 0}
    .tt-row{display:grid; grid-template-columns:120px 1fr; gap:10px; padding:10px; border-radius:12px;
      background:var(--panel-hi); border:1px dashed rgba(255,255,255,.16); margin-bottom:8px}
    .tt-time{font-weight:700; color:var(--muted)}

    /* NEW: Learning Goals */
    .goals-grid{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:10px}
    .goal-item{padding:10px; background:var(--panel-hi); border-radius:12px; border:1px solid rgba(255,255,255,.12)}
    .goal-progress{width:100%; height:6px; background:rgba(255,255,255,.1); border-radius:3px; margin-top:6px}
    .goal-progress .bar{height:100%; background:linear-gradient(135deg, var(--brand), var(--ok)); border-radius:3px; transition:width .3s ease}

    /* NEW: Mock Exam */
    .exam-item{padding:12px; background:var(--panel-hi); border-radius:12px; margin-bottom:8px; border:1px solid rgba(255,255,255,.12)}
    .exam-score{font-size:18px; font-weight:700; color:var(--brand)}

    /* NEW: Error Book */
    .error-item{padding:12px; background:var(--panel-hi); border-radius:12px; margin-bottom:8px; border-left:4px solid var(--danger)}
    .error-content{margin-top:6px; font-family:monospace; background:rgba(0,0,0,.3); padding:8px; border-radius:6px}

    /* NEW: Quick Actions */
    .quick-actions{display:grid; grid-template-columns:repeat(auto-fit, minmax(120px, 1fr)); gap:8px; margin-bottom:12px}
    .quick-btn{padding:12px; background:var(--panel-hi); border:none; border-radius:12px; cursor:pointer; transition:all .2s ease; color:var(--text); text-align:center}
    .quick-btn:hover{transform:translateY(-2px); box-shadow:var(--shadow)}

    /* NEW: Focus Mode */
    .focus-mode{position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,.95); z-index:1000; display:none; align-items:center; justify-content:center; flex-direction:column}
    .focus-screen{text-align:center; color:var(--text)}
    .focus-time{font-size:72px; font-weight:800; margin-bottom:20px; font-variant-numeric: tabular-nums}
    .focus-controls{display:flex; gap:20px}

    /* Tabs */
    .tabs{display:flex; gap:2px; margin-bottom:12px; background:var(--panel-hi); border-radius:12px; padding:4px}
    .tab{padding:8px 16px; border-radius:8px; cursor:pointer; transition:all .2s ease; background:transparent; border:none; color:var(--muted)}
    .tab.active{background:var(--brand); color:white}
    .tab-content{display:none}
    .tab-content.active{display:block}

    /* Motivational */
    .motivation{text-align:center; padding:20px; background:linear-gradient(135deg, var(--brand), var(--ok)); border-radius:12px; margin-bottom:14px; color:white}
    .motivation-text{font-size:18px; font-weight:600; margin-bottom:8px}
    .motivation-sub{opacity:.9; font-size:14px}

    /* Floating Action Button */
    .fab{position:fixed; bottom:20px; right:20px; width:56px; height:56px; border-radius:50%; background:linear-gradient(135deg, var(--brand), var(--ok)); border:none; color:white; font-size:24px; cursor:pointer; box-shadow:var(--shadow); z-index:100; display:grid; place-items:center; transition:transform .2s ease}
    .fab:hover{transform:scale(1.1)}

    @media print{
      header, .no-print, .fab{display:none !important}
      body{background:#fff}
      .panel{box-shadow:none}
    }
  </style>
</head>
<body>
  <!-- Focus Mode Overlay -->
  <div id="focusOverlay" class="focus-mode">
    <div class="focus-screen">
      <div class="focus-time" id="focusTime">25:00</div>
      <div class="muted" id="focusStatusText">ä¸“æ³¨æ¨¡å¼</div>
      <div class="focus-controls">
        <button class="btn" id="exitFocus">é€€å‡ºä¸“æ³¨</button>
        <button class="btn ghost" id="pauseFocus">æš‚åœ</button>
      </div>
    </div>
  </div>

  <header>
    <div class="topbar">
      <div class="title">
        <div class="logo"></div>
        <div>
          <div>è€ƒç ”å­¦ä¹ å·¥ä½œå° Â· å¢å¼ºç‰ˆ</div>
          <div class="muted" style="font-size:12px">åŠŸèƒ½å…¨é¢ Â· æ™ºèƒ½åˆ†æ Â· é«˜æ•ˆå­¦ä¹ </div>
        </div>
      </div>
      <div class="grow"></div>
      <span id="now" class="badge">--:--</span>
      <button id="themeBtn" class="btn icon" title="åˆ‡æ¢ä¸»é¢˜">ğŸŒ“</button>
      <button id="focusBtn" class="btn primary" title="è¿›å…¥ä¸“æ³¨æ¨¡å¼">ğŸ¯ ä¸“æ³¨</button>
    </div>
  </header>

  <main>
    <!-- Motivational Banner -->
    <div class="motivation">
      <div class="motivation-text" id="motivationText">æ¯ä¸€åˆ†åŠªåŠ›éƒ½åœ¨ä¸ºæ¢¦æƒ³é“ºè·¯</div>
      <div class="motivation-sub" id="motivationSub">è·ç¦»è€ƒç ”è¿˜æœ‰ -- å¤©ï¼Œä»Šå¤©ä¹Ÿè¦å…¨åŠ›ä»¥èµ´ï¼</div>
    </div>

    <!-- Quick Actions -->
    <div class="panel no-print">
      <div class="hd"><strong>å¿«æ·æ“ä½œ</strong>
        <div class="row">
          <button class="btn ghost" id="backupBtn">å¤‡ä»½</button>
          <button class="btn ghost" id="restoreBtn">è¿˜åŸ</button>
          <button class="btn danger" id="resetAllBtn">æ¸…ç©ºæœ¬åœ°</button>
          <input type="file" id="restoreFile" accept="application/json" hidden />
        </div>
      </div>
      <div class="bd">
        <div class="quick-actions">
          <button class="quick-btn" id="quickMath">ğŸ“ æ•°å­¦ä¸€åˆ·é¢˜</button>
          <button class="quick-btn" id="quickEng">ğŸ“š è‹±è¯­ä¸€é˜…è¯»</button>
          <button class="quick-btn" id="quickPol">ğŸ“ æ”¿æ²»èƒŒè¯µ</button>
          <button class="quick-btn" id="quickSig">âš¡ ä¿¡å·ä¸ç³»ç»Ÿ</button>
          <button class="quick-btn" id="quickDig">ğŸ”§ æ•°å­—ç”µè·¯</button>
          <button class="quick-btn" id="quickVocab">ğŸ“ èƒŒå•è¯</button>
          <button class="quick-btn" id="quickReview">ğŸ”„ é”™é¢˜å¤ä¹ </button>
        </div>
      </div>
    </div>

    <div class="grid">
      <!-- å·¦ä¾§ï¼šå€’è®¡æ—¶ + ç•ªèŒ„é’Ÿ + ä»Šæ—¥æŒ‡æ ‡ -->
      <div class="panel">
        <div class="hd"><strong>å€’è®¡æ—¶ä¸ç•ªèŒ„é’Ÿ</strong>
          <div class="row">
            <label class="badge" for="examDate">åˆè¯•æ—¥æœŸ</label>
            <input type="date" id="examDate"/>
          </div>
        </div>
        <div class="bd">
          <div class="countdown">
            <div class="box">
              <div class="muted">è·ç¦»åˆè¯•</div>
              <div class="big" id="dLeft">--</div>
              <div class="muted">å¤©</div>
            </div>
            <div class="box">
              <div class="muted">ä»Šæ—¥ç›®æ ‡</div>
              <div class="row" style="align-items:center; margin-top:6px">
                <input type="number" id="goalMin" min="10" step="5" value="180"/>
                <span class="muted">åˆ†é’Ÿ</span>
                <span class="badge" id="goalHit">æœªè¾¾æˆ</span>
              </div>
              <div class="muted" id="todayProgress" style="margin-top:6px">ä»Šæ—¥ä¸“æ³¨ 0 åˆ†é’Ÿ</div>
            </div>
          </div>

          <div class="pomodoro">
            <div class="modes">
              <button class="btn pill" data-mode="work">ä¸“æ³¨</button>
              <button class="btn pill" data-mode="short">çŸ­ä¼‘</button>
              <button class="btn pill" data-mode="long">é•¿ä¼‘</button>
              <span class="badge" id="cycleInfo">ç¬¬ 1 è½®</span>
            </div>
            <div class="screen">
              <div class="time" id="time">25:00</div>
              <div class="muted" id="modeLabel">ä¸“æ³¨æ¨¡å¼</div>
            </div>
            <div class="row">
              <button class="btn primary" id="startPause">å¼€å§‹</button>
              <button class="btn" id="skip">è·³è¿‡</button>
              <button class="btn ghost" id="reset">é‡ç½®</button>
            </div>
          </div>

          <div class="kpi">
            <div class="card"><div class="muted">æœ¬å‘¨ç´¯è®¡</div><div class="num" id="wkMin">0</div><div class="muted">åˆ†é’Ÿ</div></div>
            <div class="card"><div class="muted">è¿ç»­æ‰“å¡</div><div class="num" id="streak">0</div><div class="muted">å¤©</div></div>
            <div class="card"><div class="muted">æ€»ä»»åŠ¡æ•°</div><div class="num" id="totalTasks">0</div></div>
          </div>
        </div>
      </div>

      <!-- å³ä¾§ä¸»å·¥ä½œåŒº -->
      <div class="panel">
        <div class="hd">
          <div class="tabs">
            <button class="tab active" data-tab="todo">ğŸ“‹ å¾…åŠ</button>
            <button class="tab" data-tab="goals">ğŸ¯ ç›®æ ‡</button>
            <button class="tab" data-tab="exam">ğŸ“Š æ¨¡è€ƒ</button>
            <button class="tab" data-tab="errors">âŒ é”™é¢˜</button>
          </div>
        </div>
        <div class="bd">
          <!-- å¾…åŠæ ‡ç­¾é¡µ -->
          <div class="tab-content active" id="todoContent">
            <div class="todo-header">
              <span class="pill" data-filter="å…¨éƒ¨">å…¨éƒ¨</span>
              <span class="pill" data-filter="æ•°å­¦ä¸€">æ•°å­¦ä¸€</span>
              <span class="pill" data-filter="è‹±è¯­ä¸€">è‹±è¯­ä¸€</span>
              <span class="pill" data-filter="æ”¿æ²»">æ”¿æ²»</span>
              <span class="pill" data-filter="ä¿¡å·ä¸ç³»ç»Ÿ">ä¿¡å·ä¸ç³»ç»Ÿ</span>
              <span class="pill" data-filter="æ•°å­—ç”µè·¯">æ•°å­—ç”µè·¯</span>
              <span class="pill" data-filter="å…¶ä»–">å…¶ä»–</span>
            </div>

            <div class="todo-inputs" style="margin-top:10px">
              <input id="taskTitle" placeholder="ä»»åŠ¡å†…å®¹"/>
              <select id="taskSubject">
                <option value="æ•°å­¦ä¸€">æ•°å­¦ä¸€</option>
                <option value="è‹±è¯­ä¸€">è‹±è¯­ä¸€</option>
                <option value="æ”¿æ²»">æ”¿æ²»</option>
                <option value="ä¿¡å·ä¸ç³»ç»Ÿ">ä¿¡å·ä¸ç³»ç»Ÿ</option>
                <option value="æ•°å­—ç”µè·¯">æ•°å­—ç”µè·¯</option>
                <option value="å…¶ä»–">å…¶ä»–</option>
              </select>
              <input id="taskDue" type="date">
              <select id="taskPri">
                <option value="P1">ç´§æ€¥</option>
                <option value="P2" selected>å¸¸è§„</option>
                <option value="P3">ä½</option>
              </select>
              <button id="addTask" class="btn primary">æ·»åŠ </button>
            </div>
            <div id="taskList" style="margin-top:12px"></div>
          </div>

          <!-- å­¦ä¹ ç›®æ ‡æ ‡ç­¾é¡µ -->
          <div class="tab-content" id="goalsContent">
            <div class="goals-grid">
              <div class="goal-item">
                <div><strong>æ•°å­¦ä¸€</strong> - æ¯æ—¥13é¢˜</div>
                <div class="muted">è¿‘ 7 å¤©è¿›åº¦</div>
                <div class="goal-progress"><div class="bar" id="mathProgress" style="width: 0%"></div></div>
                <div class="muted" id="mathProgressText" style="margin-top:4px">0 / 91 é¢˜</div>
              </div>
              <div class="goal-item">
                <div><strong>è‹±è¯­ä¸€</strong> - æ¯æ—¥1ç¯‡é˜…è¯»</div>
                <div class="muted">è¿‘ 7 å¤©è¿›åº¦</div>
                <div class="goal-progress"><div class="bar" id="engProgress" style="width: 0%"></div></div>
                <div class="muted" id="engProgressText" style="margin-top:4px">0 / 7 ç¯‡</div>
              </div>
            </div>
            <button class="btn" id="addGoal">+ æ·»åŠ å­¦ä¹ ç›®æ ‡ï¼ˆè‡ªå®šä¹‰ï¼‰</button>
            <div id="customGoals" style="margin-top:10px"></div>
          </div>

          <!-- æ¨¡è€ƒç®¡ç†æ ‡ç­¾é¡µ -->
          <div class="tab-content" id="examContent">
            <div class="row" style="margin-bottom:12px">
              <input id="examName" placeholder="è€ƒè¯•åç§°ï¼Œå¦‚ï¼šæ•°å­¦æ¨¡æ‹Ÿå·1"/>
              <input id="examScore" type="number" placeholder="å¾—åˆ†" min="0" max="150"/>
              <input id="examTotal" type="number" placeholder="æ€»åˆ†" min="0" max="150" value="150"/>
              <button id="addExam" class="btn primary">è®°å½•</button>
            </div>
            <div id="examList"></div>
          </div>

          <!-- é”™é¢˜æœ¬æ ‡ç­¾é¡µ -->
          <div class="tab-content" id="errorsContent">
            <div class="row" style="margin-bottom:12px">
              <select id="errorSubject">
                <option value="æ•°å­¦ä¸€">æ•°å­¦ä¸€</option>
                <option value="è‹±è¯­ä¸€">è‹±è¯­ä¸€</option>
                <option value="æ”¿æ²»">æ”¿æ²»</option>
                <option value="ä¿¡å·ä¸ç³»ç»Ÿ">ä¿¡å·ä¸ç³»ç»Ÿ</option>
                <option value="æ•°å­—ç”µè·¯">æ•°å­—ç”µè·¯</option>
              </select>
              <input id="errorTitle" placeholder="é”™é¢˜æè¿°"/>
              <button id="addError" class="btn primary">æ·»åŠ </button>
            </div>
            <textarea id="errorContent" placeholder="é¢˜ç›®å†…å®¹ã€è§£ç­”è¿‡ç¨‹ã€é”™è¯¯åŸå› ..." rows="4"></textarea>
            <div id="errorList" style="margin-top:12px"></div>
          </div>
        </div>
      </div>
    </div>

    <div style="height:14px"></div>

    <div class="grid">
      <!-- æ—¥å† -->
      <div class="panel">
        <div class="hd">
          <strong>å­¦ä¹ æ—¥å†</strong>
          <div class="row">
            <button class="btn icon" id="prevMonth">â—€</button>
            <span class="badge" id="ymLabel">--</span>
            <button class="btn icon" id="nextMonth">â–¶</button>
          </div>
        </div>
        <div class="bd">
          <div class="row" style="margin-bottom:6px; justify-content:space-between">
            <div class="row" style="gap:10px">
              <span class="dow">ä¸€</span><span class="dow">äºŒ</span><span class="dow">ä¸‰</span>
              <span class="dow">å››</span><span class="dow">äº”</span><span class="dow">å…­</span><span class="dow">æ—¥</span>
            </div>
          </div>
          <div id="calendar" class="calendar"></div>
        </div>
      </div>

      <!-- è¯æ±‡ & ç»Ÿè®¡ & ç¬”è®° -->
      <div class="panel">
        <div class="hd">
          <div class="tabs">
            <button class="tab active" data-tab="vocab">ğŸ“– è¯æ±‡</button>
            <button class="tab" data-tab="stats">ğŸ“ˆ ç»Ÿè®¡</button>
            <button class="tab" data-tab="notes">ğŸ“ ç¬”è®°</button>
          </div>
        </div>
        <div class="bd">
          <div class="tab-content active" id="vocabContent">
            <div class="row" style="margin-bottom:10px">
              <input id="vWord" placeholder="å•è¯"/>
              <input id="vMean" placeholder="é‡Šä¹‰"/>
              <button id="addVocab" class="btn primary">æ·»åŠ </button>
            </div>
            <div class="row" style="margin-bottom:10px">
              <button class="btn" id="startQuiz">å¼€å§‹æµ‹éªŒ</button>
              <button class="btn ghost" id="shuffle">æ‰“ä¹±</button>
            </div>
            <div id="vCards"></div>
            <div id="quizBox" class="card" hidden>
              <div class="word" id="qFront">â€”</div>
              <div class="mean" id="qBack" hidden>â€”</div>
              <div class="row" style="justify-content:center; margin-top:8px">
                <button class="btn" id="reveal">æ˜¾ç¤º</button>
                <button class="btn success" id="know">è®¤è¯†</button>
                <button class="btn danger" id="dont">ä¸è®¤è¯†</button>
              </div>
            </div>
          </div>

          <div class="tab-content" id="statsContent">
            <div class="stats-grid">
              <canvas id="chartMin"></canvas>
              <canvas id="chartTask"></canvas>
            </div>
          </div>

          <div class="tab-content" id="notesContent">
            <div class="toolbar">
              <button class="btn icon" data-cmd="bold">B</button>
              <button class="btn icon" data-cmd="italic">I</button>
              <button class="btn" id="clearNotes">æ¸…ç©º</button>
            </div>
            <div id="editor" class="editor" contenteditable="true"></div>
          </div>
        </div>
      </div>
    </div>

    <div style="height:14px"></div>

    <!-- é˜¶æ®µå‘¨è®¡åˆ’ & æ—¶é—´è§„åˆ’è¡¨ -->
    <div class="panel">
      <div class="hd">
        <strong>é˜¶æ®µå‘¨è®¡åˆ’ & æ—¶é—´è§„åˆ’è¡¨</strong>
        <div class="row">
          <button class="btn ghost" id="restoreDefaultPlan">æ¢å¤é»˜è®¤æ¨¡æ¿</button>
          <button class="btn" id="savePlanBtn">ä¿å­˜</button>
        </div>
      </div>
      <div class="bd">
        <div class="tabs">
          <button class="tab active" data-tab="wkplan">ğŸ—‚ é˜¶æ®µå‘¨è®¡åˆ’</button>
          <button class="tab" data-tab="timetable">â° æ—¶é—´è§„åˆ’è¡¨</button>
        </div>

        <div class="tab-content active" id="wkplanContent">
          <div class="row" style="margin-bottom:10px">
            <select id="stageSel">
              <option value="åŸºç¡€æœŸ">åŸºç¡€æœŸ</option>
              <option value="å¼ºåŒ–æœŸ">å¼ºåŒ–æœŸ</option>
              <option value="å†²åˆºæœŸ">å†²åˆºæœŸ</option>
            </select>
            <button class="btn" id="addWeekItem">+ æ·»åŠ æ¡ç›®</button>
          </div>
          <ul id="wkList" class="wk-list"></ul>
        </div>

        <div class="tab-content" id="timetableContent">
          <div class="row" style="margin-bottom:10px">
            <button class="btn" id="addSlot">+ æ·»åŠ æ—¶é—´æ®µ</button>
          </div>
          <div id="ttBox"></div>
        </div>
      </div>
    </div>
  </main>

  <!-- Floating Action Button -->
  <button class="fab no-print" id="fab" title="å¿«é€Ÿæ·»åŠ ä»»åŠ¡">+</button>

  <script>
    // ===== å‘½åç©ºé—´ï¼ˆä¸æ—§ç‰ˆéš”ç¦»ï¼‰ =====
    const NS = 'ke_v2_';

    // ===== åŸºç¡€å·¥å…·å‡½æ•° =====
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const fmt2 = n => String(n).padStart(2,'0');
    const todayKey = (d=new Date()) => `${d.getFullYear()}-${fmt2(d.getMonth()+1)}-${fmt2(d.getDate())}`;

    // ç®€æ˜“å­˜å‚¨
    const store = {
      get(k, def) {
        try {
          const v = localStorage.getItem(NS + k);
          return v ? JSON.parse(v) : (def ?? null);
        } catch {
          return def ?? null;
        }
      },
      set(k, v) { localStorage.setItem(NS + k, JSON.stringify(v)); },
      del(k) { localStorage.removeItem(NS + k); },
      all() {
        const data = {};
        Object.keys(localStorage).forEach(k=>{
          if (k.startsWith(NS)) data[k] = JSON.parse(localStorage.getItem(k));
        });
        return data;
      },
      clearAll() {
        Object.keys(localStorage).forEach(k=>{
          if (k.startsWith(NS)) localStorage.removeItem(k);
        });
      }
    };

    // ===== ä¸»é¢˜ç³»ç»Ÿ =====
    const themeBtn = $('#themeBtn');
    function applyTheme() {
      document.documentElement.setAttribute('data-theme', store.get('theme', 'dark'));
    }
    themeBtn.onclick = () => {
      const theme = store.get('theme', 'dark') === 'dark' ? 'light' : 'dark';
      store.set('theme', theme);
      applyTheme();
      drawCharts();
    };
    applyTheme();

    // ===== æ—¶é’Ÿ =====
    function updateClock() {
      const now = new Date();
      $('#now').textContent = `${fmt2(now.getHours())}:${fmt2(now.getMinutes())}`;
    }
    setInterval(updateClock, 1000);
    updateClock();

    // ===== å€’è®¡æ—¶ =====
    const examDate = $('#examDate');
    examDate.value = store.get('examDate', '2025-12-20');
    function updateCountdown() {
      const target = new Date(examDate.value + 'T00:00:00');
      const now = new Date();
      const days = Math.ceil((target - now) / (1000 * 60 * 60 * 24));
      $('#dLeft').textContent = days >= 0 ? days : 0;
      $('#motivationSub').textContent = `è·ç¦»è€ƒç ”è¿˜æœ‰ ${days >= 0 ? days : 0} å¤©ï¼Œä»Šå¤©ä¹Ÿè¦å…¨åŠ›ä»¥èµ´ï¼`;
    }
    examDate.onchange = () => { store.set('examDate', examDate.value); updateCountdown(); };
    updateCountdown();

    // ===== ç•ªèŒ„é’Ÿç³»ç»Ÿ =====
    const pomodoro = {
      mode: 'work',
      timeLeft: 25 * 60,
      isRunning: false,
      timer: null,
      cycle: 1,
      settings: { work: 25, short: 5, long: 15 }
    };

    function updatePomodoroDisplay() {
      const mins = Math.floor(pomodoro.timeLeft / 60);
      const secs = pomodoro.timeLeft % 60;
      const timeStr = `${fmt2(mins)}:${fmt2(secs)}`;
      $('#time').textContent = timeStr;
      $('#focusTime').textContent = timeStr;

      const modeText = { work: 'ä¸“æ³¨æ¨¡å¼', short: 'çŸ­ä¼‘æ¯', long: 'é•¿ä¼‘æ¯' }[pomodoro.mode];
      $('#modeLabel').textContent = modeText;
      $('#focusStatusText').textContent = modeText;

      $('#cycleInfo').textContent = `ç¬¬ ${pomodoro.cycle} è½®`;

      $$('.modes .btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.mode === pomodoro.mode);
      });
    }

    function startPomodoro() {
      if (pomodoro.isRunning) return;
      pomodoro.isRunning = true;
      $('#startPause').textContent = 'æš‚åœ';
      pomodoro.timer = setInterval(() => {
        pomodoro.timeLeft--;
        updatePomodoroDisplay();
        if (pomodoro.timeLeft <= 0) { completeSession(); nextMode(); }
      }, 1000);
    }

    function pausePomodoro() {
      pomodoro.isRunning = false;
      clearInterval(pomodoro.timer);
      $('#startPause').textContent = 'å¼€å§‹';
    }

    function resetPomodoro() {
      pausePomodoro();
      pomodoro.timeLeft = pomodoro.settings[pomodoro.mode] * 60;
      updatePomodoroDisplay();
    }

    function setMode(mode) {
      pomodoro.mode = mode;
      pomodoro.timeLeft = pomodoro.settings[mode] * 60;
      updatePomodoroDisplay();
    }

    function nextMode() {
      if (pomodoro.mode === 'work') {
        if (pomodoro.cycle % 4 === 0) setMode('long'); else setMode('short');
      } else {
        pomodoro.cycle++;
        setMode('work');
      }
      resetPomodoro();
    }

    function completeSession() {
      if (pomodoro.mode === 'work') {
        logStudyTime(pomodoro.settings.work);
        showNotification('ä¸“æ³¨æ—¶é—´å®Œæˆï¼', 'ä¼‘æ¯ä¸€ä¸‹å§ ğŸ˜Š');
      }
    }

    $('#startPause').onclick = () => pomodoro.isRunning ? pausePomodoro() : startPomodoro();
    $('#skip').onclick = () => { nextMode(); };
    $('#reset').onclick = resetPomodoro;
    $$('.modes .btn').forEach(btn => btn.onclick = () => setMode(btn.dataset.mode));
    updatePomodoroDisplay();

    // ===== ä¸“æ³¨æ¨¡å¼ =====
    $('#focusBtn').onclick = () => { $('#focusOverlay').style.display = 'flex'; startPomodoro(); };
    $('#exitFocus').onclick = () => { $('#focusOverlay').style.display = 'none'; };
    $('#pauseFocus').onclick = () => {
      pomodoro.isRunning ? pausePomodoro() : startPomodoro();
      $('#pauseFocus').textContent = pomodoro.isRunning ? 'æš‚åœ' : 'ç»§ç»­';
    };

    // ===== æ•°æ®è®°å½•ä¸ç»Ÿè®¡ =====
    function logStudyTime(minutes) {
      const key = todayKey();
      const log = store.get('log_' + key, { minutes: 0, tasks: 0, pomodoros: 0 });
      log.minutes += minutes;
      log.pomodoros += 1;
      store.set('log_' + key, log);
      updateStats();
    }

    function logTask() {
      const key = todayKey();
      const log = store.get('log_' + key, { minutes: 0, tasks: 0, pomodoros: 0 });
      log.tasks += 1;
      store.set('log_' + key, log);
      updateStats();
    }

    function getWeekData() {
      const data = [];
      for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const log = store.get('log_' + todayKey(date), { minutes: 0, tasks: 0 });
        data.push({ date: todayKey(date), ...log });
      }
      return data;
    }

    function updateStats() {
      const today = store.get('log_' + todayKey(), { minutes: 0, tasks: 0, pomodoros: 0 });
      const goal = parseInt($('#goalMin').value) || 180;

      $('#todayProgress').textContent = `ä»Šæ—¥ä¸“æ³¨ ${today.minutes} åˆ†é’Ÿ Â· ${today.pomodoros} ä¸ªç•ªèŒ„ Â· ${today.tasks} ä¸ªä»»åŠ¡`;

      const goalHit = today.minutes >= goal;
      $('#goalHit').textContent = goalHit ? 'å·²è¾¾æˆ' : 'æœªè¾¾æˆ';
      $('#goalHit').style.background = goalHit ? 'var(--ok)' : 'var(--panel-hi)';

      // æœ¬å‘¨ç´¯è®¡
      const weekData = getWeekData();
      $('#wkMin').textContent = weekData.reduce((sum, day) => sum + day.minutes, 0);

      // è¿ç»­æ‰“å¡ï¼ˆæŒ‰ç›®æ ‡åˆ†é’Ÿï¼‰
      let streak = 0;
      for (let i = 0; i < 365; i++) {
        const date = new Date(); date.setDate(date.getDate() - i);
        const dayLog = store.get('log_' + todayKey(date), { minutes: 0 });
        if (dayLog.minutes >= goal) streak++; else break;
      }
      $('#streak').textContent = streak;

      // æ€»ä»»åŠ¡æ•°ï¼ˆå·²å®Œæˆï¼‰
      const tasks = store.get('tasks', []);
      $('#totalTasks').textContent = tasks.filter(t => t.done).length;

      updateCalendar();
      drawCharts();
      updateGoalProgress();
    }

    $('#goalMin').onchange = () => { store.set('goalMin', parseInt($('#goalMin').value)); updateStats(); };
    $('#goalMin').value = store.get('goalMin', 180);

    // ===== ä»»åŠ¡ç®¡ç† =====
    let tasks = store.get('tasks', []);

    // å­¦ç§‘ç­›é€‰
    let curFilter = store.get('filter', 'å…¨éƒ¨');
    function applyFilterPills() {
      $$('.todo-header .pill').forEach(el=>{
        el.classList.toggle('active', el.dataset.filter === curFilter);
        el.onclick = ()=>{ curFilter = el.dataset.filter; store.set('filter', curFilter); renderTasks(); };
      });
    }

    function addTask(title, subject = 'å…¶ä»–', due = null, priority = 'P2') {
      const task = {
        id: Date.now() + Math.random(),
        title, subject, due, priority,
        done: false,
        createdAt: Date.now(),
        doneAt: null
      };
      tasks.push(task);
      store.set('tasks', tasks);
      renderTasks();
    }

    function toggleTask(id) {
      const task = tasks.find(t => t.id === id);
      if (task) {
        task.done = !task.done;
        task.doneAt = task.done ? Date.now() : null;
        if (task.done) logTask();
        store.set('tasks', tasks);
        renderTasks();
      }
    }

    function deleteTask(id) {
      tasks = tasks.filter(t => t.id !== id);
      store.set('tasks', tasks);
      renderTasks();
    }

    function renderTasks() {
      const list = $('#taskList');
      list.innerHTML = '';

      const filtered = tasks.filter(t => curFilter === 'å…¨éƒ¨' ? true : t.subject === curFilter);

      const sortedTasks = filtered
        .sort((a, b) => {
          if (a.done !== b.done) return a.done ? 1 : -1;
          if (a.priority !== b.priority) return a.priority.localeCompare(b.priority);
          return (a.due || '9999-12-31').localeCompare(b.due || '9999-12-31');
        });

      sortedTasks.forEach(task => {
        const div = document.createElement('div');
        div.className = 'task' + (task.done ? ' done' : '');
        div.innerHTML = `
          <input type="checkbox" ${task.done ? 'checked' : ''} onchange="toggleTask(${task.id})" aria-label="å®Œæˆä»»åŠ¡">
          <div>
            <div class="title">${escapeHTML(task.title)} <span class="tag">${task.subject}</span></div>
            <div class="meta">ä¼˜å…ˆçº§: ${task.priority} ${task.due ? 'Â· æˆªæ­¢: ' + task.due : ''}</div>
          </div>
          <button class="btn icon" title="åˆ é™¤" onclick="deleteTask(${task.id})">ğŸ—‘</button>
        `;
        list.appendChild(div);
      });

      updateStats();
    }

    // è¾“å…¥å¿«æ·é”®å›è½¦æ·»åŠ 
    $('#taskTitle').onkeydown = (e) => { if (e.key === 'Enter') $('#addTask').click(); };
    $('#addTask').onclick = () => {
      const title = $('#taskTitle').value.trim();
      if (!title) return;
      addTask(title, $('#taskSubject').value, $('#taskDue').value || null, $('#taskPri').value);
      $('#taskTitle').value = '';
    };

    // ===== æ ‡ç­¾é¡µç³»ç»Ÿ =====
    function initTabs() {
      $$('.tab').forEach(tab => {
        tab.onclick = () => {
          const targetTab = tab.dataset.tab;
          const container = tab.closest('.panel');
          container.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          container.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          tab.classList.add('active');
          container.querySelector('#' + targetTab + 'Content').classList.add('active');
          if (targetTab === 'stats') drawCharts();
        };
      });
    }

    // ===== å­¦ä¹ ç›®æ ‡ç®¡ç†ï¼ˆè¿‘ 7 å¤©ï¼‰ =====
    let customGoals = store.get('customGoals', []);
    function updateGoalProgress() {
      const weekAgo = Date.now() - 7*24*3600*1000;
      const doneMath = tasks.filter(t => t.subject === 'æ•°å­¦ä¸€' && t.done && t.doneAt && t.doneAt >= weekAgo).length;
      const doneEng = tasks.filter(t => t.subject === 'è‹±è¯­ä¸€' && t.done && t.doneAt && t.doneAt >= weekAgo).length;

      const mathTarget = 13*7;
      const engTarget = 1*7;

      const mathPct = Math.min(100, Math.round(doneMath / mathTarget * 100));
      const engPct  = Math.min(100, Math.round(doneEng / engTarget * 100));

      $('#mathProgress').style.width = mathPct + '%';
      $('#engProgress').style.width = engPct + '%';
      $('#mathProgressText').textContent = `${doneMath} / ${mathTarget} é¢˜`;
      $('#engProgressText').textContent  = `${doneEng} / ${engTarget} ç¯‡`;

      // è‡ªå®šä¹‰ç›®æ ‡
      const box = $('#customGoals');
      box.innerHTML = '';
      customGoals.forEach((g, idx) => {
        const done = tasks.filter(t => t.subject === g.subject && t.done && t.doneAt && t.doneAt >= weekAgo).length;
        const pct = Math.min(100, Math.round(done / g.weekTarget * 100));
        const item = document.createElement('div');
        item.className = 'goal-item';
        item.innerHTML = `
          <div><strong>${g.subject}</strong> - ${escapeHTML(g.name)}ï¼ˆå‘¨ç›®æ ‡ ${g.weekTarget}ï¼‰</div>
          <div class="goal-progress"><div class="bar" style="width:${pct}%"></div></div>
          <div class="muted" style="margin-top:4px">${done} / ${g.weekTarget}</div>
          <div class="row" style="margin-top:6px">
            <button class="btn ghost" onclick="deleteGoal(${idx})">åˆ é™¤</button>
          </div>
        `;
        box.appendChild(item);
      });
    }

    $('#addGoal').onclick = () => {
      const name = prompt('ç›®æ ‡åç§°ï¼ˆå¦‚ï¼šè‹±è¯­ä¸€å¬åŠ› 3 æ¬¡ï¼‰');
      if (!name) return;
      const subject = prompt('å­¦ç§‘ï¼ˆæ•°å­¦ä¸€/è‹±è¯­ä¸€/æ”¿æ²»/ä¿¡å·ä¸ç³»ç»Ÿ/æ•°å­—ç”µè·¯/å…¶ä»–ï¼‰', 'è‹±è¯­ä¸€') || 'è‹±è¯­ä¸€';
      const weekTarget = parseInt(prompt('å‘¨ç›®æ ‡æ•°é‡ï¼ˆæ•´æ•°ï¼‰', '3'), 10);
      if (!weekTarget || weekTarget <= 0) return;
      customGoals.push({ name, subject, weekTarget });
      store.set('customGoals', customGoals);
      updateGoalProgress();
    };
    window.deleteGoal = (idx)=>{ customGoals.splice(idx,1); store.set('customGoals', customGoals); updateGoalProgress(); };

    // ===== æ¨¡è€ƒç®¡ç† =====
    let exams = store.get('exams', []);
    $('#addExam').onclick = () => {
      const name = $('#examName').value.trim();
      const score = parseInt($('#examScore').value);
      const total = parseInt($('#examTotal').value) || 150;
      if (!name || isNaN(score)) return;
      exams.push({ id: Date.now(), name, score, total, date: todayKey(), percentage: Math.round((score / total) * 100) });
      store.set('exams', exams);
      renderExams();
      $('#examName').value = ''; $('#examScore').value = '';
    };

    function renderExams() {
      const list = $('#examList'); list.innerHTML = '';
      const recent = exams.slice(-10).reverse();
      recent.forEach(exam => {
        const div = document.createElement('div');
        div.className = 'exam-item';
        div.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div><strong>${escapeHTML(exam.name)}</strong><div class="muted">${exam.date}</div></div>
            <div class="exam-score">${exam.score}/${exam.total} (${exam.percentage}%)</div>
          </div>
        `;
        list.appendChild(div);
      });
    }

    // ===== é”™é¢˜æœ¬ =====
    let errors = store.get('errors', []);
    $('#addError').onclick = () => {
      const subject = $('#errorSubject').value;
      const title = $('#errorTitle').value.trim();
      const content = $('#errorContent').value.trim();
      if (!title || !content) return;
      errors.push({ id: Date.now(), subject, title, content, date: todayKey(), reviewed: false });
      store.set('errors', errors);
      renderErrors();
      $('#errorTitle').value = ''; $('#errorContent').value = '';
    };

    function renderErrors() {
      const list = $('#errorList'); list.innerHTML = '';
      errors.slice(-50).reverse().forEach(error => {
        const div = document.createElement('div');
        div.className = 'error-item';
        div.innerHTML = `
          <div style="display:flex; gap:10px; justify-content: space-between; align-items:flex-start;">
            <div style="flex:1;">
              <strong>${error.subject} - ${escapeHTML(error.title)}</strong>
              <div class="muted">${error.date}</div>
              <div class="error-content">${escapeHTML(error.content).replace(/\n/g,'<br>')}</div>
            </div>
            <div class="row">
              <button class="btn ${error.reviewed ? 'success' : 'ghost'}" onclick="toggleErrorReview(${error.id})">${error.reviewed ? 'å·²å¤ä¹ ' : 'å¾…å¤ä¹ '}</button>
              <button class="btn ghost" onclick="deleteError(${error.id})">åˆ é™¤</button>
            </div>
          </div>
        `;
        list.appendChild(div);
      });
    }
    function toggleErrorReview(id) {
      const error = errors.find(e => e.id === id);
      if (error) { error.reviewed = !error.reviewed; store.set('errors', errors); renderErrors(); }
    }
    function deleteError(id) {
      errors = errors.filter(e=>e.id!==id); store.set('errors', errors); renderErrors();
    }
    window.toggleErrorReview = toggleErrorReview;
    window.deleteError = deleteError;

    // ===== æ—¥å†ç³»ç»Ÿ =====
    let currentDate = new Date();
    function updateCalendar() {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      $('#ymLabel').textContent = `${year}å¹´${month + 1}æœˆ`;
      const calendar = $('#calendar'); calendar.innerHTML = '';

      const firstDay = new Date(year, month, 1);
      const startDate = new Date(firstDay);
      startDate.setDate(startDate.getDate() - (firstDay.getDay() + 6) % 7);

      const goal = parseInt($('#goalMin').value) || 180;

      for (let i = 0; i < 42; i++) {
        const date = new Date(startDate); date.setDate(startDate.getDate() + i);
        const dayEl = document.createElement('div'); dayEl.className = 'day';
        if (date.getMonth() !== month) dayEl.style.opacity = '0.3';
        const dateStr = todayKey(date);
        const dayLog = store.get('log_' + dateStr, { minutes: 0 });

        if (dayLog.minutes >= goal) dayEl.classList.add('good');
        else if (dayLog.minutes > 0) dayEl.classList.add('bad');

        dayEl.innerHTML = `<div class="d">${date.getDate()}</div><div class="dot"></div>`;
        dayEl.title = `${dateStr}: ${dayLog.minutes || 0}åˆ†é’Ÿ`;
        calendar.appendChild(dayEl);
      }
    }
    $('#prevMonth').onclick = () => { currentDate.setMonth(currentDate.getMonth() - 1); updateCalendar(); };
    $('#nextMonth').onclick = () => { currentDate.setMonth(currentDate.getMonth() + 1); updateCalendar(); };

    // ===== è¯æ±‡ç³»ç»Ÿ =====
    let vocab = store.get('vocab', []);
    let quizIdx = -1;
    function renderVocab() {
      const container = $('#vCards'); container.innerHTML = '';
      vocab.slice(0, 20).forEach((item) => {
        const card = document.createElement('div'); card.className = 'card'; card.style.marginBottom = '8px';
        const acc = item.reviewed ? Math.round((item.correct / item.reviewed) * 100) : 0;
        card.innerHTML = `
          <div class="word">${escapeHTML(item.word)}</div>
          <div class="mean">${escapeHTML(item.meaning)}</div>
          <div class="muted" style="font-size: 12px;">å¤ä¹  ${item.reviewed||0} æ¬¡ Â· æ­£ç¡®ç‡ ${acc}%</div>
        `;
        container.appendChild(card);
      });
    }
    $('#addVocab').onclick = () => {
      const word = $('#vWord').value.trim(); const meaning = $('#vMean').value.trim();
      if (!word || !meaning) return;
      vocab.push({ id: Date.now(), word, meaning, reviewed: 0, correct: 0 });
      store.set('vocab', vocab); renderVocab(); $('#vWord').value=''; $('#vMean').value='';
    };
    $('#shuffle').onclick = () => { vocab.sort(()=>Math.random()-0.5); renderVocab(); };

    $('#startQuiz').onclick = () => {
      if (!vocab.length) return;
      quizIdx = 0; $('#quizBox').hidden = false; $('#qBack').hidden = true;
      $('#qFront').textContent = vocab[quizIdx].word;
      $('#qBack').textContent = vocab[quizIdx].meaning;
    };
    $('#reveal').onclick = () => { $('#qBack').hidden = false; };
    $('#know').onclick = () => gradeCard(true);
    $('#dont').onclick = () => gradeCard(false);

    function gradeCard(ok) {
      if (quizIdx < 0) return;
      vocab[quizIdx].reviewed = (vocab[quizIdx].reviewed||0)+1;
      if (ok) vocab[quizIdx].correct = (vocab[quizIdx].correct||0)+1;
      store.set('vocab', vocab);
      quizIdx++;
      if (quizIdx >= vocab.length) { alert('æµ‹éªŒç»“æŸï¼'); $('#quizBox').hidden = true; renderVocab(); return; }
      $('#qBack').hidden = true;
      $('#qFront').textContent = vocab[quizIdx].word;
      $('#qBack').textContent = vocab[quizIdx].meaning;
    }

    // ===== å›¾è¡¨ç»˜åˆ¶ =====
    function drawCharts() {
      drawChart('#chartMin', getWeekData(), 'minutes', 'åˆ†é’Ÿ');
      drawChart('#chartTask', getWeekData(), 'tasks', 'ä»»åŠ¡');
    }

    function drawChart(selector, data, field, unit) {
      const canvas = $(selector); if (!canvas) return;
      const ctx = canvas.getContext('2d');
      const rect = canvas.getBoundingClientRect();
      canvas.width = rect.width * 2; canvas.height = rect.height * 2; ctx.scale(2, 2);
      const w = rect.width, h = rect.height, padding = 40, chartW = w - padding * 2, chartH = h - padding * 2;

      ctx.clearRect(0, 0, w, h);
      const textColor = getComputedStyle(document.body).color;
      ctx.fillStyle = textColor; ctx.font = '12px system-ui';

      const maxValue = Math.max(1, ...data.map(d => d[field]));
      const barW = chartW / data.length * 0.6;
      const gap = chartW / data.length * 0.4;

      data.forEach((item, i) => {
        const value = item[field];
        const barH = (value / maxValue) * chartH;
        const x = padding + i * (barW + gap);
        const y = h - padding - barH;

        ctx.fillStyle = '#50a7ff';
        ctx.fillRect(x, y, barW, barH);

        ctx.fillStyle = textColor; ctx.textAlign = 'center';
        ctx.fillText(value + unit, x + barW / 2, y - 5);
        ctx.fillText(item.date.slice(-5), x + barW / 2, h - padding + 20);
      });
    }

    // ===== å¿«æ·æ“ä½œ =====
    $('#quickMath').onclick = () => addTask('å¼ å®‡1000é¢˜ Â· 13é¢˜', 'æ•°å­¦ä¸€');
    $('#quickEng').onclick  = () => addTask('è‹±è¯­ä¸€é˜…è¯» Â· 1ç¯‡ç²¾è¯»', 'è‹±è¯­ä¸€');
    $('#quickPol').onclick  = () => addTask('æ”¿æ²» Â· 1000é¢˜ Â· 30åˆ†é’Ÿ', 'æ”¿æ²»');
    $('#quickSig').onclick  = () => addTask('ä¿¡å·ä¸ç³»ç»Ÿ Â· ä¾‹é¢˜è®­ç»ƒ 45min', 'ä¿¡å·ä¸ç³»ç»Ÿ');
    $('#quickDig').onclick  = () => addTask('æ•°å­—ç”µè·¯ Â· æ ¸å¿ƒæ¦‚å¿µå¤ç›˜ 45min', 'æ•°å­—ç”µè·¯');
    $('#quickVocab').onclick = () => { document.querySelector('[data-tab="vocab"]').click(); $('#vWord').focus(); };
    $('#quickReview').onclick = () => { document.querySelector('[data-tab="errors"]').click(); };

    // ===== æµ®åŠ¨æŒ‰é’® =====
    $('#fab').onclick = () => { $('#taskTitle').focus(); };

    // ===== é€šçŸ¥ç³»ç»Ÿ =====
    function showNotification(title, message) {
      if (!('Notification' in window)) return;
      if (Notification.permission === 'granted') new Notification(title, { body: message });
      else if (Notification.permission !== 'denied') {
        Notification.requestPermission().then(p => { if (p === 'granted') new Notification(title, { body: message }); });
      }
    }

    // ===== åŠ±å¿—è¯­å½• =====
    const motivationalQuotes = [
      "111111111",
      "2222222222",
      "33333333",
      "444444444444444",
      "455555555555555555",
      "6666666666666666"
    ];
    function updateMotivation() {
      const quote = motivationalQuotes[Math.floor(Math.random() * motivationalQuotes.length)];
      $('#motivationText').textContent = quote;
    }

    // ===== ç¬”è®°ç³»ç»Ÿ =====
    const editor = $('#editor');
    editor.innerHTML = store.get('notes', '');
    editor.oninput = () => store.set('notes', editor.innerHTML);
    $('#clearNotes').onclick = () => { if (confirm('ç¡®è®¤æ¸…ç©ºç¬”è®°ï¼Ÿ')) { editor.innerHTML = ''; store.set('notes', ''); } };
    $$('.toolbar [data-cmd]').forEach(btn => btn.onclick = () => document.execCommand(btn.dataset.cmd, false, null));

    // ===== é˜¶æ®µå‘¨è®¡åˆ’ & æ—¶é—´è§„åˆ’è¡¨ =====
    let wkPlan = store.get('wkPlan', null);
    let timetable = store.get('timetable', null);
    const defaultWkPlan = {
      "åŸºç¡€æœŸ":[
        "æ•°å­¦ä¸€ï¼šæ¯æ—¥ 13 é¢˜ + é”™é¢˜å¤ç›˜ 20min",
        "è‹±è¯­ä¸€ï¼šæ¯æ—¥ 1 ç¯‡é˜…è¯» + ç”Ÿè¯æ•´ç†",
        "ä¿¡å·ä¸ç³»ç»Ÿï¼šæ¦‚å¿µ + ä¾‹é¢˜ 45min",
        "æ•°å­—ç”µè·¯ï¼šç« èŠ‚å¤ä¹  45min",
        "æ”¿æ²»ï¼šæ¯æ—¥ 30minï¼ˆåˆ·é¢˜æˆ–èƒŒè¯µï¼‰"
      ],
      "å¼ºåŒ–æœŸ":[
        "æ•°å­¦ä¸€ï¼šçœŸé¢˜/å¥—é¢˜ 1 å¥— + è®¢æ­£",
        "è‹±è¯­ä¸€ï¼šå®Œå½¢/æ–°é¢˜å‹/ç¿»è¯‘ äº¤æ›¿è®­ç»ƒ",
        "ä¿¡å·ä¸ç³»ç»Ÿï¼šä¸“é¢˜çªç ´ï¼ˆé¢‘åŸŸ/æ—¶åŸŸï¼‰",
        "æ•°å­—ç”µè·¯ï¼šç»¼åˆé¢˜è®­ç»ƒ",
        "æ”¿æ²»ï¼šé€‰æ‹©é¢˜ + ä¸»è§‚é¢˜æ¡†æ¶"
      ],
      "å†²åˆºæœŸ":[
        "æ•°å­¦ä¸€ï¼šå¥—é¢˜è®¡æ—¶è®­ç»ƒ + çº é”™æœ¬å›çœ‹",
        "è‹±è¯­ä¸€ï¼šçœŸé¢˜äºŒåˆ· + ä½œæ–‡æ¨¡æ¿æ‰“ç£¨",
        "ä¿¡å·ä¸ç³»ç»Ÿï¼šé«˜é¢‘é”™é¢˜å›çœ‹",
        "æ•°å­—ç”µè·¯ï¼šè–„å¼±ç‚¹å›è¡¥",
        "æ”¿æ²»ï¼šæŠ¼é¢˜å· + ç­”é¢˜å¡æ¼”ç»ƒ"
      ]
    };
    const defaultTimetable = [
      { time:"06:45-07:15", task:"èµ·åºŠ & æ—©è¯»è‹±è¯­ä¸€è¯æ±‡/çŸ­è¯­" },
      { time:"07:30-09:30", task:"æ•°å­¦ä¸€ Â· åˆ·é¢˜ï¼ˆç•ªèŒ„Ã—4ï¼‰" },
      { time:"09:45-10:30", task:"ä¿¡å·ä¸ç³»ç»Ÿ Â· ä¾‹é¢˜" },
      { time:"10:45-11:30", task:"æ•°å­—ç”µè·¯ Â· ä¾‹é¢˜/æ¦‚å¿µ" },
      { time:"14:00-15:30", task:"è‹±è¯­ä¸€ Â· é˜…è¯»ç²¾è¯»ï¼ˆç•ªèŒ„Ã—3ï¼‰" },
      { time:"15:45-16:30", task:"æ”¿æ²» Â· 1000é¢˜/èƒŒè¯µ" },
      { time:"19:30-20:30", task:"é”™é¢˜/æ€»ç»“ Â· ä»»ä¸€ç§‘" },
      { time:"20:45-21:30", task:"è‡ªç”±æœºåŠ¨/æ‹‰ä¼¸æ”¾æ¾" }
    ];

    if (!wkPlan) wkPlan = JSON.parse(JSON.stringify(defaultWkPlan));
    if (!timetable) timetable = JSON.parse(JSON.stringify(defaultTimetable));

    function renderWkPlan() {
      const stage = $('#stageSel').value;
      const list = $('#wkList'); list.innerHTML = '';
      (wkPlan[stage] || []).forEach((line, idx)=>{
        const li = document.createElement('li');
        li.innerHTML = `
          <div class="row" style="gap:8px">
            <input value="${escapeHTML(line)}" oninput="updateWkItem('${stage}', ${idx}, this.value)" />
            <button class="btn ghost" onclick="delWkItem('${stage}', ${idx})">åˆ é™¤</button>
          </div>`;
        list.appendChild(li);
      });
    }
    function renderTimetable() {
      const box = $('#ttBox'); box.innerHTML='';
      timetable.forEach((slot, idx)=>{
        const row = document.createElement('div'); row.className='tt-row';
        row.innerHTML = `
          <div class="tt-time"><input value="${escapeHTML(slot.time)}" oninput="updateSlot(${idx}, 'time', this.value)" /></div>
          <div><input value="${escapeHTML(slot.task)}" oninput="updateSlot(${idx}, 'task', this.value)" />
          <div class="row" style="margin-top:6px"><button class="btn ghost" onclick="delSlot(${idx})">åˆ é™¤</button></div></div>`;
        box.appendChild(row);
      });
    }
    window.updateWkItem = (stage, idx, val)=>{ wkPlan[stage][idx]=val; };
    window.delWkItem = (stage, idx)=>{ wkPlan[stage].splice(idx,1); renderWkPlan(); };
    window.updateSlot = (idx, key, val)=>{ timetable[idx][key]=val; };
    window.delSlot = (idx)=>{ timetable.splice(idx,1); renderTimetable(); };

    $('#stageSel').onchange = renderWkPlan;
    $('#addWeekItem').onclick = ()=>{ const s=$('#stageSel').value; wkPlan[s]=wkPlan[s]||[]; wkPlan[s].push(''); renderWkPlan(); };
    $('#addSlot').onclick = ()=>{ timetable.push({ time:'', task:'' }); renderTimetable(); };
    $('#savePlanBtn').onclick = ()=>{ store.set('wkPlan', wkPlan); store.set('timetable', timetable); alert('å·²ä¿å­˜'); };
    $('#restoreDefaultPlan').onclick = ()=>{ if(confirm('æ¢å¤é»˜è®¤æ¨¡æ¿ä¼šè¦†ç›–å½“å‰å†…å®¹ï¼Œç¡®å®šï¼Ÿ')){ wkPlan=JSON.parse(JSON.stringify(defaultWkPlan)); timetable=JSON.parse(JSON.stringify(defaultTimetable)); renderWkPlan(); renderTimetable(); } };

    // ===== å¤‡ä»½ / è¿˜åŸ / æ¸…ç©º =====
    $('#backupBtn').onclick = ()=>{
      const data = store.all();
      const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'study-backup.json'; a.click();
      URL.revokeObjectURL(url);
    };
    $('#restoreBtn').onclick = ()=> $('#restoreFile').click();
    $('#restoreFile').onchange = (e)=>{
      const f = e.target.files[0]; if (!f) return;
      const reader = new FileReader();
      reader.onload = ()=>{
        try{
          const obj = JSON.parse(reader.result);
          // æ¸…ç©ºåå†™å…¥
          store.clearAll();
          Object.keys(obj).forEach(k=> localStorage.setItem(k, JSON.stringify(obj[k])));
          alert('è¿˜åŸå®Œæˆï¼Œé¡µé¢å°†åˆ·æ–°');
          location.reload();
        }catch(err){ alert('æ–‡ä»¶æ ¼å¼é”™è¯¯'); }
      };
      reader.readAsText(f);
    };
    $('#resetAllBtn').onclick = ()=>{
      if (confirm('ç¡®å®šæ¸…ç©ºæœ¬åœ°æ‰€æœ‰å­¦ä¹ æ•°æ®ï¼ˆv2 å‘½åç©ºé—´ï¼‰ï¼Ÿä¸å¯æ¢å¤ã€‚')) { store.clearAll(); location.reload(); }
    };

    // ===== åˆå§‹åŒ–ï¼ˆæ–°çš„é»˜è®¤æ•°æ®ç§å­ï¼‰ =====
    function seedIfEmpty() {
      if (!store.get('seeded', false)) {
        const seedTasks = [
          {title:'å¼ å®‡1000é¢˜ Â· åŸºç¡€ 13é¢˜', subject:'æ•°å­¦ä¸€', pri:'P2'},
          {title:'è‹±è¯­ä¸€é˜…è¯» Â· 2010 Text1 ç²¾è¯»', subject:'è‹±è¯­ä¸€', pri:'P2'},
          {title:'ä¿¡å·ä¸ç³»ç»Ÿ Â· å·ç§¯æ€§è´¨ä¾‹é¢˜', subject:'ä¿¡å·ä¸ç³»ç»Ÿ', pri:'P2'},
          {title:'æ•°å­—ç”µè·¯ Â· è§¦å‘å™¨ä¸æ—¶åºåˆ†æ', subject:'æ•°å­—ç”µè·¯', pri:'P2'},
          {title:'æ”¿æ²» Â· 1000é¢˜ ç¬¬ä¸€ç«  30min', subject:'æ”¿æ²»', pri:'P3'}
        ];
        tasks = seedTasks.map(s=>({
          id: Date.now()+Math.random(),
          title:s.title, subject:s.subject, due:null, priority:s.pri,
          done:false, createdAt:Date.now(), doneAt:null
        }));
        store.set('tasks', tasks);

        vocab = [
          {id:Date.now()+1, word:'notwithstanding', meaning:'å°½ç®¡ï¼›è™½ç„¶', reviewed:0, correct:0},
          {id:Date.now()+2, word:'convolution', meaning:'å·ç§¯', reviewed:0, correct:0},
          {id:Date.now()+3, word:'flip-flop', meaning:'è§¦å‘å™¨', reviewed:0, correct:0},
        ];
        store.set('vocab', vocab);

        store.set('wkPlan', wkPlan);
        store.set('timetable', timetable);

        store.set('seeded', true);
      }
    }

    // ===== å®‰å…¨è¾“å‡º =====
    function escapeHTML(str=''){
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    // ===== é¡µé¢åˆå§‹åŒ– =====
    function init() {
      seedIfEmpty();
      applyFilterPills();
      initTabs();
      renderTasks();
      renderExams();
      renderErrors();
      renderVocab();
      renderWkPlan();
      renderTimetable();
      updateStats();
      updateCalendar();
      updateMotivation();
      drawCharts();
      setInterval(updateMotivation, 3600000); // æ¯å°æ—¶æ›´æ–°ä¸€æ¡åŠ±å¿—è¯­å½•
    }

    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
    else init();

    // æš´éœ²å…¨å±€å‡½æ•°ä¾›HTMLè°ƒç”¨
    window.toggleTask = toggleTask;
    window.deleteTask = deleteTask;
  </script>
</body>
</html>
