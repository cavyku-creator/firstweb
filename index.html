<!DOCTYPE html>
<html lang="zh-CN" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ä¸¤å‘¨å­¦ä¹ æ‰“å¡ Â· å¢å¼ºç‰ˆï¼ˆ2025-08-12 â†’ 2025-08-25ï¼‰</title>
  <meta name="description" content="ä¸¤å‘¨ä½œæ¯+å­¦ä¹ å—+åº·å¤+å‘¨æ¸…+ç»Ÿè®¡ã€‚æ”¯æŒä¸»é¢˜åˆ‡æ¢ã€é¢„è®¾æ—¥ç¨‹ã€å‘¨è§†å›¾ã€ä»»åŠ¡ç»“è½¬ã€æœ¬åœ°å¯¼å…¥å¯¼å‡ºä¸æ‰“å°ã€‚" />
  <style>
    /* ===== Theme ===== */
    :root{
      --bg: #0b0d10; --bg-soft:#0f141a; --card:#11161c; --card-2:#0e1319; --border:#1a222d; --ring:#213043; --muted:#9fb0c2; --text:#e8eef4;
      --accent:#7ad7ff; --accent-2:#7be497; --danger:#ff6b6b; --warn:#ffd166; --ok:#8be28f;
      --shadow: 0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.02);
    }
    [data-theme="light"]{
      --bg:#f6f8fb; --bg-soft:#f0f4f8; --card:#ffffff; --card-2:#f7fafc; --border:#e3e9f0; --ring:#d8e2ee; --muted:#65758b; --text:#0e1726;
      --accent:#0ea5e9; --accent-2:#10b981; --danger:#ef4444; --warn:#d97706; --ok:#16a34a;
      --shadow: 0 10px 24px rgba(2, 6, 23, .06), inset 0 1px 0 rgba(255,255,255,.6);
    }

    /* ===== Base ===== */
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,var(--bg) 0%, var(--bg-soft) 60%, var(--bg) 100%);color:var(--text);font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"PingFang SC","Hiragino Sans GB","Microsoft YaHei",sans-serif}
    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline}
    .wrap{max-width:1180px;margin:0 auto;padding:18px}

    header{position:sticky;top:0;z-index:50;background:rgba(0,0,0,.15);backdrop-filter:saturate(1.1) blur(10px);border-bottom:1px solid var(--border)}
    .topbar{display:flex;align-items:center;gap:14px}
    .topbar h1{margin:0;font-size:18px;font-weight:700}
    .badge{padding:4px 10px;border:1px solid var(--ring);border-radius:999px;color:var(--muted);font-size:12px}
    .spacer{flex:1}
    .toggle{appearance:none;border:1px solid var(--ring);background:var(--card);color:var(--text);padding:8px 12px;border-radius:12px;cursor:pointer}

    main{max-width:1180px;margin:20px auto;padding:0 18px 120px}
    .layout{display:grid;grid-template-columns:1.3fr .7fr;gap:18px}
    @media (max-width:980px){.layout{grid-template-columns:1fr}}

    .card{background:linear-gradient(180deg,var(--card) 0%, var(--card-2) 100%);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow)}
    .hd{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--border)}
    .bd{padding:14px 16px}
    h2{margin:0;font-size:17px}
    .row{display:flex;flex-wrap:wrap;align-items:center;gap:10px}
    .muted{color:var(--muted)}
    .pill{border:1px solid var(--ring);border-radius:999px;padding:6px 10px;color:var(--muted);font-size:12px}
    .btn{appearance:none;border:1px solid var(--ring);background:var(--card);color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer;transition:transform .06s ease,border-color .2s ease}
    .btn:hover{transform:translateY(-1px);border-color:#2a3340}
    .btn.primary{background:linear-gradient(180deg,#0f1e2a,#0e1a24)}
    .btn.accent{background:linear-gradient(180deg,#0d2330,#0c1d2a);border-color:#1b3a4a}
    .btn.danger{background:linear-gradient(180deg,#2a1012,#220c0e);border-color:#402126;color:#ffdede}
    .btn.ghost{opacity:.8}

    .progress{height:10px;background:var(--bg-soft);border:1px solid var(--border);border-radius:999px;overflow:hidden}
    .progress>i{display:block;height:100%;background:linear-gradient(90deg,var(--accent), var(--accent-2));width:0%}

    .tasks{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px}
    @media (max-width:720px){.tasks{grid-template-columns:1fr}}
    .task{display:flex;gap:10px;padding:12px;border:1px solid var(--border);border-radius:12px;background:var(--bg-soft)}
    .task input{transform:scale(1.2);margin-top:2px}
    .task .label{flex:1}

    .aside{position:sticky;top:78px}
    .list{margin:0;padding-left:18px}
    .list li{margin:6px 0}
    .kicker{font-size:12px;color:#cfe7ff}
    .small{font-size:12px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12px;color:#9fb0c2}

    .note{background:var(--bg-soft);border:1px dashed var(--ring);border-radius:12px;padding:10px}
    .split{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media (max-width:780px){.split{grid-template-columns:1fr}}

    .calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
    .daycell{border:1px solid var(--border);border-radius:10px;padding:8px;text-align:center;background:var(--card-2);cursor:pointer}
    .daycell .bar{height:6px;border:1px solid var(--border);border-radius:999px;background:var(--bg-soft);overflow:hidden;margin-top:6px}
    .daycell .bar i{display:block;height:100%;background:linear-gradient(90deg,var(--accent), var(--accent-2));width:0%}
    .daycell.today{outline:2px solid var(--accent)}

    .range{display:flex;align-items:center;gap:8px}
    .range input[type="range"]{width:150px}

    /* Print */
    @media print {
      header,.hide-print{display:none!important}
      body{background:#fff;color:#000}
      main{padding:0}
      .card{box-shadow:none;border:1px solid #ddd}
      .tasks{grid-template-columns:1fr 1fr}
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="topbar">
        <h1>ä¸¤å‘¨å­¦ä¹ æ‰“å¡ Â· å¢å¼ºç‰ˆ</h1>
        <span class="badge">2025-08-12 â†’ 2025-08-25</span>
        <span class="badge">æœ¬åœ°ä¿å­˜ Â· é¢„è®¾æ—¥ç¨‹ Â· ä»»åŠ¡ç»“è½¬</span>
        <div class="spacer"></div>
        <button id="themeToggle" class="toggle" aria-label="åˆ‡æ¢ä¸»é¢˜">ğŸŒ™/â˜€ï¸</button>
      </div>
    </div>
  </header>

  <main>
    <div class="layout">
      <!-- Left: Today Planner -->
      <section class="card" aria-labelledby="dayTitle">
        <div class="hd">
          <div>
            <h2 id="dayTitle">ä»Šæ—¥æ‰“å¡</h2>
            <div class="row small">
              <span class="pill" id="datePill">--</span>
              <span class="pill" id="weekPill">ç¬¬1å‘¨</span>
              <span class="pill" id="hintPill">â€”</span>
              <span class="pill" id="presetPill">é¢„è®¾ï¼šâ€”</span>
            </div>
          </div>
          <div class="row hide-print">
            <button class="btn" id="btnPrev">â†</button>
            <input id="datePicker" type="date" min="2025-08-12" max="2025-08-25" />
            <button class="btn" id="btnNext">â†’</button>
            <button class="btn primary" id="btnToday">ä»Šå¤©</button>
            <button class="btn" id="btnPrint">æ‰“å°</button>
          </div>
        </div>
        <div class="bd">
          <div class="row" style="align-items:center;gap:12px;margin-bottom:10px">
            <div class="kicker">å®Œæˆåº¦</div>
            <div class="progress" style="flex:1;min-width:200px"><i id="bar"></i></div>
            <div id="percent" class="kicker">0%</div>
            <div class="spacer"></div>
            <button class="btn accent hide-print" id="btnRollover" title="å°†ä»Šæ—¥æœªå®Œæˆä»»åŠ¡ç»“è½¬åˆ°æ˜å¤©">æœªå®Œç»“è½¬â†’</button>
            <button class="btn hide-print" id="btnMarkAll">å…¨é€‰</button>
            <button class="btn hide-print" id="btnClear">æ¸…ç©º</button>
          </div>

          <div class="note small" id="adviceBox" style="margin-bottom:10px;display:none"></div>
          <div id="dayNote" class="note small" style="display:none"></div>

          <div class="row hide-print" style="gap:8px;margin:8px 0">
            <label for="presetSelect" class="small muted">æ—¥ç¨‹é¢„è®¾ï¼š</label>
            <select id="presetSelect" class="btn">
              <option value="balanced">å‡è¡¡æ—¥ï¼ˆé»˜è®¤ï¼‰</option>
              <option value="math">æ•°å­¦åŠ é‡æ—¥</option>
              <option value="major">ä¸“ä¸šè¯¾åŠ é‡æ—¥</option>
              <option value="english">è‹±è¯­å†™ä½œ/ç²¾è¯»æ—¥</option>
              <option value="light">è½»æ¢å¤æ—¥ï¼ˆå‘¨æ—¥æ¨èï¼‰</option>
              <option value="exam">æ¨¡æ‹Ÿå·æ—¥ï¼ˆä¸´è¿‘å‘¨æœ«ï¼‰</option>
            </select>
            <button class="btn" id="btnApplyPreset">åº”ç”¨é¢„è®¾åˆ°å½“å¤©</button>
            <button class="btn" id="btnAddTemp">æ·»åŠ ä¸´æ—¶ä»»åŠ¡</button>
          </div>

          <div id="tasks" class="tasks" role="group" aria-label="ä»Šæ—¥ä»»åŠ¡æ¸…å•"></div>
          <div class="small muted" style="margin-top:6px">æç¤ºï¼šå‹¾é€‰è‡ªåŠ¨ä¿å­˜åˆ°æœ¬åœ°ã€‚é¢„è®¾åªå½±å“â€œè®¡åˆ†ä»»åŠ¡â€ï¼Œè‡ªå®šä¹‰ä»»åŠ¡ä¸å—å½±å“ã€‚</div>
        </div>
      </section>

      <!-- Right: Sidebar -->
      <aside class="aside">
        <section class="card" style="margin-bottom:18px">
          <div class="hd"><h2>å¿«é€Ÿè®¾ç½®</h2></div>
          <div class="bd small">
            <div class="row" style="gap:14px 16px">
              <div class="range">
                <label>æ•°å­¦æƒé‡</label>
                <input id="wMath" type="range" min="1" max="5" step="1" value="4"/>
                <span id="wMathV" class="mono">4</span>
              </div>
              <div class="range">
                <label>ä¸“ä¸šè¯¾æƒé‡</label>
                <input id="wMajor" type="range" min="1" max="5" step="1" value="4"/>
                <span id="wMajorV" class="mono">4</span>
              </div>
              <div class="range">
                <label>è‹±è¯­æƒé‡</label>
                <input id="wEng" type="range" min="1" max="5" step="1" value="3"/>
                <span id="wEngV" class="mono">3</span>
              </div>
              <div class="range">
                <label>æ”¿æ²»æƒé‡</label>
                <input id="wPol" type="range" min="1" max="5" step="1" value="2"/>
                <span id="wPolV" class="mono">2</span>
              </div>
            </div>
            <div class="note" id="priorityTip" style="margin-top:10px"></div>
          </div>
        </section>

        <section class="card" style="margin-bottom:18px">
          <div class="hd"><h2>å‘¨è§†å›¾ï¼ˆç‚¹å‡»è·³è½¬ï¼‰</h2></div>
          <div class="bd small">
            <div id="calendar" class="calendar"></div>
            <div class="row" style="margin-top:10px">
              <button class="btn" id="btnWeek1">ç¬¬1å‘¨</button>
              <button class="btn" id="btnWeek2">ç¬¬2å‘¨</button>
            </div>
          </div>
        </section>

        <section class="card" style="margin-bottom:18px">
          <div class="hd"><h2>ä½œæ¯ Â· åº·å¤</h2></div>
          <div class="bd small">
            <div class="split">
              <div>
                <div class="kicker">ä½œæ¯å›ºå®š</div>
                <ul class="list">
                  <li><b>06:45</b> èµ·åºŠï½œæ¸©æ°´</li>
                  <li><b>07:30â€“07:40</b> ä»Šæ—¥ä»»åŠ¡æ’ç¨‹</li>
                  <li><b>08:00â€“10:00</b> A é«˜æ•°</li>
                  <li><b>10:10â€“11:10</b> B è‹±è¯­é•¿éš¾å¥</li>
                  <li><b>11:15â€“12:00</b> C ä¸“ä¸šç²¾è¯»</li>
                  <li><b>13:30â€“15:30</b> D ä¸“ä¸šé¢˜</li>
                  <li><b>15:40â€“16:10</b> åº·å¤è‚©</li>
                  <li><b>16:15â€“17:15</b> E æ”¿æ²»é€‰æ‹©</li>
                  <li><b>19:00â€“21:00</b> F æ•°å­¦å›ç‚‰</li>
                  <li><b>21:10â€“21:40</b> G è‹±è¯­ç²¾è¯»/å†™ä½œ</li>
                </ul>
              </div>
              <div>
                <div class="kicker">åº·å¤ï¼ˆè‚©ï¼‰</div>
                <ul class="list">
                  <li>æ™¨ï¼šèƒ¸æ¤ä¼¸å±•/å¼€ä¹¦å¼ 2Ã—10ï¼›è‚©èƒ›å‰ä¼¸/åç¼© 2Ã—12ï¼›é¢ˆæ·±å±ˆ 3Ã—10ï¼ˆåœ5sï¼‰</li>
                  <li>åˆåï¼šå¼¹åŠ›å¸¦ç­‰é•¿å¤–/å†…æ—‹ å„3Ã—12ï¼›ä¾§å§å¤–æ—‹ 3Ã—12ï¼›scaption â‰¤90Â° 2Ã—12ï¼›èƒ¸å°è‚Œæ”¾æ¾+é—¨æ¡†æ‹‰ä¼¸ 2Ã—30s</li>
                  <li class="muted">å¿Œï¼šè¿‡å¤´æ¨ä¸¾ã€çˆ†å‘ç”©è‚©ã€æç«¯å¤–å±•å¤–æ—‹ã€å€’ç«‹è´Ÿé‡ï¼›è‹¥å¤œé—´ç—›â†‘ â†’ æ¬¡æ—¥å‡é‡50%</li>
                </ul>
              </div>
            </div>
          </div>
        </section>

        <section class="card">
          <div class="hd"><h2>æ•°æ® Â· å¤‡ä»½</h2></div>
          <div class="bd small">
            <div class="row" style="gap:8px 10px">
              <button class="btn" id="btnExport">å¯¼å‡º JSON</button>
              <label class="btn" for="fileImport">å¯¼å…¥ JSON</label>
              <input id="fileImport" type="file" accept="application/json" class="hide-print" style="display:none" />
              <button class="btn danger" id="btnResetAll">é‡ç½®å…¨éƒ¨</button>
            </div>
            <div class="row" style="gap:8px 10px; margin-top:8px">
              <span class="muted">å½“å‰è¿ç»­æ‰“å¡ï¼š</span><b id="streak">0</b><span class="muted"> å¤©</span>
              <span class="muted">Â· å…¨æœŸå¹³å‡å®Œæˆåº¦ï¼š</span><b id="avg">0%</b>
            </div>
          </div>
        </section>
      </aside>
    </div>

    <section class="card" style="margin-top:18px">
      <div class="hd"><h2>ä¸¤å‘¨ä»»åŠ¡æ’ç¨‹ï¼ˆæŒ‰é¢„è®¾å¯å¾®è°ƒï¼‰</h2></div>
      <div class="bd small">
        <div class="split">
          <div>
            <div class="kicker">ç¬¬1å‘¨ï½œ8/12â€“8/18</div>
            <ul class="list">
              <li>æ•°å­¦ï¼šé«˜æ•°18è®² 1â€“4ï¼›ã€Š660é¢˜ã€‹å„20â€“30ï¼›1000é¢˜ A1â€“A2ï¼ˆä¸­æ¡£ä¸ºä¸»ï¼‰ï¼›çº¿ä»£è®²ä¹‰1â€“2</li>
              <li>è‹±è¯­ï¼šå¥å¥çœŸç ”æ¯æ—¥10å¥+åŠŸèƒ½å¥1æ¡ï¼›é˜…è¯»é€»è¾‘1â€“2ç« ï¼›é»„çš®ä¹¦åŸºç¡€è¯•å·1å¥—ï¼ˆæ‹†ä¸¤å¤©ç²¾è¯»ï¼‰</li>
              <li>æ”¿æ²»ï¼šã€Š1000é¢˜ã€‹é©¬åŸ/æ¯›ä¸­ç‰¹ æ¯æ—¥30é¢˜ï¼›ã€Šæ ¸å¿ƒè€ƒæ¡ˆã€‹å‰30â€“40é¡µ</li>
              <li>ä¸“ä¸šï¼šä¿¡å·ç»ªè®º+åŸºç¡€ æ¯èŠ‚5â€“8é¢˜ï¼›æ•°ç”µ é€»è¾‘ä»£æ•°ä¸é—¨ç”µè·¯ 20â€“30é¢˜ + 2å¼ å¡è¯ºå›¾</li>
              <li>å‘¨æ—¥åŠä¼‘ï¼šä»…è‹±è¯­ç²¾è¯» + å‘¨æ¸…ï¼ˆé¢„è®¾å»ºè®®åˆ‡æ¢ä¸ºâ€œè½»æ¢å¤æ—¥â€ï¼‰</li>
            </ul>
          </div>
          <div>
            <div class="kicker">ç¬¬2å‘¨ï½œ8/19â€“8/25</div>
            <ul class="list">
              <li>æ•°å­¦ï¼šé«˜æ•°18è®² 5â€“8ï¼›ã€Š660é¢˜ã€‹é…å¥—ï¼›1000é¢˜ A3â€“A4ï¼›çº¿ä»£è®²ä¹‰3â€“4</li>
              <li>è‹±è¯­ï¼šæ¯æ—¥2ç¯‡ç²¾è¯»ï¼›æ‰‹è¯‘æœ¬é€å¥æ”¹è¯‘ï¼›ä½œæ–‡ä¸»é¢˜å¥æ¯æ—¥5â€“8å¥</li>
              <li>æ”¿æ²»ï¼šã€Š1000é¢˜ã€‹æ¯›ä¸­ç‰¹/å²çº² æ¯æ—¥40é¢˜ï¼›æ™šé—´10â€²æ¦‚å¿µå£è¿°</li>
              <li>ä¸“ä¸šï¼šä¿¡å· å·ç§¯/å†²æ¿€/æ‹‰æ°ï¼›æ•°ç»„åˆé€»è¾‘ï¼ˆç¼–ç å™¨/è¯‘ç å™¨/åŠ æ³•å™¨ï¼‰æ¡†å›¾ä¸æœ€ç®€å¼</li>
              <li>å‘¨æœ«ï¼šå‘¨å°ç»“ + è‡ªæµ‹20é¢˜å°å·ï¼ˆä¿¡å·10 + æ•°ç”µ10ï¼‰</li>
            </ul>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
  ;(()=>{
    const DATE_START='2025-08-12';
    const DATE_END='2025-08-25';
    const KEY_PREFIX='studyplan_2025W33-34_';

    // ===== Presets (which standard tasks are counted) =====
    const ALL_TASKS=[
      { id:'wake',   label:'06:45èµ·åºŠã€æ™¨é—´æ´»åŠ¨å®Œæˆ' },
      { id:'onepage',label:'ä»Šæ—¥â€œä¸€é¡µçº¸è®¡åˆ’â€å·²å†™ï¼ˆ3ä¸ªæœ€é‡è¦ä»»åŠ¡ï¼‰' },
      { id:'A',      label:'å­¦ä¹ å—Aï¼šé«˜æ•°ï¼ˆ50/10Ã—2ï¼‰' },
      { id:'B',      label:'å­¦ä¹ å—Bï¼šè‹±è¯­é•¿éš¾å¥ï¼ˆ50/10ï¼‰' },
      { id:'C',      label:'å­¦ä¹ å—Cï¼šä¸“ä¸šç²¾è¯»ï¼ˆ50/10ï¼‰' },
      { id:'nap',    label:'åˆä¼‘ â‰¥ 20 åˆ†é’Ÿ' },
      { id:'D',      label:'å­¦ä¹ å—Dï¼šä¸“ä¸šé¢˜ï¼ˆ50/10Ã—2ï¼‰' },
      { id:'rehab',  label:'åº·å¤è®­ç»ƒï¼ˆä¸‹åˆæ®µï¼‰' },
      { id:'E',      label:'å­¦ä¹ å—Eï¼šæ”¿æ²»1000é¢˜ï¼ˆâ‰¥30/40é¢˜ï¼‰' },
      { id:'F',      label:'å­¦ä¹ å—Fï¼šæ•°å­¦é¢˜ä¸²/é”™é¢˜å›ç‚‰ï¼ˆ50/10Ã—2ï¼‰' },
      { id:'G',      label:'å­¦ä¹ å—Gï¼šè‹±è¯­ç²¾è¯»/ç¿»è¯‘/ä½œæ–‡ï¼ˆ50/10ï¼‰' },
      { id:'review', label:'æ—¥æ¸…ï¼šé”™é¢˜ç™»è®° + æ˜æ—¥ä¸‰ä»¶äº‹' }
    ];

    const PRESETS={
      balanced: {name:'å‡è¡¡æ—¥', active:['wake','onepage','A','B','C','nap','D','rehab','E','F','G','review'], note:'å‡è¡¡æ¨è¿›ï¼Œä¿æŒèŠ‚å¾‹ä¸è´¨é‡ã€‚'},
      math:     {name:'æ•°å­¦åŠ é‡æ—¥', active:['wake','onepage','A','B','C','nap','D','rehab','F','F2','G','review'], note:'ä¸ŠåˆA+ï¼Œæ™šé—´FåŠ é‡ï¼›æ”¿æ²»å¯è½¬ç§»åˆ°æ˜æ—¥ã€‚'},
      major:    {name:'ä¸“ä¸šè¯¾åŠ é‡æ—¥', active:['wake','onepage','A','B','C','nap','D','D2','rehab','E','G','review'], note:'DåŠ é‡ï¼Œç¡®ä¿ç†è§£+é¢˜æ„Ÿï¼›æ•°å­¦å›ç‚‰é€‚å½“é™è½½ã€‚'},
      english:  {name:'è‹±è¯­å†™ä½œ/ç²¾è¯»æ—¥', active:['wake','onepage','A','B','B2','C','nap','D','rehab','G','G2','review'], note:'é•¿éš¾å¥+å†™ä½œç´ æé›†ä¸­çªç ´ï¼›Aç»´æŒã€‚'},
      light:    {name:'è½»æ¢å¤æ—¥', active:['wake','onepage','B','C','rehab','G','review'], note:'ä»…è¿›è¡Œè½»é‡é«˜è´¨é‡ä»»åŠ¡ + åº·å¤ + å‘¨æ¸…ã€‚'},
      exam:     {name:'æ¨¡æ‹Ÿå·æ—¥', active:['wake','onepage','mock','rehab','review'], note:'æ•´å—æ¨¡æ‹Ÿï¼šæ•°å­¦æˆ–ä¸“ä¸šè¯¾å°å·ï¼›é‡åœ¨å¤ç›˜ã€‚'}
    };

    // Additional virtual tasks used by presets
    const VIRTUAL={
      F2:{ id:'F2', label:'æ•°å­¦é¢å¤–å›ç‚‰ï¼ˆå¯é€‰ 50/10Ã—1ï¼‰' },
      D2:{ id:'D2', label:'ä¸“ä¸šé¢˜é¢å¤–è®­ç»ƒï¼ˆå¯é€‰ 50/10Ã—1ï¼‰' },
      B2:{ id:'B2', label:'è‹±è¯­é¢å¤–ç²¾è¯»/å†™ä½œï¼ˆ50/10Ã—1ï¼‰' },
      mock:{ id:'mock', label:'æ¨¡æ‹Ÿå°å·ï¼ˆ60â€“120minï¼‰+ å®Œæ•´å¤ç›˜' }
    };

    // ===== DOM =====
    const $=s=>document.querySelector(s);
    const elTasks=$('#tasks');
    const elBar=$('#bar');
    const elPct=$('#percent');
    const elDatePill=$('#datePill');
    const elWeekPill=$('#weekPill');
    const elHintPill=$('#hintPill');
    const elPresetPill=$('#presetPill');
    const elDatePicker=$('#datePicker');
    const elDayNote=$('#dayNote');
    const elAdvice=$('#adviceBox');
    const elCalendar=$('#calendar');

    // ===== Theme =====
    const themeBtn=$('#themeToggle');
    const THEME_KEY='studyplan_theme';
    function applyTheme(t){ document.documentElement.setAttribute('data-theme', t); localStorage.setItem(THEME_KEY,t); }
    themeBtn.addEventListener('click',()=>{
      const cur=document.documentElement.getAttribute('data-theme')||'dark';
      applyTheme(cur==='dark'?'light':'dark');
    });
    applyTheme(localStorage.getItem(THEME_KEY)||'dark');

    // ===== Storage helpers =====
    function storageKey(d){return KEY_PREFIX+d}
    function emptyDay(){ return { tasks:{}, custom:[], active:[], preset:'balanced' } }
    function clampDate(d){ if(d<DATE_START) return DATE_START; if(d>DATE_END) return DATE_END; return d; }
    function weekIndex(d){ return (new Date(d) <= new Date('2025-08-18'))?1:2 }

    function loadDay(d){
      const raw=localStorage.getItem(storageKey(d));
      let data= emptyDay();
      if(raw){ try{ data=Object.assign(emptyDay(), JSON.parse(raw)); }catch(e){} }
      // Backfill defaults
      if(!data.active || !data.active.length){ data.active=[...PRESETS.balanced.active]; }
      if(!data.preset) data.preset='balanced';
      // Ensure standard tasks exist
      [...ALL_TASKS, ...Object.values(VIRTUAL)].forEach(t=>{ if(!(t.id in data.tasks)) data.tasks[t.id]=false; });
      return data;
    }
    function saveDay(d,data){ localStorage.setItem(storageKey(d), JSON.stringify(data)); }

    // ===== Rendering =====
    function fmtDate(d){ const dt=new Date(d+'T00:00:00'); const w=['å‘¨æ—¥','å‘¨ä¸€','å‘¨äºŒ','å‘¨ä¸‰','å‘¨å››','å‘¨äº”','å‘¨å…­'][dt.getDay()]; const [y,m,dd]=d.split('-'); return `${y}-${m}-${dd}ï¼ˆ${w}ï¼‰`; }

    const DAY_HINTS={
      '2025-08-17':'ç¬¬1å‘¨å‘¨æ—¥Â·åŠä¼‘ï¼šå»ºè®®åˆ‡æ¢â€œè½»æ¢å¤æ—¥â€ + å‘¨æ¸…å•å¤ç›˜ 30â€“40 åˆ†é’Ÿã€‚',
      '2025-08-24':'ç¬¬2å‘¨å‘¨æ—¥Â·æ€»ç»“ï¼šå‘¨å°ç»“ + è‡ªæµ‹ 20 é¢˜å°å·ï¼ˆä¿¡å·10 + æ•°ç”µ10ï¼‰ã€‚'
    };

    function setCurrentDate(d){
      d=clampDate(d); window.__currentDate=d; elDatePicker.value=d; elDatePill.textContent=fmtDate(d);
      elWeekPill.textContent=`ç¬¬${weekIndex(d)}å‘¨`;
      elHintPill.textContent=(new Date(d).toDateString()===new Date().toDateString())?'ä»Šå¤©':'è®¡åˆ’å†…æ—¥æœŸ';
      renderTasks(d); renderCalendar(); updateStats();
    }

    function activeTasksForDay(data){
      const base = [...ALL_TASKS];
      const extras = data.active.filter(id=>!(base.find(t=>t.id===id))).map(id=>VIRTUAL[id]).filter(Boolean);
      const map = new Map([...base, ...extras].map(t=>[t.id,t]));
      // Keep the order according to ALL_TASKS first, then extras in the order of active[]
      const ordered=[...ALL_TASKS.map(t=>t.id).filter(id=>data.active.includes(id)), ...data.active.filter(id=>!ALL_TASKS.find(t=>t.id===id))];
      return ordered.map(id=>map.get(id)).filter(Boolean);
    }

    function renderTasks(d){
      const data=loadDay(d);
      elPresetPill.textContent = 'é¢„è®¾ï¼š' + (PRESETS[data.preset]?.name||'â€”');

      // Advice based on weights
      renderAdvice();

      elTasks.innerHTML=''; const frag=document.createDocumentFragment();
      const mk=(t,isCustom=false)=>{
        const item=document.createElement('label'); item.className='task'; item.dataset.id=t.id;
        const checked = !!data.tasks[t.id];
        item.innerHTML=`<input type="checkbox" ${checked?'checked':''} aria-label="${t.label}"><div class="label">${t.label}${isCustom?' <span class="muted">ï¼ˆè‡ªå®šä¹‰ï¼‰</span>':''}</div>${isCustom?'<button class="btn small ghost" data-del>åˆ é™¤</button>':''}`;
        item.querySelector('input').addEventListener('change',e=>{ data.tasks[t.id]=e.target.checked; saveDay(d,data); updateProgress(d); renderCalendar(); updateStats(); });
        if(isCustom){ item.querySelector('[data-del]')?.addEventListener('click',()=>{ if(!confirm('åˆ é™¤è¯¥è‡ªå®šä¹‰ä»»åŠ¡ï¼Ÿ')) return; data.custom=data.custom.filter(x=>x.id!==t.id); delete data.tasks[t.id]; saveDay(d,data); renderTasks(d); }); }
        frag.appendChild(item);
      };

      // Standard active tasks
      activeTasksForDay(data).forEach(t=> mk(t,false));
      // Custom tasks
      data.custom.forEach(t=> mk(t,true));

      elTasks.appendChild(frag);
      // Day notes
      if(DAY_HINTS[d]){ elDayNote.style.display='block'; elDayNote.textContent=DAY_HINTS[d]; } else { elDayNote.style.display='none'; elDayNote.textContent=''; }
      updateProgress(d);
    }

    function updateProgress(d){
      const data=loadDay(d);
      const ids=[...data.active, ...data.custom.map(t=>t.id)];
      const total=ids.length||1; const done=ids.filter(id=>data.tasks[id]).length; const pct=Math.round(done*100/total);
      elBar.style.width=pct+'%'; elPct.textContent=pct+'%';
    }

    // ===== Calendar & Stats =====
    const allDates = (function(){ const res=[]; const s=new Date(DATE_START), e=new Date(DATE_END); for(let d=new Date(s); d<=e; d.setDate(d.getDate()+1)) res.push(d.toISOString().slice(0,10)); return res; })();

    function renderCalendar(range){
      elCalendar.innerHTML='';
      const dates = range==='w2'? allDates.slice(7): allDates.slice(0,7);
      dates.forEach(d=>{
        const cell=document.createElement('div'); cell.className='daycell'; if(d===window.__currentDate) cell.classList.add('today');
        const data=loadDay(d); const ids=[...data.active, ...data.custom.map(t=>t.id)]; const total=ids.length||1; const done=ids.filter(id=>data.tasks[id]).length; const pct=Math.round(done*100/total);
        cell.innerHTML=`<div>${d.slice(5)}<div class="muted small">${['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][new Date(d).getDay()]}</div></div><div class="bar"><i style="width:${pct}%"></i></div>`;
        cell.title=`å®Œæˆåº¦ ${pct}%`;
        cell.addEventListener('click',()=> setCurrentDate(d));
        elCalendar.appendChild(cell);
      });
    }

    function updateStats(){
      // streak
      let streak=0; let curDate=new Date(window.__currentDate||DATE_START);
      while(true){
        const d=curDate.toISOString().slice(0,10); if(d<DATE_START) break;
        const data=loadDay(d); const ids=[...data.active, ...data.custom.map(t=>t.id)]; const total=ids.length||1; const done=ids.filter(id=>data.tasks[id]).length; const pct=done*100/total;
        if(pct>=60) { streak++; curDate.setDate(curDate.getDate()-1); } else break;
      }
      $('#streak').textContent=streak;
      // avg
      let sum=0; allDates.forEach(d=>{ const data=loadDay(d); const ids=[...data.active, ...data.custom.map(t=>t.id)]; const total=ids.length||1; const done=ids.filter(id=>data.tasks[id]).length; sum += Math.round(done*100/total); });
      const avg=Math.round(sum / allDates.length); $('#avg').textContent=avg+'%';
    }

    // ===== Preset application =====
    const presetSelect=$('#presetSelect');
    function applyPresetToDate(presetName,d){
      const data=loadDay(d); const preset=PRESETS[presetName]||PRESETS.balanced; data.preset=presetName; data.active=[...preset.active]; saveDay(d,data); renderTasks(d); renderCalendar(); updateStats(); }

    $('#btnApplyPreset').addEventListener('click',()=> applyPresetToDate(presetSelect.value, window.__currentDate));

    // Default Sundays to light preset
    function autoPreset(d){ const day=new Date(d+'T00:00:00').getDay(); if(day===0){ applyPresetToDate('light', d); } }

    // ===== Rollover =====
    $('#btnRollover').addEventListener('click',()=>{
      const cur=window.__currentDate; const next = new Date(cur); next.setDate(next.getDate()+1); const nd=next.toISOString().slice(0,10); if(nd>DATE_END){ alert('å·²åˆ°æœ€åä¸€å¤©ï¼Œæ— æ³•ç»“è½¬ã€‚'); return; }
      const data=loadDay(cur); const undone=[...data.active, ...data.custom.map(t=>t.id)].filter(id=>!data.tasks[id]).map(id=> id.startsWith('custom_')? data.custom.find(x=>x.id===id)?.label : (ALL_TASKS.find(t=>t.id===id)?.label || VIRTUAL[id]?.label)).filter(Boolean);
      if(!undone.length){ alert('ä»Šæ—¥æ— æœªå®Œæˆä»»åŠ¡ã€‚'); return; }
      const nextData=loadDay(nd);
      undone.forEach((label)=>{ const id='custom_'+Date.now()+Math.random().toString(16).slice(2,6); nextData.custom.push({id, label:'è¡¥åšï¼š'+label}); nextData.tasks[id]=false; });
      saveDay(nd,nextData); alert('å·²ç»“è½¬åˆ° '+nd+' çš„è‡ªå®šä¹‰ä»»åŠ¡ã€‚'); renderCalendar();
    });

    // ===== Priority advice from weights =====
    const wMath=$('#wMath'), wMajor=$('#wMajor'), wEng=$('#wEng'), wPol=$('#wPol');
    const wMathV=$('#wMathV'), wMajorV=$('#wMajorV'), wEngV=$('#wEngV'), wPolV=$('#wPolV');
    function renderAdvice(){
      const W={M:+wMath.value, J:+wMajor.value, E:+wEng.value, P:+wPol.value};
      wMathV.textContent=W.M; wMajorV.textContent=W.J; wEngV.textContent=W.E; wPolV.textContent=W.P;
      const order=[{k:'æ•°å­¦A/F',v:W.M},{k:'ä¸“ä¸šC/D',v:W.J},{k:'è‹±è¯­B/G',v:W.E},{k:'æ”¿æ²»E',v:W.P}].sort((a,b)=>b.v-a.v).map(x=>x.k).join(' â†’ ');
      elAdvice.style.display='block'; elAdvice.innerHTML=`<b>ä»Šæ—¥ä¼˜å…ˆé¡ºåºï¼š</b>${order} <span class="muted">ï¼ˆæƒé‡å¯åœ¨å³ä¾§è°ƒæ•´ï¼‰</span>`;
    }
    [wMath,wMajor,wEng,wPol].forEach(el=> el.addEventListener('input', ()=> renderAdvice()));

    // ===== Top controls =====
    $('#btnToday').addEventListener('click',()=> setCurrentDate(todayInRange()));
    $('#btnPrev').addEventListener('click',()=>{ const cur=new Date(window.__currentDate); cur.setDate(cur.getDate()-1); setCurrentDate(cur.toISOString().slice(0,10)); });
    $('#btnNext').addEventListener('click',()=>{ const cur=new Date(window.__currentDate); cur.setDate(cur.getDate()+1); setCurrentDate(cur.toISOString().slice(0,10)); });
    $('#datePicker').addEventListener('change',e=> setCurrentDate(e.target.value||DATE_START));
    $('#btnPrint').addEventListener('click',()=> window.print());
    $('#btnMarkAll').addEventListener('click',()=>{ const d=window.__currentDate; const data=loadDay(d); [...data.active, ...data.custom.map(t=>t.id)].forEach(id=> data.tasks[id]=true); saveDay(d,data); renderTasks(d); renderCalendar(); updateStats(); });
    $('#btnClear').addEventListener('click',()=>{ const d=window.__currentDate; const data=loadDay(d); [...data.active, ...data.custom.map(t=>t.id)].forEach(id=> data.tasks[id]=false); saveDay(d,data); renderTasks(d); renderCalendar(); updateStats(); });

    $('#btnWeek1').addEventListener('click',()=>{ renderCalendar('w1'); setCurrentDate('2025-08-12'); });
    $('#btnWeek2').addEventListener('click',()=>{ renderCalendar('w2'); setCurrentDate('2025-08-19'); });

    $('#btnExport').addEventListener('click',()=>{
      const all={}; allDates.forEach(d=>{ const raw=localStorage.getItem(storageKey(d)); if(raw) all[d]=JSON.parse(raw); });
      const blob=new Blob([JSON.stringify(all,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='studyplan_2025W33-34.json'; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1000);
    });
    $('#fileImport').addEventListener('change',e=>{ const f=e.target.files[0]; if(!f) return; const reader=new FileReader(); reader.onload=()=>{ try{ const data=JSON.parse(reader.result); Object.keys(data||{}).forEach(d=>{ if(d>=DATE_START&&d<=DATE_END){ localStorage.setItem(storageKey(d), JSON.stringify(data[d])); }}); alert('å¯¼å…¥å®Œæˆ'); renderTasks(window.__currentDate); renderCalendar(); updateStats(); }catch(err){ alert('å¯¼å…¥å¤±è´¥ï¼šæ ¼å¼é”™è¯¯'); } }; reader.readAsText(f); e.target.value=''; });

    $('#btnResetAll').addEventListener('click',()=>{ if(!confirm('æ¸…ç©º 8/12â€“8/25 æœŸé—´æ‰€æœ‰æ•°æ®ï¼Ÿ')) return; allDates.forEach(d=> localStorage.removeItem(storageKey(d))); renderTasks(window.__currentDate); renderCalendar(); updateStats(); });

    $('#btnAddTemp').addEventListener('click',()=>{ const text=prompt('è¾“å…¥ä¸´æ—¶ä»»åŠ¡å†…å®¹ï¼š'); if(!text) return; const d=window.__currentDate; const data=loadDay(d); const id='custom_'+Date.now(); data.custom.push({id,label:text.trim()}); data.tasks[id]=false; saveDay(d,data); renderTasks(d); renderCalendar(); updateStats(); });

    function todayInRange(){ const t=new Date().toISOString().slice(0,10); if(t<DATE_START||t>DATE_END) return DATE_START; return t; }

    // ===== Init =====
    const initial = todayInRange();
    // Auto set Sunday presets once if blank
    allDates.forEach(d=>{ const data=loadDay(d); if(!localStorage.getItem(storageKey(d))){ if(new Date(d+'T00:00:00').getDay()===0){ data.preset='light'; data.active=[...PRESETS.light.active]; saveDay(d,data); } }});
    setCurrentDate(initial);
    autoPreset(initial);
    renderAdvice();
  })();
  </script>
</body>
</html>
