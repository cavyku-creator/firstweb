<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>2025 初试全程计划｜倒计时・标签页・可自定义日程</title>
  <style>
    :root{
      --bg:#0b0f1a;--card:#12182a;--muted:#a7b0c0;--text:#e8eef9;--accent:#7aa2ff;--accent2:#7cf7d4;--danger:#ff6b6b;
      --ok:#58d68d;--warn:#ffd166;--border:#1c2540;--chip:#1b2340;--shadow:0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:linear-gradient(180deg,#0a0f1a 0%,#0b1020 100%);color:var(--text);font:15px/1.6 system-ui,-apple-system,Segoe UI,Roboto,"PingFang SC","Hiragino Sans GB","Microsoft YaHei",sans-serif}
    a{color:var(--accent)}
    header{position:sticky;top:0;z-index:6;background:rgba(11,15,26,.78);backdrop-filter:saturate(140%) blur(8px);border-bottom:1px solid var(--border)}
    .wrap{max-width:1200px;margin:0 auto;padding:18px}
    .title-row{display:flex;gap:16px;align-items:center;flex-wrap:wrap}
    .badge{padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:var(--chip);color:var(--muted);font-size:12px}
    .h1{font-weight:700;font-size:22px}
    .subtitle{color:var(--muted)}

    .toolbar{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
    .btn{padding:8px 12px;border:1px solid var(--border);border-radius:12px;background:linear-gradient(180deg,#152042,#0f1730);color:var(--text);cursor:pointer;box-shadow:var(--shadow)}
    .btn:active{transform:translateY(1px)}
    .select,.search,.date{padding:9px 12px;border:1px solid var(--border);border-radius:12px;background:#0e1428;color:var(--text)}
    .search{min-width:220px}

    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px;margin-top:18px}
    .col-12{grid-column:span 12}
    .col-6{grid-column:span 6}
    .col-4{grid-column:span 4}
    @media (max-width:960px){.col-6,.col-4{grid-column:span 12}}

    /* 卡片与可折叠 */
    details.card{border:1px solid var(--border);border-radius:18px;box-shadow:var(--shadow);background:linear-gradient(180deg,#111833,#0e1429)}
    details.card>summary{display:flex;align-items:center;justify-content:space-between;gap:16px;padding:14px 16px;cursor:pointer;list-style:none;border-bottom:1px solid var(--border)}
    details.card>summary::-webkit-details-marker{display:none}
    details.card .body{padding:16px}
    .muted{color:var(--muted)}

    .countdown{display:flex;gap:10px;align-items:baseline;flex-wrap:wrap}
    .count-chip{background:var(--chip);border:1px solid var(--border);padding:8px 10px;border-radius:14px;min-width:64px;text-align:center}
    .count-num{font-weight:700;font-size:18px}
    .progress{height:8px;background:#0c1430;border:1px solid var(--border);border-radius:999px;overflow:hidden}
    .progress>i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));width:0%}

    .subject-chip{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border:1px solid var(--border);border-radius:999px;background:#0f1836;margin:4px 6px 0 0;font-size:12px}
    .dot{width:8px;height:8px;border-radius:50%}
    .dot-math{background:#79a6ff}
    .dot-eng{background:#7cf7d4}
    .dot-pro{background:#ffd166}
    .dot-pol{background:#ff9db4}

    .week{border:1px solid var(--border);border-radius:18px;overflow:hidden;background:linear-gradient(180deg,#0f1633,#0d1329)}
    .week-h{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid var(--border)}
    .week-h strong{font-size:15px}
    .week-b{padding:8px 16px 16px}

    details.plan-day{border:1px dashed var(--border);border-radius:14px;padding:8px 12px;margin-top:10px;background:#0e152f}
    details.plan-day>summary{cursor:pointer;list-style:none}
    details.plan-day>summary::-webkit-details-marker{display:none}

    .tasks{display:grid;grid-template-columns:repeat(12,1fr);gap:10px;margin-top:8px}
    .task{grid-column:span 12;display:flex;gap:10px;align-items:flex-start;border:1px solid var(--border);border-radius:12px;padding:8px;background:#0c1330}
    .task input[type="checkbox"]{margin-top:4px}
    .task .meta{font-size:12px;color:var(--muted)}
    .task .actions{margin-left:auto;display:flex;gap:6px}

    .calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
    .cal-cell{border:1px solid var(--border);border-radius:12px;padding:6px;min-height:84px;background:#0e1430}
    .cal-cell .d{font-size:12px;color:var(--muted)}
    .cal-cell .ratio{font-size:12px;margin-top:6px}

    .foot{color:var(--muted);font-size:12px;margin-top:8px}
    .kbd{padding:2px 6px;border:1px solid var(--border);border-radius:6px;background:#0f1733}

    /* 标签页 */
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    .tab{padding:8px 12px;border:1px solid var(--border);border-radius:999px;background:#0f1733;color:var(--text);cursor:pointer}
    .tab.active{background:linear-gradient(180deg,#1a2450,#0f1733);box-shadow:var(--shadow)}
    .tabpanel{display:none}
    .tabpanel.active{display:block}

    /* 时间安排编辑 */
    .schedule-row{display:grid;grid-template-columns:100px 100px 1fr auto;gap:8px;align-items:center;margin-top:8px}
    .schedule-row input[type="time"], .schedule-row input[type="text"]{padding:8px;border:1px solid var(--border);border-radius:10px;background:#0e1428;color:var(--text)}
    .schedule-row .del{padding:6px 10px}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="title-row">
        <div class="h1">2025 初试全程复习计划（8.12 → 12.20）</div>
        <span class="badge">目标：电子科学与技术（学硕）｜数学一 / 英语一 / 政治 / 882（信号与系统+数字电路）</span>
      </div>
      <div class="subtitle" id="todayInfo"></div>

      <div class="grid">
        <div class="col-12">
          <details class="card" open>
            <summary>
              <div>
                <strong>距离 2025-12-20 初试倒计时</strong>
                <div class="foot">倒计时按本机本地时间计算；默认以当天 00:00 为目标时间。</div>
              </div>
              <span class="muted">点击可折叠</span>
            </summary>
            <div class="body">
              <div class="countdown" id="countdown"></div>
            </div>
          </details>
        </div>
      </div>

      <!-- 顶部工具与标签页导航 -->
      <div class="toolbar">
        <select class="select" id="subjectFilter">
          <option value="all">显示：全部科目</option>
          <option value="数学">仅数学</option>
          <option value="英语">仅英语</option>
          <option value="专业课">仅专业课</option>
          <option value="政治">仅政治</option>
        </select>
        <input class="search" id="search" placeholder="搜索任务关键词（如：真题 / 36讲 / 肖四）" />
        <input class="date" id="datePicker" type="date" />
        <button class="btn" id="expandWeek">展开/折叠 本周</button>
        <button class="btn" id="printBtn">打印/导出 PDF</button>
        <button class="btn" id="resetChecks">清除打卡记录</button>
      </div>
      <div class="tabs" id="tabs">
        <button class="tab active" data-tab="tab-daily">日计划</button>
        <button class="tab" data-tab="tab-week">周计划</button>
        <button class="tab" data-tab="tab-month">月计划</button>
        <button class="tab" data-tab="tab-schedule">每日时间安排</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <!-- 日计划面板 -->
    <section id="tab-daily" class="tabpanel active">
      <div class="grid">
        <section class="col-12">
          <details class="card" open>
            <summary>
              <strong>日计划 · <span id="dailyDateText"></span></strong>
              <span class="muted">点击折叠/展开</span>
            </summary>
            <div class="body">
              <div class="muted" id="todayRange"></div>
              <div class="progress" title="今日完成度"><i id="todayBar" style="width:0%"></i></div>
              <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
                <input class="search" id="customTaskInput" placeholder="添加自定义任务（可含时间，如 08:00 单词 30min）" />
                <button class="btn" id="addCustomTask">添加</button>
                <button class="btn" id="clearCustomTasks">清空当日自定义任务</button>
              </div>
              <div id="todayTasks" class="tasks" style="margin-top:8px"></div>
            </div>
          </details>
        </section>
      </div>
      <p class="foot">提示：自定义任务会以科目 <span class="kbd">“自定义”</span> 保存；所有勾选状态与自定义项均保存在浏览器 <span class="kbd">localStorage</span> 中。</p>
    </section>

    <!-- 周计划面板 -->
    <section id="tab-week" class="tabpanel">
      <div class="grid">
        <section class="col-12">
          <details class="card" open>
            <summary>
              <strong>逐周计划（卡片视图）</strong>
              <span class="muted">支持按科目与关键词筛选</span>
            </summary>
            <div class="body" id="weeks"></div>
          </details>
        </section>
      </div>
    </section>

    <!-- 月计划面板 -->
    <section id="tab-month" class="tabpanel">
      <div class="grid">
        <section class="col-12">
          <details class="card" open>
            <summary>
              <strong>月计划（8月 → 12月）</strong>
              <span class="muted">查看每日完成比例</span>
            </summary>
            <div class="body" id="months"></div>
          </details>
        </section>
      </div>
    </section>

    <!-- 每日时间安排（可自定义） -->
    <section id="tab-schedule" class="tabpanel">
      <div class="grid">
        <section class="col-12">
          <details class="card" open>
            <summary>
              <strong>每日时间安排（可自定义）</strong>
              <span class="muted">为任意日期添加时间块：开始-结束-内容</span>
            </summary>
            <div class="body">
              <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
                <label class="muted">选择日期：</label>
                <input class="date" id="schedDate" type="date" />
                <button class="btn" id="addSchedRow">新增时间块</button>
                <button class="btn" id="saveSched">保存</button>
                <button class="btn" id="clearSched">清空当日安排</button>
                <button class="btn" id="autoToday">自动生成：今天</button>
                <button class="btn" id="autoWeek">自动生成：本周</button>
                <button class="btn" id="autoAll">自动生成：全部日期</button>
              </div>
              <div id="schedList"></div>
              <p class="foot">建议固定 4–6 个学习时段（如：08:30–10:00 数学；10:15–11:45 专业课；14:00–15:30 专业课；19:00–21:00 英语/政治）。</p>
            </div>
          </details>
        </section>
      </div>
    </section>

    <!-- 自检（测试用，可折叠） -->
    <section class="col-12" style="max-width:1200px;margin:16px auto">
      <details class="card">
        <summary><strong>自检结果（开发调试）</strong><span class="muted">— 若无需要可忽略</span></summary>
        <div class="body"><ul id="testResults" class="muted" style="margin:0;padding-left:18px"></ul></div>
      </details>
    </section>

    <p class="foot">默认：每周学习 6 天，周日为机动复盘（可照样查看与勾选）。</p>
  </main>

  <script>
    // ====== 基本日期设置 ======
    const START = new Date('2025-08-12T00:00:00');
    const END   = new Date('2025-12-20T00:00:00');
    const REST_WEEKDAY = 0; // 周日机动（0=周日, 1=周一 ... 6=周六）

    // ====== 倒计时 ======
    const countdownEl = document.getElementById('countdown');
    function renderCountdown(){
      const now = new Date();
      const target = new Date('2025-12-20T00:00:00');
      const diff = Math.max(0, target - now);
      const d = Math.floor(diff/86400000);
      const h = Math.floor((diff%86400000)/3600000);
      const m = Math.floor((diff%3600000)/60000);
      const s = Math.floor((diff%60000)/1000);
      countdownEl.innerHTML = [ ['天',d],['小时',h],['分钟',m],['秒',s] ]
        .map(function(pair){ var lab=pair[0], val=pair[1]; return '<div class="count-chip"><div class="count-num">'+val+'</div><div>'+lab+'</div></div>'; }).join('');
    }
    renderCountdown();
    setInterval(renderCountdown,1000);

    // ====== 工具函数（避免旧浏览器对箭头函数/解构的解析问题） ======
    function fmt(d){ return d.getFullYear()+ '-' + ('0'+(d.getMonth()+1)).slice(-2) + '-' + ('0'+d.getDate()).slice(-2); }
    function ymd(d){ return fmt(d); }
    function parseYMD(s){ var a=s.split('-'); return new Date(+a[0], +a[1]-1, +a[2]); }
    function rangeDays(a,b){ var out=[], d=new Date(a); while(d<=b){ out.push(new Date(d)); d.setDate(d.getDate()+1); } return out; }
    function wkLabel(d1,d2,i){ return '第 '+i+' 周（'+(d1.getMonth()+1)+'/'+d1.getDate()+' - '+(d2.getMonth()+1)+'/'+d2.getDate()+'）'; }
    function within(d,a,b){ return d>=a && d<=b; }

    // ====== 阶段定义 ======
    var P1A = new Date('2025-08-12'); // 基础
    var P1B = new Date('2025-09-30');

    var P2A = new Date('2025-10-01'); // 强化
    var P2B = new Date('2025-11-15');

    var P3A = new Date('2025-11-16'); // 冲刺
    var P3B = new Date('2025-12-20');

    function stageOf(d){ return within(d,P1A,P1B)?'基础' : within(d,P2A,P2B)?'强化' : '冲刺'; }

    // ====== 正则安全转义（封装函数，避免字符类书写错误引发语法问题） ======
    function escapeRegex(str){ return String(str).replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }

    // ====== 任务池 ======
    function genSeries(prefix,from,to){ var years=[]; for(var y=from;y<=to;y++){ years.push(prefix+'（'+y+'年）'); } return years; }

    // 数学
    var MATH_P1 = [].concat(
      Array.from({length:30},function(_,i){return '张宇《基础30讲》·第'+(i+1)+'讲';}),
      Array.from({length:30},function(_,i){return '1000题·每日练（第'+(i+1)+'次，≈30题）';}),
      Array.from({length:30},function(_,i){return '李永乐660题·每日练（第'+(i+1)+'次，≈20题）';})
    );
    var MATH_P2 = [].concat(
      Array.from({length:36},function(_,i){return '张宇《强化36讲》·第'+(i+1)+'讲';}),
      genSeries('真题大全解·数学一',2009,2020)
    );
    var MATH_P3 = [].concat(
      Array.from({length:8},function(_,i){return '张宇模拟·8套卷·第'+(i+1)+'套（120分钟）';}),
      Array.from({length:4},function(_,i){return '张宇冲刺·4套卷·第'+(i+1)+'套（120分钟）';})
    );

    // 英语
    var ENG_P1 = [].concat(
      Array.from({length:45},function(_,i){return '田静《句句真研》·精研（第'+(i+1)+'天，2-3句）';}),
      genSeries('黄皮书·英一真题精读',2006,2015)
    );
    var ENG_P2 = [].concat(
      Array.from({length:24},function(_,i){return '唐迟《阅读的逻辑》·单元 '+(i+1);}),
      genSeries('黄皮书·英一真题强化',2016,2020)
    );
    var ENG_P3 = [].concat(
      genSeries('黄皮书·英一真题冲刺',2021,2025),
      Array.from({length:20},function(_,i){return '石雷鹏《30个功能句》·模板演练（第'+(i+1)+'次）';})
    );

    // 专业课
    var PRO_P1 = [].concat(
      Array.from({length:10},function(_,i){return '信号与系统·教材·第'+(i+1)+'章';}),
      Array.from({length:10},function(_,i){return '《考研一点通》·第'+(i+1)+'章题';}),
      Array.from({length:8},function(_,i){return '数字电路与系统设计·教材·第'+(i+1)+'章';})
    );
    var PRO_P2 = [].concat(
      Array.from({length:12},function(_,i){return '信号与系统·专题强化·第'+(i+1)+'讲';}),
      Array.from({length:12},function(_,i){return '数字电路·专题强化·第'+(i+1)+'讲';}),
      Array.from({length:16},function(_,i){return '信号真题精练·960题·单元 '+(i+1);})
    );
    var PRO_P3 = [].concat(
      Array.from({length:10},function(_,i){return '专业课·真题二刷/错题回顾·第'+(i+1)+'次';}),
      Array.from({length:6},function(_,i){return '易错知识点·背诵巩固·第'+(i+1)+'次';})
    );

    // 政治
    var POL_P1 = [].concat(
      Array.from({length:12},function(_,i){return '《核心考案》·第'+(i+1)+'章';}),
      Array.from({length:20},function(_,i){return '肖秀荣1000题·第'+(i+1)+'天（单选+多选）';})
    );
    var POL_P2 = [].concat(
      Array.from({length:12},function(_,i){return '肖1000题·第二遍·第'+(i+1)+'天';}),
      Array.from({length:8},function(_,i){return '肖八·第'+(i+1)+'套（客观+主观）';})
    );
    var POL_P3 = [].concat(
      Array.from({length:4},function(_,i){return '肖四·第'+(i+1)+'套（主观题背诵）';}),
      Array.from({length:20},function(_,i){return '背诵手册·精背（第'+(i+1)+'天）';})
    );

    // 每日分配权重
    var DAILY_QUOTA = {
      '基础':   { '数学':2, '英语':2, '专业课':2, '政治':1 },
      '强化':   { '数学':2, '英语':2, '专业课':2, '政治':1 },
      '冲刺':   { '数学':2, '英语':2, '专业课':2, '政治':1 }
    };

    var POOLS = {
      '基础':   { '数学':MATH_P1.slice(), '英语':ENG_P1.slice(), '专业课':PRO_P1.slice(), '政治':POL_P1.slice() },
      '强化':   { '数学':MATH_P2.slice(), '英语':ENG_P2.slice(), '专业课':PRO_P2.slice(), '政治':POL_P2.slice() },
      '冲刺':   { '数学':MATH_P3.slice(), '英语':ENG_P3.slice(), '专业课':PRO_P3.slice(), '政治':POL_P3.slice() }
    };

    // ====== 生成按天任务 ======
    var allDays = rangeDays(START, END);
    var tasksByDate = {};

    function nextFromPool(stage, subject){
      var pool = POOLS[stage][subject];
      return pool.length ? pool.shift() : null;
    }

    for(var di=0; di<allDays.length; di++){
      var d = allDays[di];
      var key = ymd(d);
      var stage = stageOf(d);
      var isRest = d.getDay()===REST_WEEKDAY;
      var q = DAILY_QUOTA[stage];
      var list = [];

      var subjects = ['数学','专业课','英语','政治'];
      for(var sj=0; sj<subjects.length; sj++){
        var subj = subjects[sj];
        var need = isRest ? 1 : (q[subj]||1);
        for(var k=0;k<need;k++){
          var t = nextFromPool(stage,subj);
          if(t){ list.push({id:key+'|'+subj+'|'+t, subject:subj, text:t}); }
        }
      }
      if(isRest){
        list.unshift({id:key+'|复盘', subject:'复盘', text:'本周错题与笔记复盘 + 轻量拉伸与休息'});
      }
      tasksByDate[key]=list;
    }

    // ====== 存取：勾选、自定义任务、日程 ======
    var STORE_CHECKS = 'kaoyan-plan-2025-checks';
    var STORE_CUSTOM = 'kaoyan-plan-2025-custom';
    var STORE_SCHED  = 'kaoyan-plan-2025-schedule';

    function loadJSON(k,def){ try{ var v=JSON.parse(localStorage.getItem(k)||'null'); return v==null?def:v; }catch(e){ return def; } }
    function saveJSON(k,v){ localStorage.setItem(k,JSON.stringify(v)); }

    var checks = loadJSON(STORE_CHECKS,{});
    var customTasks = loadJSON(STORE_CUSTOM,{});
    var schedules   = loadJSON(STORE_SCHED,{});

    function taskChecked(id){ return !!checks[id]; }
    function setChecked(id,val){ checks[id]=!!val; saveJSON(STORE_CHECKS,checks); refreshTodayProgress(); refreshCalendars(); }

    // ====== 顶部信息 ======
    var todayInfo = document.getElementById('todayInfo');
    var datePicker = document.getElementById('datePicker');

    function setDatePickerBounds(){
      datePicker.min = fmt(START); datePicker.max = fmt(END); datePicker.value = fmt(new Date());
      document.getElementById('schedDate').min = datePicker.min; document.getElementById('schedDate').max = datePicker.max; document.getElementById('schedDate').value = datePicker.value;
      document.getElementById('dailyDateText').textContent = datePicker.value;
    }

    // ====== 渲染：日计划 ======
    var todayTasksEl = document.getElementById('todayTasks');
    var todayBar = document.getElementById('todayBar');

    function getDayTasks(dateStr){
      var list = (tasksByDate[dateStr]||[]).slice();
      var customs = (customTasks[dateStr]||[]);
      for(var i=0;i<customs.length;i++){ list.push({id:customs[i].id, subject:'自定义', text:customs[i].text}); }
      return list;
    }

    function renderDot(subj){
      var cls = subj==='数学'?'dot-math':subj==='英语'?'dot-eng':subj==='专业课'?'dot-pro':subj==='政治'?'dot-pol':'dot-math';
      return '<span class="dot '+cls+'"></span>';
    }

    function escapeHTML(s){ return String(s||'').replace(/[&<>\"]/g, function(c){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]; }); }

    function renderTasks(list){
      var subj = subjectFilter.value;
      var kw = String(document.getElementById('search').value||'').trim();
      var safe = escapeRegex(kw);
      var rx = kw ? new RegExp(safe, 'i') : null;
      var out = [];
      for(var i=0;i<list.length;i++){
        var t=list[i];
        if((subj==='all'||t.subject===subj) && (!rx || rx.test(t.text))){
          out.push(
            '<div class="task" data-id="'+t.id+'" data-subj="'+t.subject+'">'+
              '<input type="checkbox" '+(taskChecked(t.id)?'checked':'')+' />'+
              '<div>'+
                '<div><span class="subject-chip">'+renderDot(t.subject)+t.subject+'</span> '+escapeHTML(t.text)+'</div>'+
                '<div class="meta">'+t.id.split('|')[0]+'</div>'+
              '</div>'+
              (t.subject==='自定义'?'<div class="actions">\
                <button class="btn small edit">编辑<\/button>\
                <button class="btn small delete">删除<\/button>\
              </div>':'')+
            '</div>'
          );
        }
      }
      return out.join('');
    }

    function refreshDaily(){
      var sel = datePicker.value;
      var d = parseYMD(sel);
      document.getElementById('dailyDateText').textContent = sel;
      document.getElementById('todayRange').textContent = sel+'（'+['周日','周一','周二','周三','周四','周五','周六'][d.getDay()]+'） · 阶段：'+stageOf(d);
      var list = getDayTasks(sel);
      todayTasksEl.innerHTML = renderTasks(list);
      refreshTodayProgress();
    }

    function refreshTodayProgress(){
      var sel = datePicker.value;
      var list = getDayTasks(sel);
      var total = list.length||1;
      var done = list.filter(function(t){return taskChecked(t.id);}).length;
      var pct = Math.round(done/total*100);
      todayBar.style.width = pct+'%';
    }

    // ====== 自定义任务操作 ======
    function addCustomTaskFor(dateStr, text){
      if(!text) return;
      var id = dateStr+'|自定义|'+text+'|'+Date.now();
      var arr = customTasks[dateStr]||[];
      arr.push({id:id, subject:'自定义', text:text});
      customTasks[dateStr]=arr; saveJSON(STORE_CUSTOM,customTasks); refreshDaily();
    }
    function deleteCustomTask(dateStr,id){
      var arr = customTasks[dateStr]||[];
      var out=[]; for(var i=0;i<arr.length;i++){ if(arr[i].id!==id) out.push(arr[i]); }
      customTasks[dateStr]=out; saveJSON(STORE_CUSTOM,customTasks); refreshDaily();
    }
    function editCustomTask(dateStr,id){
      var arr = customTasks[dateStr]||[];
      for(var i=0;i<arr.length;i++){
        if(arr[i].id===id){
          var nv = prompt('编辑自定义任务内容：', arr[i].text);
          if(nv!=null){ arr[i].text = String(nv).trim(); saveJSON(STORE_CUSTOM,customTasks); refreshDaily(); }
          break;
        }
      }
    }

    // ====== 事件：任务勾选/编辑 ======
    document.addEventListener('change', function(e){
      var t = e.target;
      if(t && t.matches && t.matches('.task input[type="checkbox"]')){
        var id = t.closest('.task').dataset.id;
        setChecked(id, t.checked);
      }
    });
    document.addEventListener('click', function(e){
      var el = e.target;
      if(el && el.matches && el.matches('#addCustomTask')){
        addCustomTaskFor(datePicker.value, document.getElementById('customTaskInput').value.trim());
        document.getElementById('customTaskInput').value='';
      }
      if(el && el.matches && el.matches('#clearCustomTasks')){
        if(confirm('确认清空当日所有自定义任务？')){ customTasks[datePicker.value]=[]; saveJSON(STORE_CUSTOM,customTasks); refreshDaily(); }
      }
      if(el && el.matches && el.matches('.task .delete')){
        var id = el.closest('.task').dataset.id; deleteCustomTask(datePicker.value, id);
      }
      if(el && el.matches && el.matches('.task .edit')){
        var id2 = el.closest('.task').dataset.id; editCustomTask(datePicker.value, id2);
      }
    });

    // ====== 周卡片 ======
    function buildWeeks(){
      var weeksEl = document.getElementById('weeks');
      weeksEl.innerHTML='';
      var weeks=[];
      var cursor=new Date(START);
      while(cursor<=END){
        var wStart = new Date(cursor);
        var wEnd = new Date(cursor); wEnd.setDate(wStart.getDate()+6);
        var idx = weeks.length+1;
        weeks.push({start:wStart,end:wEnd,label:wkLabel(wStart,wEnd,idx)});
        cursor.setDate(cursor.getDate()+7);
      }
      for(var wi=0; wi<weeks.length; wi++){
        var w = weeks[wi];
        var days = rangeDays(w.start,w.end).filter(function(d){return within(d,START,END);});
        var list=[]; for(var di2=0; di2<days.length; di2++){ list = list.concat(getDayTasks(ymd(days[di2]))); }
        var done = list.filter(function(t){return taskChecked(t.id);}).length, total=list.length||1;
        var pct = Math.round(done/total*100);
        var stg = stageOf(days[0]);
        var blocks=[];
        for(var dj=0; dj<days.length; dj++){
          var dd = days[dj];
          var k = ymd(dd);
          var isRest = dd.getDay()===REST_WEEKDAY;
          var title = k+'（'+['周日','周一','周二','周三','周四','周五','周六'][dd.getDay()]+(isRest?'·机动':'')+'）';
          var tasks = getDayTasks(k);
          blocks.push('<details class="plan-day" '+(isCurrentWeek(days)?'open':'')+'>'+
            '<summary><strong>'+title+'</strong> · 任务'+tasks.length+'项</summary>'+
            '<div class="tasks">'+renderTasks(tasks)+'</div>'+
          '</details>');
        }
        var card = document.createElement('details');
        card.className='card';
        if(isCurrentWeek(days)) card.setAttribute('open','');
        card.innerHTML = '\
          <summary>\
            <strong>'+w.label+'｜阶段：'+stg+'</strong>\
            <div style="flex:1;margin:0 12px" class="progress"><i style="width:'+pct+'%"></i></div>\
            <span class="muted">本周完成：'+done+'/'+total+'（'+pct+'%）｜点击折叠</span>\
          </summary>\
          <div class="body">'+blocks.join('')+'</div>';
        weeksEl.appendChild(card);
      }
    }

    function isCurrentWeek(days){
      var now = new Date();
      return now>=days[0] && now<=days[days.length-1];
    }

    // ====== 月视图 ======
    function buildMonths(){
      var monthsEl = document.getElementById('months');
      monthsEl.innerHTML='';
      var months=[8,9,10,11,12];
      for(var mi=0; mi<months.length; mi++){
        var m = months[mi];
        var y = 2025;
        var first = new Date(y,m-1,1);
        var last = new Date(y,m,0);
        var cells=[];
        for(var i=0;i<first.getDay();i++){cells.push('<div></div>');}
        for(var d1=1; d1<=last.getDate(); d1++){
          var cur = new Date(y,m-1,d1);
          if(cur<START || cur>END){
            cells.push('<div class="cal-cell"><div class="d">'+d1+'</div><div class="ratio muted">—</div></div>');
          }else{
            var key = ymd(cur);
            var list = getDayTasks(key);
            var done = list.filter(function(t){return taskChecked(t.id);}).length;
            var total=list.length||1;
            var pct = Math.round(done/total*100);
            cells.push('<div class="cal-cell"><div class="d">'+d1+'</div><div class="ratio">完成 '+done+'/'+total+'（'+pct+'%）</div></div>');
          }
        }
        var box = document.createElement('div');
        box.className='card body';
        box.innerHTML = '<h3 style="margin:0 0 8px 0">'+y+'年'+m+'月</h3><div class="calendar">'+cells.join('')+'</div>';
        monthsEl.appendChild(box);
      }
    }

    // ====== 时间安排（可自定义） ======
    var schedDate = document.getElementById('schedDate');
    var schedList = document.getElementById('schedList');

    function safeText(s){ return String(s||'').replace(/\"/g,'”'); }

    function renderSchedule(dateStr){
      var rows = schedules[dateStr]||[];
      var arr=[];
      for(var i=0;i<rows.length;i++){
        var r=rows[i];
        arr.push('\
        <div class="schedule-row" data-idx="'+i+'">\
          <input type="time" value="'+(r.start||'')+'">\
          <input type="time" value="'+(r.end||'')+'">\
          <input type="text" placeholder="内容/备注" value="'+safeText((r.title||'')+(r.note?('｜'+r.note):''))+'">\
          <button class="btn del">删除</button>\
        </div>');
      }
      schedList.innerHTML = arr.join('');
    }

    function addScheduleRow(dateStr){
      var arr = schedules[dateStr]||[]; arr.push({start:'08:30',end:'10:00',title:'学习'});
      schedules[dateStr]=arr; saveJSON(STORE_SCHED,schedules); renderSchedule(dateStr);
    }
    function saveSchedule(dateStr){
      var rows=[]; var domRows=schedList.querySelectorAll('.schedule-row');
      for(var i=0;i<domRows.length;i++){
        var inputs = domRows[i].querySelectorAll('input');
        var s=inputs[0].value, e=inputs[1].value, t=inputs[2].value;
        var parts = String(t||'').split('｜');
        var title = parts.shift()||''; var note = parts.join('｜')||'';
        rows.push({start:s,end:e,title:title,note:note});
      }
      schedules[dateStr]=rows; saveJSON(STORE_SCHED,schedules);
      alert('已保存该日时间安排');
    }
    function clearSchedule(dateStr){ if(confirm('确认清空该日时间安排？')){ schedules[dateStr]=[]; saveJSON(STORE_SCHED,schedules); renderSchedule(dateStr);} }

    document.getElementById('addSchedRow').addEventListener('click',function(){addScheduleRow(schedDate.value);});
    document.getElementById('saveSched').addEventListener('click',function(){saveSchedule(schedDate.value);});
    document.getElementById('clearSched').addEventListener('click',function(){clearSchedule(schedDate.value);});
    schedList.addEventListener('click',function(e){
      var btn=e.target; if(!btn.matches('.del')) return; var i=[].slice.call(schedList.children).indexOf(btn.closest('.schedule-row'));
      var arr = schedules[schedDate.value]||[]; arr.splice(i,1); schedules[schedDate.value]=arr; saveJSON(STORE_SCHED,schedules); renderSchedule(schedDate.value);
    });

    // ====== 自动按周/日生成完整日程（含固定锻炼 15:30–16:30） ======
    function slotTemplateFor(d){
      return [
        {start:'07:40', end:'08:10', title:'英语·早读（单词/语法）', type:'learn', pref:['英语']},
        {start:'08:30', end:'10:00', title:'学习时段A', type:'learn', pref:['数学']},
        {start:'10:15', end:'11:45', title:'学习时段B', type:'learn', pref:['数学','专业课']},
        {start:'13:30', end:'15:00', title:'学习时段C', type:'learn', pref:['专业课','数学']},
        {start:'15:30', end:'16:30', title:'锻炼（固定）', type:'fixed'},
        {start:'16:45', end:'18:00', title:'学习时段D', type:'learn', pref:['专业课','数学']},
        {start:'19:00', end:'20:00', title:'学习时段E', type:'learn', pref:['英语']},
        {start:'20:10', end:'21:00', title:'学习时段F/复盘', type:'learn', pref:['政治','复盘','英语','数学','专业课']}
      ];
    }

    function weekRangeOf(date){
      var dayMs = 86400000; var idx = Math.floor((parseYMD(date) - START)/dayMs/7); var ws = new Date(START); ws.setDate(ws.getDate()+idx*7);
      var we = new Date(ws); we.setDate(ws.getDate()+6); return {ws:ws, we:we};
    }

    function autoScheduleForDate(dateStr, overwrite){ if(overwrite===void 0) overwrite=true;
      if(!overwrite && (schedules[dateStr]||[]).length) return;
      var tasks = getDayTasks(dateStr).slice();
      var used = {};
      function take(pred){ for(var i=0;i<tasks.length;i++){ var t=tasks[i]; if(!used[t.id] && pred(t)){ used[t.id]=1; return t; } } return null; }
      function takeBySubj(subs){ for(var i=0;i<subs.length;i++){ var t = take(function(x){return x.subject===subs[i];}); if(t) return t; } return null; }
      function takeAny(){ return take(function(){return true;}); }

      var d = parseYMD(dateStr);
      var slots = slotTemplateFor(d);
      var rows = [];
      for(var i=0;i<slots.length;i++){
        var slot = slots[i];
        if(slot.type==='fixed'){
          rows.push({start:slot.start,end:slot.end,title:slot.title});
        }else{
          var picked = slot.pref ? takeBySubj(slot.pref) : null;
          if(!picked) picked = takeAny();
          rows.push({start:slot.start,end:slot.end,title: picked ? (picked.subject+'｜'+picked.text) : slot.title});
        }
      }
      var rest = tasks.filter(function(t){return !used[t.id];});
      if(rest.length){
        var note = rest.slice(0,4).map(function(t){return t.subject+'·'+t.text;}).join('；') + (rest.length>4?'…':'');
        rows.push({start:'21:10', end:'22:00', title:'机动补充', note: note});
      }
      schedules[dateStr]=rows; saveJSON(STORE_SCHED,schedules);
    }

    function autoScheduleForRange(a,b){
      var days = rangeDays(a,b);
      for(var i=0;i<days.length;i++){ autoScheduleForDate(fmt(days[i]), true); }
    }

    document.getElementById('autoToday').addEventListener('click',function(){
      if(confirm('将根据当日任务自动生成时间安排，并覆盖当日既有安排。是否继续？')){ autoScheduleForDate(datePicker.value, true); renderSchedule(datePicker.value); alert('已按当日任务自动生成完整日程（含 15:30–16:30 锻炼）。'); }
    });
    document.getElementById('autoWeek').addEventListener('click',function(){
      var rg = weekRangeOf(datePicker.value); var ws=rg.ws, we=rg.we;
      if(confirm('将自动生成本周（'+fmt(ws)+' 至 '+fmt(we)+'）的每日安排，并覆盖该周既有安排。是否继续？')){
        autoScheduleForRange(ws,we); if(within(parseYMD(datePicker.value),ws,we)) renderSchedule(datePicker.value); alert('已生成本周每日完整日程。');
      }
    });
    document.getElementById('autoAll').addEventListener('click',function(){
      if(confirm('将为 8月12日至12月20日的所有日期自动生成安排，并覆盖既有安排。是否继续？')){ autoScheduleForRange(START,END); renderSchedule(datePicker.value); alert('已生成全部日期的完整日程。'); }
    });

    // ====== 搜索与筛选更新 ======
    var subjectFilter = document.getElementById('subjectFilter');
    var searchInput = document.getElementById('search');

    subjectFilter.addEventListener('change', function(){ buildWeeks(); refreshDaily(); });
    searchInput.addEventListener('input', function(){ buildWeeks(); refreshDaily(); });

    document.getElementById('expandWeek').addEventListener('click',function(){
      var items = document.querySelectorAll('details.plan-day');
      for(var i=0;i<items.length;i++){ items[i].open = !items[i].open; }
    });
    document.getElementById('printBtn').addEventListener('click',function(){ window.print(); });
    document.getElementById('resetChecks').addEventListener('click',function(){
      if(confirm('确认清除所有勾选记录？此操作不可撤销。')){ localStorage.removeItem(STORE_CHECKS); checks={}; buildWeeks(); refreshDaily(); buildMonths(); }
    });

    // ====== 标签页逻辑 ======
    var tabs = document.getElementById('tabs');
    function activateTab(id){
      var ts = document.querySelectorAll('.tab'); for(var i=0;i<ts.length;i++){ ts[i].classList.toggle('active', ts[i].dataset.tab===id); }
      var ps = document.querySelectorAll('.tabpanel'); for(var j=0;j<ps.length;j++){ ps[j].classList.toggle('active', ps[j].id===id); }
      localStorage.setItem('kaoyan-plan-2025-active-tab', id);
    }
    tabs.addEventListener('click',function(e){
      var b = e.target.closest ? e.target.closest('.tab') : null; if(!b) return; activateTab(b.dataset.tab);
    });

    // ====== 顶部日期选择联动 ======
    datePicker.addEventListener('change',function(){ refreshDaily(); document.getElementById('schedDate').value=datePicker.value; renderSchedule(datePicker.value); });
    schedDate.addEventListener('change',function(){ renderSchedule(schedDate.value); });

    // ====== 月视图刷新 ======
    function refreshCalendars(){ buildMonths(); }

    // ====== 自检（测试） ======
    function runSelfTests(){
      var results = [];
      function test(name, fn){
        try{ var ok = fn(); results.push({name:name, ok:ok, msg: ok? 'PASS' : 'FAIL'}); }
        catch(err){ results.push({name:name, ok:false, msg:'ERR: '+err.message}); }
      }
      // 1) 关键词转义不抛错（覆盖常见元字符）
      test('Regex 关键字转义（元字符）', function(){
        var kw = '.*+?^${}()|[]/中文-肖四';
        var safe = escapeRegex(kw);
        var r = new RegExp(safe,'i');
        return r.test(kw);
      });
      // 2) 任务渲染不抛错
      test('renderTasks 不抛错', function(){
        var prev = searchInput.value; searchInput.value = '.*[]()^$+/';
        var html = renderTasks([{id:'2025-08-12|自定义|测试',subject:'自定义',text:'测试.*[]/()^$+'}]);
        searchInput.value = prev; return typeof html === 'string';
      });
      // 3) escapeHTML 正确性
      test('escapeHTML', function(){
        return escapeHTML('<div class="x">&"</div>') === '&lt;div class=&quot;x&quot;&gt;&amp;&quot;&lt;/div&gt;';
      });
      // 4) 自动排程包含固定锻炼 15:30–16:30
      test('AutoSchedule 含固定锻炼时段', function(){
        var ds = fmt(START);
        var backup = (schedules[ds]||[]).slice();
        try{ autoScheduleForDate(ds,true); return (schedules[ds]||[]).some(function(r){return r.start==='15:30' && r.end==='16:30';}); }
        finally{ schedules[ds]=backup; }
      });
      // 5) 自动排程无重叠时间段（基础校验）
      test('AutoSchedule 时间段不重叠', function(){
        var ds = fmt(START); autoScheduleForDate(ds,true);
        var rows = schedules[ds]||[];
        for(var i=0;i<rows.length;i++){
          for(var j=i+1;j<rows.length;j++){
            if(!(rows[i].end<=rows[j].start || rows[j].end<=rows[i].start)) return false;
          }
        }
        return true;
      });
      // 6) 周构建函数不抛错
      test('buildWeeks 不抛错', function(){ buildWeeks(); return document.getElementById('weeks').children.length>0; });

      var ul = document.getElementById('testResults');
      ul.innerHTML = results.map(function(r){return '<li>'+(r.ok? '✅' : '❌')+' '+r.name+' — <span class="muted">'+r.msg+'</span></li>';}).join('');
    }

    // ====== 初始化 ======
    function init(){
      var now = new Date();
      document.getElementById('todayInfo').textContent = '今天：'+fmt(now)+'（'+['周日','周一','周二','周三','周四','周五','周六'][now.getDay()]+'） · 学习 6 天 + 1 天机动复盘 · 资料全覆盖分三阶段推进';
      setDatePickerBounds();
      refreshDaily();
      buildWeeks();
      buildMonths();
      renderSchedule(datePicker.value);
      var lastTab = localStorage.getItem('kaoyan-plan-2025-active-tab')||'tab-daily';
      activateTab(lastTab);
      runSelfTests();
    }

    init();
  </script>
</body>
</html>
